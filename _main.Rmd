---
title: Diagnostics for GLOPNET 
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
#rmdformats::material
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
      toc: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      cache=FALSE,
                      message=FALSE)
```

```{r}

library(tidyverse)
library(rstan)
library(scales)
library(memisc)
library(bayesplot)

settings <- yaml::yaml.load_file("settings.yml")
```

```{r}
obs_files <- list.files("rda") %>%
  str_subset("obs.rda")

obs_files <- list.files("rda") %>%
  str_subset("obs")
```

# Models

```{r}
tmp <- obs_files %>%
  str_split_fixed("_obs", 2)

models <-str_split_fixed(tmp[,1], "_more", 2)[,1]

#models_obs <- models[!str_detect(models, "_CV")]

#for (i in 1:length(models)) {
#  print(models[i])
#  writeLines(readLines(str_c("model/", models[i], ".stan")))
#}
```

## `r models[2]`
```{r}
writeLines(readLines(str_c("model/", models[2], ".stan")))
```


# Diagnostics


## obs

```{r, eval=TRUE}

color_scheme_set("mix-brightblue-gray")

check_trace <- function(x) {
  load(str_c("rda/", obs_files[x]))
  if (!str_detect(obs_files[x], "CV")) {
  np_cp <- nuts_params(res)
     mcmc_trace(res, pars = c("Z[1,1]", "Z[1,2]", "Z[1,3]",
                                      "Z[2,1]", "Z[2,2]", "Z[2,3]",
                                      "Z[3,1]", "Z[3,2]", "Z[3,3]",
                                      "lp__"), np = np_cp) +
    ggtitle(obs_files[x])
  }
}

p <- 2  %>%
  map(check_trace)

p %>%
  walk(print)

```

<!--chapter:end:check_GL_obs.rmd-->

---
title: Diagnostics for observed data 
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
#rmdformats::material
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
      toc: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      cache=FALSE,
                      message=FALSE)
```

```{r}

library(tidyverse)
library(rstan)
library(scales)
library(memisc)
library(bayesplot)

settings <- yaml::yaml.load_file("settings.yml")
```

```{r}
obs_files <- list.files("rda") %>%
  str_subset("obs.rda")

obs_files <- list.files("rda") %>%
  str_subset("obs")
```

# Models

```{r}
tmp <- obs_files %>%
  str_split_fixed("_obs", 2)

models <-str_split_fixed(tmp[,1], "_more", 2)[,1]

#models_obs <- models[!str_detect(models, "_CV")]

#for (i in 1:length(models)) {
#  print(models[i])
#  writeLines(readLines(str_c("model/", models[i], ".stan")))
#}
```

## `r models[1]`
```{r}
writeLines(readLines(str_c("model/", models[1], ".stan")))
```

## `r models[2]`
```{r}
writeLines(readLines(str_c("model/", models[2], ".stan")))
```

## `r models[3]`
```{r}
writeLines(readLines(str_c("model/", models[3], ".stan")))
```

## `r models[4]`
```{r}
writeLines(readLines(str_c("model/", models[4], ".stan")))
```

## `r models[5]`
```{r}
writeLines(readLines(str_c("model/", models[5], ".stan")))
```

## `r models[6]`
```{r}
writeLines(readLines(str_c("model/", models[6], ".stan")))
```

## `r models[7]`
```{r}
writeLines(readLines(str_c("model/", models[7], ".stan")))
```

## `r models[8]`
```{r}
writeLines(readLines(str_c("model/", models[8], ".stan")))
```

## `r models[9]`
```{r}
writeLines(readLines(str_c("model/", models[9], ".stan")))
```

## `r models[10]`
```{r}
writeLines(readLines(str_c("model/", models[10], ".stan")))
```

# Diagnostics


## obs

```{r, eval=TRUE}

color_scheme_set("mix-brightblue-gray")

check_trace <- function(x) {
  load(str_c("rda/", obs_files[x]))
  if (!str_detect(obs_files[x], "CV")) {
  np_cp <- nuts_params(res)
  mcmc_trace(res, pars = c("Z[2,3]", "lp__"), np = np_cp) +
    ggtitle(obs_files[x])
  } else {
    for (i in 1:10) {
      np_cp <- nuts_params(ss[[i]])
      p <- mcmc_trace(ss[[i]], pars = c("Z[2,3]", "lp__"), np = np_cp) +
      ggtitle(str_c(obs_files[x],"-fold ", i))
      print(p)
    }
  }
}

p <- 1:length(obs_files)  %>%
  map(check_trace)

p %>%
  walk(print)

```

<!--chapter:end:check_obs.rmd-->

---
title: Diagnostics for randomized data (Panama)
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
#rmdformats::material
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
      toc: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      cache=FALSE,
                      message=FALSE)
```

```{r}

library(tidyverse)
library(rstan)
library(scales)
library(memisc)
library(bayesplot)

settings <- yaml::yaml.load_file("settings.yml")
```

```{r}

load("./rda/PA_LMAms_L0_more_rand.rda")

```

# Diagnostics

Check posterior distributions for 10 randomized datasets.

```{r}

#color_scheme_set("darkgray")
color_scheme_set("mix-brightblue-gray")

check_trace <- function(x) {
  fit <- rand_res$model[[x]]
  np_cp <- nuts_params(fit)
  mcmc_trace(fit, pars = c("Z[2,3]", "lp__"), np = np_cp) +
    ggtitle(str_c("Rand", x, sep = " "))
}


p <- 1:9  %>%
  map(check_trace)

p %>%
  walk(print)

```

Divergent transitions indicate biased estimates for posterior
distributions. All the models showed divergent transitions.


```{r}
rand_n <- 1
summary_PA_LDL <- rand_res$summary[[rand_n]]

summary_PA_LDL %>%
  round(3) %>%
  DT::datatable(.)

PA <- dat %>%
  as_tibble %>%
  mutate(LMA = rand_res$data[[rand_n]]$LMA) %>%
  mutate(Aarea = rand_res$data[[rand_n]]$A) %>%
  mutate(Rarea = rand_res$data[[rand_n]]$R) %>%
  mutate(site2 = ifelse(site == "PNM", "DRY", "WET")) %>%
  mutate(sp_site_strata = paste(sp, site2, strata, sep = "_")) %>%
  mutate(site_strata = paste(site2, strata, sep = "_"))

P_vec <- paste("p[", 1:nrow(PA), "]", sep = "")
mu2_vec <- paste("mu2[", 1:nrow(PA), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(PA), ",2]", sep = "")
temp_LMAp <- summary_PA_LDL[P_vec, "mean"] * PA$LMA
temp_LMAs <- PA$LMA - temp_LMAp
#temp_LL <- exp(summary_PA_LDL[mu2_vec, "mean"])

Mu_mcmc <- extract(rand_res$model[[rand_n]], pars = "Mu")[[1]] 

preLL <- Mu_mcmc[,,2] %>% apply(., 2, median) %>% exp

PA <- PA %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs) %>%
  mutate(preLL = preLL) 

```
# Trait correlations

## A~area~, R~area~, LL

*Note that MCMC didn't work well at all.* Open symbols indicate sun leaves and closed symbols indicate shade leaves. 

```{r, echo = F, message = F}

PA2 <- PA %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs")) %>%
  gather(trait, val2, c("Aarea", "LL", "Rarea")) %>%
  gather(trait2, val3, c("Narea","Parea","cell_area","cell_vol"))


ggplot(PA2, aes(x = val, y = val2, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA and LD") +
  ylab("Traits") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))




```

## Observed LL vs predicted LL

Note: Light and site effects were not included in this model.

```{r, echo = F, message = F}

my_breaks <- function(...){
  c(0.002, 0.005, 0.02, 0.05, 0.1, 0.2,  0.5, 1, 2, 5, 10, 20, 50, 100, 200, 500)
}


ggplot(PA, aes(x = LL, y = preLL, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  xlab("obsLL") +
  ylab("preLL") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  geom_abline(aes(slope = 1, intercept = 0), 
              lty = 2, 
              lwd = 0.25, 
              col = "gray20") +
  scale_x_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(PA$LL), max(PA$LL))) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0), 
                limits = c(min(PA$LL), max(PA$LL))) +
  coord_fixed()
cor.test(log(PA$LL), log(PA$preLL))



```

## Cell~area~, Cell~vol~ (= cellulose density), N~area~, P~area~

```{r, echo = F, message = F}
ggplot(PA2, aes(x = val, y = val3, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  facet_grid(trait2 ~ LMA, scale = "free") +
  xlab("LMA and LD") +
  ylab("Traits") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))
```

## LMAp vs LMAs

```{r, echo = F, message = F}
ggplot(PA, aes(x = LMAp, y = LMAs, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  xlab("LMAm") +
  ylab("LMAs") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))
```

## Trait means

The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}

ggplot(PA2 %>% filter(LMA != "LDs"), aes(x = site_strata, y = val,
                                         fill = site_strata,
                                         col = site_strata)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))


```


## Trait means

The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}


ggplot(PA2 %>% filter(LMA != "LDs"), aes(x = site_strata, y = val,
                                         fill = site_strata,
                                         col = site_strata)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))

```

# Pairwise cor for all randomized data

```{r}
get_PA <- function(x) {
  summary_PA_LDL <- rand_res$summary[[x]]

  PA <- dat %>%
    as_tibble %>%
    mutate(LMA = rand_res$data[[x]]$LMA) %>%
    mutate(Aarea = rand_res$data[[x]]$A) %>%
    mutate(Rarea = rand_res$data[[x]]$R) %>%
    mutate(site2 = ifelse(site == "PNM", "DRY", "WET")) %>%
    mutate(sp_site_strata = paste(sp, site2, strata, sep = "_")) %>%
    mutate(site_strata = paste(site2, strata, sep = "_"))

  P_vec <- paste("p[", 1:nrow(PA), "]", sep = "")
#mu2_vec <- paste("mu2[", 1:nrow(PA), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(PA), ",2]", sep = "")
  temp_LMAp <- summary_PA_LDL[P_vec, "mean"] * PA$LMA
  temp_LMAs <- PA$LMA - temp_LMAp
#temp_LL <- exp(summary_PA_LDL[mu2_vec, "mean"])

  Mu_mcmc <- extract(rand_res$model[[x]], pars = "Mu")[[1]] 

  preLL <- Mu_mcmc[,,2] %>% apply(., 2, median) %>% exp

  PA <- PA %>%
    mutate(LMAp = temp_LMAp) %>%
    mutate(LMAs = temp_LMAs) %>%
    mutate(preLL = preLL) 

}

PA_list <- 1:9 %>%
  map(get_PA)

rand_nd <- tibble(rand = 1:9) %>%
  mutate(data = PA_list)

rand_nd %>%
  mutate(LL_LMAs = map_dbl(data, ~ cor(.$LL, .$LMAs))) %>%
  mutate(LL_LMAp = map_dbl(data, ~ cor(.$LL, .$LMAp))) %>%
  mutate(LL_preLL = map_dbl(data, ~ cor(.$LL, .$preLL))) %>%
  mutate(Aarea_LMAs = map_dbl(data, ~ cor(.$Aarea, .$LMAs))) %>%
  mutate(Aarea_LMAp = map_dbl(data, ~ cor(.$Aarea, .$LMAp))) %>%
  mutate(Rarea_LMAs = map_dbl(data, ~ cor(.$Rarea, .$LMAs))) %>%
  mutate(Rarea_LMAp = map_dbl(data, ~ cor(.$Rarea, .$LMAp))) 

```

<!--chapter:end:check_rand_PA.rmd-->

---
title: Diagnostics for randomized data (GLOPNET)
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
#rmdformats::material
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
      toc: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      cache=FALSE,
                      message=FALSE)
```

```{r}

library(tidyverse)
library(rstan)
library(scales)
library(memisc)
library(bayesplot)

settings <- yaml::yaml.load_file("settings.yml")
```

```{r}

load("rda/GL_LMAms_more_rand.rda")
#PA_LMAms_L0_more_rand.rda

```

# Diagnostics

Check posterior distributions for 10 randomized datasets.

```{r}

#color_scheme_set("darkgray")
color_scheme_set("mix-brightblue-gray")

check_trace <- function(x) {
  fit <- rand_res$model[[x]]
  np_cp <- nuts_params(fit)
  mcmc_trace(fit, pars = c("Z[2,3]", "lp__"), np = np_cp) +
    ggtitle(str_c("Rand", x, sep = " "))
}


p <- 1:9  %>%
  map(check_trace)

p %>%
  walk(print)

```

Divergent transitions indicate biased estimates for posterior distributions.
Although Rand 3 and 8 did not show divergent transitions but these model did not
show any patterns (See the figures below). The other models showed divergent transitions.


```{r}
# good
summary_GL_LDL <- rand_res$summary[[3]]

summary_GL_LDL %>% 
  round(3) %>%
  DT::datatable(.)

temp <- rand_dat$data[[1]] 

GL0 <- dat %>%
  as_tibble %>%
  dplyr::select(sp, DE, GF)

GL <- tibble(LMA = temp$LMA,
                 Aarea = temp$A,
                 LL = temp$LL,
                 Rarea = temp$R)

GL <- bind_cols(GL0, GL)


#P_vec <- paste("p[", 1:nrow(GL), "]", sep = "")
LMAp_vec <- paste("log_LMAp[", 1:nrow(GL), "]", sep = "")
LMAs_vec <- paste("log_LMAs[", 1:nrow(GL), "]", sep = "")
mu2_vec <- paste("Mu[", 1:nrow(GL), ",2]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(GL), ",2]", sep = "")
temp_LMAp <- summary_GL_LDL[LMAp_vec, "mean"] 
temp_LMAs <- summary_GL_LDL[LMAs_vec, "mean"] 
temp_LL <- exp(summary_GL_LDL[mu2_vec, "mean"])

GL <- GL %>%
  mutate(LMAp = temp_LMAp %>% exp) %>%
  mutate(LMAs = temp_LMAs %>% exp) %>%
  mutate(preLL = temp_LL) 

tmp <- GL %>%
  dplyr::select(sp, DE) 

d <- read_csv("./data/nature02403-s2.csv", skip = 10)

dd <- data.frame(Narea = 10^d$`log Narea`,
        Parea = 10^d$`log Parea`,
        sp = d$Species) %>%
        group_by(sp) %>%
        summarize(Narea = mean(Narea, na.omit = T),
            Parea = mean(Parea, na.omit = T))

GL <- left_join(GL, dd, by = "sp") %>%
  mutate(gr = factor(DE,
    labels = c("Deciduous",
               "Evergreen",
               "Unclassified"
                      ))) %>%
  arrange(desc(gr))

```
# Trait correlations - rand 3

## A~area~, R~area~, LL

Open symbols indicate sun leaves and closed symbols indicate shade leaves. The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}

GL2 <- GL %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs")) %>%
  gather(trait, val2, c("Aarea", "LL", "Rarea")) 

GL3 <- GL %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs")) %>%
  #gather(trait, val2, c("Aarea", "LL", "Rarea")) %>%
  gather(trait2, val3, c("Narea","Parea")) 

fills <- c("Deciduous" = settings$fills$D,
          "Evergreen" = settings$fills$E,
          "Unclassified" = settings$fills$U)

cols <- c("Deciduous" = settings$colors$D,
          "Evergreen" = settings$colors$E,
          "Unclassified" = settings$colors$U)

ggplot(GL2, aes(x = val, y = val2, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


```


##  N~area~, P~area~

```{r, echo = F, message = F}


ggplot(GL3, aes(x = val, y = val3, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait2 ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

cor.test(log(GL$LMA), log(GL$Narea))

cor.test(log(GL$LMAp), log(GL$Narea))


```

## LMAp vs LMAs

```{r, echo = F, message = F}


ggplot(GL, aes(x = LMAp, y = LMAs, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  xlab("LMAm") +
  ylab("LMAs") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


cor.test(log(GL$LMAp) , log(GL$LMAs))

```

## Trait means

The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}


ggplot(GL2, aes(x = gr, y = val,
                fill = gr,
                col = gr)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) 


```

## Pairwise cor for all randomized data

```{r}
get_GL <- function(x) {
  summary_GL_LDL <- rand_res$summary[[x]]

  summary_GL_LDL %>% 
    round(3) %>%
    DT::datatable(.)

  temp <- rand_dat$data[[1]] 

  GL0 <- dat %>%
    as_tibble %>%
    dplyr::select(sp, DE, GF)

  GL <- tibble(LMA = temp$LMA,
                   Aarea = temp$A,
                   LL = temp$LL,
                   Rarea = temp$R)

  GL <- bind_cols(GL0, GL)


#P_vec <- paste("p[", 1:nrow(GL), "]", sep = "")
  LMAp_vec <- paste("log_LMAp[", 1:nrow(GL), "]", sep = "")
  LMAs_vec <- paste("log_LMAs[", 1:nrow(GL), "]", sep = "")
  mu2_vec <- paste("Mu[", 1:nrow(GL), ",2]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(GL), ",2]", sep = "")
  temp_LMAp <- summary_GL_LDL[LMAp_vec, "mean"] 
  temp_LMAs <- summary_GL_LDL[LMAs_vec, "mean"] 
  temp_LL <- exp(summary_GL_LDL[mu2_vec, "mean"])

  GL <- GL %>%
    mutate(LMAp = temp_LMAp %>% exp) %>%
    mutate(LMAs = temp_LMAs %>% exp) %>%
    mutate(preLL = temp_LL) 

  tmp <- GL %>%
    dplyr::select(sp, DE) 

  d <- read_csv("./data/nature02403-s2.csv", skip = 10)

  dd <- data.frame(Narea = 10^d$`log Narea`,
          Parea = 10^d$`log Parea`,
          sp = d$Species) %>%
          group_by(sp) %>%
          summarize(Narea = mean(Narea, na.omit = T),
              Parea = mean(Parea, na.omit = T))

  GL <- left_join(GL, dd, by = "sp") %>%
    mutate(gr = factor(DE,
      labels = c("Deciduous",
                 "Evergreen",
                 "Unclassified"
                        ))) %>%
    arrange(desc(gr))

}

GL_list <- 1:9 %>%
  map(get_GL)

rand_nd <- tibble(rand = 1:9) %>%
  mutate(data = GL_list)

rand_nd %>%
  mutate(LL_LMAs = map_dbl(data, ~ cor(.$LL, .$LMAs))) %>%
  mutate(LL_LMAp = map_dbl(data, ~ cor(.$LL, .$LMAp))) %>%
  mutate(Aarea_LMAs = map_dbl(data, ~ cor(.$Aarea, .$LMAs))) %>%
  mutate(Aarea_LMAp = map_dbl(data, ~ cor(.$Aarea, .$LMAp))) %>%
  mutate(Rarea_LMAs = map_dbl(data, ~ cor(.$Rarea, .$LMAs))) %>%
  mutate(Rarea_LMAp = map_dbl(data, ~ cor(.$Rarea, .$LMAp))) 

```

# Trait correlations - rand 8

```{r}
# good
summary_GL_LDL <- rand_res$summary[[8]]

summary_GL_LDL %>% 
  round(3) %>%
  DT::datatable(.)

temp <- rand_dat$data[[1]] 

GL0 <- dat %>%
  as_tibble %>%
  dplyr::select(sp, DE, GF)

GL <- tibble(LMA = temp$LMA,
                 Aarea = temp$A,
                 LL = temp$LL,
                 Rarea = temp$R)

GL <- bind_cols(GL0, GL)


#P_vec <- paste("p[", 1:nrow(GL), "]", sep = "")
LMAp_vec <- paste("log_LMAp[", 1:nrow(GL), "]", sep = "")
LMAs_vec <- paste("log_LMAs[", 1:nrow(GL), "]", sep = "")
mu2_vec <- paste("Mu[", 1:nrow(GL), ",2]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(GL), ",2]", sep = "")
temp_LMAp <- summary_GL_LDL[LMAp_vec, "mean"] 
temp_LMAs <- summary_GL_LDL[LMAs_vec, "mean"] 
temp_LL <- exp(summary_GL_LDL[mu2_vec, "mean"])

GL <- GL %>%
  mutate(LMAp = temp_LMAp %>% exp) %>%
  mutate(LMAs = temp_LMAs %>% exp) %>%
  mutate(preLL = temp_LL) 

tmp <- GL %>%
  dplyr::select(sp, DE) 

d <- read_csv("./data/nature02403-s2.csv", skip = 10)

dd <- data.frame(Narea = 10^d$`log Narea`,
        Parea = 10^d$`log Parea`,
        sp = d$Species) %>%
        group_by(sp) %>%
        summarize(Narea = mean(Narea, na.omit = T),
            Parea = mean(Parea, na.omit = T))

GL <- left_join(GL, dd, by = "sp") %>%
  mutate(gr = factor(DE,
    labels = c("Deciduous",
               "Evergreen",
               "Unclassified"
                      ))) %>%
  arrange(desc(gr))

```

## A~area~, R~area~, LL

Open symbols indicate sun leaves and closed symbols indicate shade leaves. The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}

GL2 <- GL %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs")) %>%
  gather(trait, val2, c("Aarea", "LL", "Rarea")) 

GL3 <- GL %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs")) %>%
  #gather(trait, val2, c("Aarea", "LL", "Rarea")) %>%
  gather(trait2, val3, c("Narea","Parea")) 

fills <- c("Deciduous" = settings$fills$D,
          "Evergreen" = settings$fills$E,
          "Unclassified" = settings$fills$U)

cols <- c("Deciduous" = settings$colors$D,
          "Evergreen" = settings$colors$E,
          "Unclassified" = settings$colors$U)

ggplot(GL2, aes(x = val, y = val2, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


```


##  N~area~, P~area~

```{r, echo = F, message = F}


ggplot(GL3, aes(x = val, y = val3, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait2 ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

cor.test(log(GL$LMA), log(GL$Narea))

cor.test(log(GL$LMAp), log(GL$Narea))


```

## LMAp vs LMAs

```{r, echo = F, message = F}


ggplot(GL, aes(x = LMAp, y = LMAs, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  xlab("LMAm") +
  ylab("LMAs") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


cor.test(log(GL$LMAp) , log(GL$LMAs))

```

## Trait means

The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}


ggplot(GL2, aes(x = gr, y = val,
                fill = gr,
                col = gr)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) 


```

## Pairwise cor for all randomized data

```{r}
get_GL <- function(x) {
  summary_GL_LDL <- rand_res$summary[[x]]

  summary_GL_LDL %>% 
    round(3) %>%
    DT::datatable(.)

  temp <- rand_dat$data[[1]] 

  GL0 <- dat %>%
    as_tibble %>%
    dplyr::select(sp, DE, GF)

  GL <- tibble(LMA = temp$LMA,
                   Aarea = temp$A,
                   LL = temp$LL,
                   Rarea = temp$R)

  GL <- bind_cols(GL0, GL)


#P_vec <- paste("p[", 1:nrow(GL), "]", sep = "")
  LMAp_vec <- paste("log_LMAp[", 1:nrow(GL), "]", sep = "")
  LMAs_vec <- paste("log_LMAs[", 1:nrow(GL), "]", sep = "")
  mu2_vec <- paste("Mu[", 1:nrow(GL), ",2]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(GL), ",2]", sep = "")
  temp_LMAp <- summary_GL_LDL[LMAp_vec, "mean"] 
  temp_LMAs <- summary_GL_LDL[LMAs_vec, "mean"] 
  temp_LL <- exp(summary_GL_LDL[mu2_vec, "mean"])

  GL <- GL %>%
    mutate(LMAp = temp_LMAp %>% exp) %>%
    mutate(LMAs = temp_LMAs %>% exp) %>%
    mutate(preLL = temp_LL) 

  tmp <- GL %>%
    dplyr::select(sp, DE) 

  d <- read_csv("./data/nature02403-s2.csv", skip = 10)

  dd <- data.frame(Narea = 10^d$`log Narea`,
          Parea = 10^d$`log Parea`,
          sp = d$Species) %>%
          group_by(sp) %>%
          summarize(Narea = mean(Narea, na.omit = T),
              Parea = mean(Parea, na.omit = T))

  GL <- left_join(GL, dd, by = "sp") %>%
    mutate(gr = factor(DE,
      labels = c("Deciduous",
                 "Evergreen",
                 "Unclassified"
                        ))) %>%
    arrange(desc(gr))

}

GL_list <- 1:9 %>%
  map(get_GL)

rand_nd <- tibble(rand = 1:9) %>%
  mutate(data = GL_list)

rand_nd %>%
  mutate(LL_LMAs = map_dbl(data, ~ cor(.$LL, .$LMAs))) %>%
  mutate(LL_LMAp = map_dbl(data, ~ cor(.$LL, .$LMAp))) %>%
  mutate(Aarea_LMAs = map_dbl(data, ~ cor(.$Aarea, .$LMAs))) %>%
  mutate(Aarea_LMAp = map_dbl(data, ~ cor(.$Aarea, .$LMAp))) %>%
  mutate(Rarea_LMAs = map_dbl(data, ~ cor(.$Rarea, .$LMAs))) %>%
  mutate(Rarea_LMAp = map_dbl(data, ~ cor(.$Rarea, .$LMAp))) 

```

<!--chapter:end:check_rand.rmd-->


```{r}
library(tidyverse)
library(rstan)
library(stringr)
library(loo)
rstan_options(auto_write = TRUE)

load("./data/GL_LMAms_obs_cv.rda")
ss2 <- ss
ee2 <- extract_log_lik_K(ss, holdout_10)
kk2 <- kfold(ee2)
ll2 <- loo(ee2)

load("./data/GL_GL_LMA_CV_obs_cv.rda")
load("./data/GL_GL_LMA_CV_obs_cv.rda")

ee <- extract_log_lik_K(ss, holdout_10)
kk <- kfold(ee)
ll <- loo(ee)
kk2$elpd_kfold
kk$elpd_kfold

data_frame(LMA = c("LMA", "LMAms"),
           elpd = c(ee, ee2)) %>%
  mutate(site = "GLOPNET")


```

<!--chapter:end:k_fold_cv.rmd-->

---
title: "test for latent variables"
date: '`r format(Sys.time(), "%B %d, %Y")`'
---


```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      message=FALSE)
```

```{r caching, include=FALSE}
library(methods)
library(knitr)
library(kableExtra)
```

```{r} 
library(tidyverse)
library(rstan)
library(stringr)
library(loo)
rstan_options(auto_write = TRUE)
# options(mc.cores = parallel::detectCores())
options(mc.cores = 3)

set.seed(5)

n_chains <- 3

dat <- read_csv("./data/GL_data.csv") %>%
    mutate(DE = ifelse(is.na(DE), "U", DE)) %>%
    as.data.frame

  list_dat <- list(n_sample = nrow(dat),
                   obs = cbind(log(dat[ , "Aarea"] + dat[ , "Rarea"]),
                               log(dat[ , "LL"]),
                               log(dat[ , "Rarea"])),
                   LMA = dat[ , "LMA"],
                   A = dat[ , "Aarea"],
                   R = dat[ , "Rarea"],
                   q_lim = 1,
                   leaf = 1,
                   dry = 1,
                   DE = as.numeric(as.factor(dat$DE)))

  list_dat$obs2 <- list_dat$obs


model <- "
  data{
    int<lower=0> n_sample;
    vector<lower=0>[n_sample] LMA;
    row_vector[3] obs[n_sample];
  }
  parameters{
    real log_alpha;
    real alpha2;
    real log_beta;
    real beta2;
    real rp;
    real rs;
    real log_r;
    vector<lower=0>[3] L_sigma;
    cholesky_factor_corr[3] L_Omega;
    vector<lower=0, upper=1>[n_sample] p;
  }
  transformed parameters{
    row_vector[3] mu[n_sample];
    for (i in 1:n_sample){
      mu[i,1] = log_alpha + alpha2 * (log(LMA[i]) + log(p[i]))
            - 0.5 * square(L_sigma[1]);
      mu[i,2] = log_beta + beta2 * (log(LMA[i]) + log(1-p[i]))
             - 0.5 * square(L_sigma[2]);
      mu[i,3] = log_r +  rp * (log(LMA[i]) + log(p[i]))
              + rs * (log(LMA[i]) + log(1-p[i]))
               - 0.5 * square(L_sigma[3]);
    }
  }
  model{
    obs ~ multi_normal_cholesky(mu, diag_pre_multiply(L_sigma, L_Omega));
    p ~ uniform(0, 1);
    log_alpha ~ normal(0, 1.0e+4);
    log_beta ~ normal(0, 1.0e+4);
    alpha2 ~ normal(0, 1.0e+4);
    beta2 ~ normal(0, 1.0e+4);
    rp ~ normal(0, 1.0e+4);
    rs ~ normal(0, 1.0e+4);
    log_r ~ normal(0, 1.0e+4);
    L_Omega ~ lkj_corr_cholesky(1); //uniform of L_Omega * L_Omega'
    L_sigma ~ uniform(0, 1.0e+4);
  }
  generated quantities {
    vector[n_sample] log_lik;
    real<lower=-1, upper=1> rho12;
    real<lower=-1, upper=1> rho23;
    real<lower=-1, upper=1> rho13;
    cov_matrix[3] Sigma;
    Sigma = diag_pre_multiply(L_sigma, L_Omega)
       * diag_post_multiply(L_Omega', L_sigma);
    rho12 = Sigma[1, 2] * inv(L_sigma[1] * L_sigma[2]);
    rho23 = Sigma[2, 3] * inv(L_sigma[2] * L_sigma[3]);
    rho13 = Sigma[1, 3] * inv(L_sigma[1] * L_sigma[3]);
    for (i in 1:n_sample)
     log_lik[i] = multi_normal_cholesky_lpdf(obs[i] | mu[i], diag_pre_multiply(L_sigma, L_Omega));
   }
"

model2 <- "
  data{
    int<lower=0> n_sample;
    vector<lower=0>[n_sample] LMA;
    row_vector[3] obs[n_sample];
  }
  parameters{
    real log_alpha;
    real alpha2;
    real log_beta;
    real beta2;
    real rp;
    real rs;
    real log_r;
    vector<lower=0>[3] L_sigma;
    cholesky_factor_corr[3] L_Omega;
    vector[n_sample] z;
  }
  transformed parameters{
    row_vector[3] mu[n_sample];
    vector<lower=0, upper=1>[n_sample] p;
    for (i in 1:n_sample){
      p[i] = inv_logit(z[i]);
      mu[i,1] = log_alpha + alpha2 * (log(LMA[i]) + log(p[i]))
            - 0.5 * square(L_sigma[1]);
      mu[i,2] = log_beta + beta2 * (log(LMA[i]) + log(1-p[i]))
             - 0.5 * square(L_sigma[2]);
      mu[i,3] = log_r +  rp * (log(LMA[i]) + log(p[i]))
              + rs * (log(LMA[i]) + log(1-p[i]))
               - 0.5 * square(L_sigma[3]);
    }
  }
  model{
    obs ~ multi_normal_cholesky(mu, diag_pre_multiply(L_sigma, L_Omega));
    z ~ normal(0, 5);
    log_alpha ~ normal(0, 1.0e+4);
    log_beta ~ normal(0, 1.0e+4);
    alpha2 ~ normal(0, 1.0e+4);
    beta2 ~ normal(0, 1.0e+4);
    rp ~ normal(0, 1.0e+4);
    rs ~ normal(0, 1.0e+4);
    log_r ~ normal(0, 1.0e+4);
    L_Omega ~ lkj_corr_cholesky(1); //uniform of L_Omega * L_Omega'
    L_sigma ~ uniform(0, 1.0e+4);
  }
  generated quantities {
    vector[n_sample] log_lik;
    real<lower=-1, upper=1> rho12;
    real<lower=-1, upper=1> rho23;
    real<lower=-1, upper=1> rho13;
    cov_matrix[3] Sigma;
    Sigma = diag_pre_multiply(L_sigma, L_Omega)
       * diag_post_multiply(L_Omega', L_sigma);
    rho12 = Sigma[1, 2] * inv(L_sigma[1] * L_sigma[2]);
    rho23 = Sigma[2, 3] * inv(L_sigma[2] * L_sigma[3]);
    rho13 = Sigma[1, 3] * inv(L_sigma[1] * L_sigma[3]);
    for (i in 1:n_sample)
     log_lik[i] = multi_normal_cholesky_lpdf(obs[i] | mu[i], diag_pre_multiply(L_sigma, L_Omega));
   }
"

n_iter <- 20000
n_warm <- 10000
n_thin <- 20

system.time(fit <- stan(model_code = model,
            data = list_dat,
            iter = 1,
            warmup = 0,
            thin = 1,
            chains = 1))


system.time(fit2 <- stan(model_code = model2,
            data = list_dat,
            iter = 1,
            warmup = 0,
            thin = 1,
            chains = 1))

system.time(res <- stan(fit = fit,
           data = list_dat,
           iter = n_iter,
           warmup = n_warm,
           thin = n_thin,
           chains = n_chains,
           control = list(adapt_delta = 0.95, max_treedepth = 10)))


system.time(res2 <- stan(fit = fit2,
           data = list_dat,
           iter = n_iter,
           warmup = n_warm,
           thin = n_thin,
           chains = n_chains,
           control = list(adapt_delta = 0.95, max_treedepth = 10)))


GL_summary <- data.frame(summary(res)$summary)
GL_summary2 <- data.frame(summary(res2)$summary)

write.csv(GL_summary,"model.csv")
write.csv(GL_summary2,"model2.csv")

GL_summary %>% head(20) %>% print
GL_summary2 %>% head(20) %>% print

save.image("model.rda")
save.image("model2.rda")

```


```{r}
load("model.rda")
load("model2.rda")

P_vec <- paste("p[", 1:nrow(dat), "]" ,sep = "")

GL <- dat %>%
  mutate(DE = ifelse(GL$DE == "", "U", as.character(DE))) %>%
  mutate(p1 = GL_summary[P_vec, "X50."]) %>%
  mutate(p2 = GL_summary2[P_vec, "X50."]) %>%
  mutate(LMAp1 =  p1 * LMA) %>%
  mutate(LMAs1 = LMA - LMAp1) %>% 
  mutate(LMAp2 = p2 * LMA) %>%
  mutate(LMAs2 = LMA - LMAp2) %>%
  mutate(AR = Aarea + Rarea)


# p1 vs p2
ggplot(GL, aes(x = p1, y = p2)) +
  geom_point() +
  geom_abline(slope=1, intercept=0, lty = 2)


ggplot(GL, aes(x = LMAp1, y = AR)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() 


ggplot(GL, aes(x = LMAp2, y = AR)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() 
```

<!--chapter:end:latent.rmd-->


```{r}
library(tidyverse)
set.seed(123)
N <- 100
p <- rbeta(N, 1, 1)
X <- rnorm(N)
beta <- c(-0.8, 1.5)
X2 <- p * X
sig <- 0.3
Y <- rnorm(N, beta[1] + beta[2] * X2, sig) 

dat <- tibble(Y, X, X2, 
              hold = sample(c(rep(1, 10), numeric(N - 10)), N))
```

```{r}
plot(Y ~ X)
plot(Y ~ X2)
```

```{r}

loglik <- dnorm(Y, mean = beta[1] + beta[2] * p * X, sd = sig, log = TRUE) %>% sum

p2 <- rbeta(N, 1, 1)
loglik2 <- dnorm(Y, mean = beta[1] + beta[2] * p2 * X, sd = sig, log = TRUE) %>% sum

loglik
loglik2

```

<!--chapter:end:loglik_note.rmd-->

---
title: GLOPNET results
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

- alpha_0 LMAm^alpha_p 
- beta_0 LMAs^beta_s


```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      message=FALSE)
```


```{r, echo = F, message = F}
library(loo)
library(rstan)
library(dplyr)
library(scales)
library(memisc)

theme_set(theme_light())

settings <- yaml::yaml.load_file("settings.yml")
```


```{r, echo = F, message = F}

#load("./data/PA_sitePL_LD_L_MVN_obs.rda")
load("./data/GL_m0_obs.rda")


#summary_PA_LDL <- data.frame(summary(res)$summary)

summary_GL_LDL <- data.frame(summary(res)$summary)

GL <- dat %>%
  as_data_frame 


P_vec <- paste("p[", 1:nrow(GL), "]", sep = "")
mu2_vec <- paste("mu2[", 1:nrow(GL), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(GL), ",2]", sep = "")
temp_LMAp <- summary_GL_LDL[P_vec, "mean"] * GL$LMA
temp_LMAs <- GL$LMA - temp_LMAp
temp_LL <- exp(summary_GL_LDL[mu2_vec, "mean"])

#ap <- rstan::extract(res, "beta[2]")[[1]]
#temp_LMAp <- median(ap) * temp_LMAm

GL <- GL %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs) %>%
  mutate(preLL = temp_LL) 

d <- read_csv("./data/nature02403-s2.csv", skip = 10)

dd <- data.frame(Narea = 10^d$`log Narea`,
        Parea = 10^d$`log Parea`,
        sp = d$Species) %>%
        group_by(sp) %>%
        summarize(Narea = mean(Narea, na.omit = T),
            Parea = mean(Parea, na.omit = T))

GL <- left_join(GL, dd, by = "sp") %>%
  mutate(gr = factor(DE,
    labels = c("Deciduous",
               "Evergreen",
               "Unclassified"
                      ))) %>%
  arrange(desc(gr))

GL2 <- GL %>%
  arrange(LMA) %>%
  gather(LMA2, val, c("LMAp", "LMAs")) %>%
  mutate(ordering = 1:nrow(.)) %>%
  mutate(sp2 = fct_reorder(sp, ordering))


```


```{r, echo = F, message = F}

load("./data/PA_m1q_more_obs.rda")
summary_PA_LDL <- data.frame(summary(res)$summary)

PA <- dat %>%
  as_data_frame %>%
  mutate(site2 = ifelse(site == "PNM", "DRY", "WET")) %>%
  mutate(sp_site_strata = paste(sp, site2, strata, sep = "_")) %>%
  mutate(site_strata = paste(site2, strata, sep = "_"))


P_vec <- paste("p[", 1:nrow(PA), "]", sep = "")
mu2_vec <- paste("mu2[", 1:nrow(PA), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(PA), ",2]", sep = "")
temp_LMAp <- summary_PA_LDL[P_vec, "mean"] * PA$LMA
temp_LMAs <- PA$LMA - temp_LMAp
temp_LL <- exp(summary_PA_LDL[mu2_vec, "mean"])


PA <- PA %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs) %>%
  mutate(preLL = temp_LL) %>%
  mutate(LDs = LMAs/LT/1000)


PA2 <- PA %>%
  arrange(LMA) %>%
  gather(LMA2, val, c("LMAp", "LMAs")) %>%
  mutate(ordering = 1:nrow(.)) %>%
  mutate(sp_site_strata = fct_reorder(sp_site_strata, ordering)) 


```



```{r, message = F}

ggplot(GL2, aes(x = sp2, y = val, fill = LMA2)) +
  geom_col() +
  ylab("LMA value") +
  xlab("GLOPNET species") 

ggplot(PA2, aes(x = sp_site_strata, y = val, fill = LMA2)) +
  geom_col() +
  ylab("LMA value") +
  xlab("Panama species") 

ggplot(GL2, aes(x = sp2, y = val, fill = LMA2)) +
  geom_col() +
  ylab("LMA value") +
  xlab("GLOPNET species") +
  facet_grid(~DE)

ggplot(PA2, aes(x = sp_site_strata, y = val, fill = LMA2)) +
  geom_col() +
  ylab("LMA value") +
  xlab("Panama species")  +
  facet_grid(site~strata)


```

```{r, echo = F}

var_p <- function(data)cov(data$LMA, data$LMAp)
var_s <- function(data)cov(data$LMA, data$LMAs)
var_t <- function(data)var(data$LMA)

var_p <- function(data)var(data$LMAp)
var_s <- function(data)var(data$LMAs)
cov_ps <- function(data)cov(data$LMAp, data$LMAs)
var_t <- function(data)var(data$LMA)

var_dat <- GL %>%
  mutate(site = "GL") %>%
  group_by(site) %>%
  nest %>%
  mutate(var_LMAm = map_dbl(data, var_p)) %>%
  mutate(var_LMAs = map_dbl(data, var_s)) %>%
  mutate(cov_ms = 2 * map_dbl(data, cov_ps)) %>%
  mutate(var_total = map_dbl(data, var_t)) %>%
  dplyr::select(-data)

var_dat_s <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_LMAm + var_LMAs) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_LMAm + var_LMAs) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance))

var_dat_s2 <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_total) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_total) * 100) %>%
  mutate(cov_LMAm_LMAs = cov_ms / (var_total) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance, cov_LMAm_LMAs)) 


```

# Decomposition of LMA variation 

1) var(LMAm) & var(LMAs) & 2*cov(LMAm, LMAs), 2)relative contribution: var(LMAm)/(var(LMAm) + var(LMAs)) & var(LMAs) /(var(LMAm) + var(LMAs))

```{r, echo = F}

ggplot(var_dat_s2, aes(x = site, y = val, fill = var)) +
  geom_col() +
  ylab("val (%)") 

ggplot(var_dat_s, aes(x = site, y = val, fill = var)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format())

GL

summary_GL_LDL %>% tail


lm(log(Aarea) ~ log(LMA), GL) %>% summary

```


<!--chapter:end:var.rmd-->

