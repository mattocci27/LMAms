---
title: report
author: "Masatoshi Katabuchi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
     collapsed: TRUE
     smooth_scroll: TRUE
     toc: true
---

```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```

```{r}
library(tidyverse)
library(targets)
library(kableExtra)
```

# MCMC diagnostics

```{r}
targets::tar_load(fit_1_summary_GL_LMA)
targets::tar_load(fit_2_summary_PA_LMA)
targets::tar_load(fit_3_summary_PA_LMA_opt)
targets::tar_load(fit_4_summary_GL_Ap_LLs)
targets::tar_load(fit_5_summary_GL_Aps_LLps)
targets::tar_load(fit_6_summary_GL_Ap_LLps)
targets::tar_load(fit_7_summary_GL_Aps_LLs)
targets::tar_load(fit_8_summary_PA_Ap_LLs)
targets::tar_load(fit_9_summary_PA_Aps_LLps)
targets::tar_load(fit_10_summary_PA_Ap_LLps)
targets::tar_load(fit_11_summary_PA_Aps_LLs)
targets::tar_load(fit_12_summary_PA_Ap_LLs_opt)
targets::tar_load(fit_13_summary_PA_Aps_LLps_opt)
targets::tar_load(fit_14_summary_PA_Ap_LLps_opt)
targets::tar_load(fit_15_summary_PA_Aps_LLs_opt)
targets::tar_load(fit_16_summary_PA_Ap_LDs)
targets::tar_load(fit_17_summary_PA_Ap_LDps)
targets::tar_load(fit_18_summary_PA_Ap_LDs_opt)
targets::tar_load(fit_19_summary_PA_Ap_LDps_opt)
targets::tar_load(fit_20_summary_PA_Ap_LLs_opt)
```

Note: Model 6 (GL_Ap_LLps) didn't converge very well.

```{r}
fit_1_summary_GL_LMA |> filter(rhat > 1.05)
fit_2_summary_PA_LMA |> filter(rhat > 1.05)
fit_3_summary_PA_LMA_opt |> filter(rhat > 1.05)
fit_4_summary_GL_Ap_LLs |> filter(rhat > 1.05)
fit_5_summary_GL_Aps_LLps |> filter(rhat > 1.05)
fit_6_summary_GL_Ap_LLps |> filter(rhat > 1.05)
fit_7_summary_GL_Aps_LLs |> filter(rhat > 1.05)
fit_8_summary_PA_Ap_LLs |> filter(rhat > 1.05)
fit_9_summary_PA_Aps_LLps |> filter(rhat > 1.05)
fit_10_summary_PA_Ap_LLps |> filter(rhat > 1.05)
fit_11_summary_PA_Aps_LLs |> filter(rhat > 1.05)
fit_12_summary_PA_Ap_LLs_opt |> filter(rhat > 1.05)
fit_13_summary_PA_Aps_LLps_opt |> filter(rhat > 1.05)
fit_14_summary_PA_Ap_LLps_opt |> filter(rhat > 1.05)
fit_15_summary_PA_Aps_LLs_opt |> filter(rhat > 1.05)
fit_16_summary_PA_Ap_LDs |> filter(rhat > 1.05)
fit_17_summary_PA_Ap_LDps |> filter(rhat > 1.05)
fit_18_summary_PA_Ap_LDs_opt |> filter(rhat > 1.05)
fit_19_summary_PA_Ap_LDps_opt |> filter(rhat > 1.05)
fit_20_summary_PA_Ap_LLs_opt |> filter(rhat > 1.05)
```



```{r}
targets::tar_load(fit_1_diagnostics_GL_LMA)
targets::tar_load(fit_2_diagnostics_PA_LMA)
targets::tar_load(fit_3_diagnostics_PA_LMA_opt)
targets::tar_load(fit_4_diagnostics_GL_Ap_LLs)
targets::tar_load(fit_5_diagnostics_GL_Aps_LLps)
targets::tar_load(fit_6_diagnostics_GL_Ap_LLps)
targets::tar_load(fit_7_diagnostics_GL_Aps_LLs)
targets::tar_load(fit_8_diagnostics_PA_Ap_LLs)
targets::tar_load(fit_9_diagnostics_PA_Aps_LLps)
targets::tar_load(fit_10_diagnostics_PA_Ap_LLps)
targets::tar_load(fit_11_diagnostics_PA_Aps_LLs)
targets::tar_load(fit_12_diagnostics_PA_Ap_LLs_opt)
targets::tar_load(fit_13_diagnostics_PA_Aps_LLps_opt)
targets::tar_load(fit_14_diagnostics_PA_Ap_LLps_opt)
targets::tar_load(fit_15_diagnostics_PA_Aps_LLs_opt)
targets::tar_load(fit_16_diagnostics_PA_Ap_LDs)
targets::tar_load(fit_17_diagnostics_PA_Ap_LDps)
targets::tar_load(fit_18_diagnostics_PA_Ap_LDs_opt)
targets::tar_load(fit_19_diagnostics_PA_Ap_LDps_opt)
targets::tar_load(fit_20_diagnostics_PA_Ap_LLs_opt)
```

```{r}
div_check(fit_1_diagnostics_GL_LMA)
div_check(fit_2_diagnostics_PA_LMA)
div_check(fit_3_diagnostics_PA_LMA_opt)
div_check(fit_4_diagnostics_GL_Ap_LLs)
div_check(fit_5_diagnostics_GL_Aps_LLps)
div_check(fit_6_diagnostics_GL_Ap_LLps)
div_check(fit_7_diagnostics_GL_Aps_LLs)
div_check(fit_8_diagnostics_PA_Ap_LLs)
div_check(fit_9_diagnostics_PA_Aps_LLps)
div_check(fit_10_diagnostics_PA_Ap_LLps)
div_check(fit_11_diagnostics_PA_Aps_LLs)
div_check(fit_13_diagnostics_PA_Aps_LLps_opt)
div_check(fit_14_diagnostics_PA_Ap_LLps_opt)
div_check(fit_15_diagnostics_PA_Aps_LLs_opt)
div_check(fit_16_diagnostics_PA_Ap_LDs)
div_check(fit_17_diagnostics_PA_Ap_LDps)
div_check(fit_18_diagnostics_PA_Ap_LDs_opt)
div_check(fit_19_diagnostics_PA_Ap_LDps_opt)
div_check(fit_20_diagnostics_PA_Ap_LLs_opt)
```

Model 4: GL_Ap_LLs is best for GLOPNET.

```{r}
targets::tar_load(loo_model)
loo::loo_compare(
   loo_model[[1]],
   model4 = loo_model[[4]],
   model5 = loo_model[[5]],
   model6 = loo_model[[6]],
   model7 = loo_model[[7]]) |>
  print()
```

Model 12: PA_Ap_LLs_opt is best for Panama.

```{r}
loo::loo_compare(
  loo_model[[2]],
  model3 = loo_model[[3]],
  model8 = loo_model[[8]],
  model9 = loo_model[[9]],
  model10 = loo_model[[10]],
  model11 = loo_model[[11]],
  model12 = loo_model[[12]],
  model13 = loo_model[[13]],
  model14 = loo_model[[14]],
  model15 = loo_model[[15]],
  model16 = loo_model[[16]],
  model17 = loo_model[[17]],
  model18 = loo_model[[18]],
  model19 = loo_model[[19]]) |>
  print()
```


# Diagnostics for randomized data

There are too many divergent transitions.

```{r}
targets::tar_read(gl_rand_check)
summary(gl_rand_check)

targets::tar_load(pa_rand_check)
summary(pa_rand_check)
```


None of the randomized datasets did converge.

```{r}
targets::tar_load(gl_rand_sig)

gl_rand_sig

gl_rand_sig |>
  filter(sig == "sig") |>
  filter(!str_detect(para, "0"))
```

```{r}
targets::tar_load(pa_rand_sig)

pa_rand_sig

pa_rand_sig |>
  filter(sig == "sig") |>
  filter(!str_detect(para, "0"))
```


![](figs/coef_rand.png)

![](figs/coef_rand_pa.png)


# Computing Environment

```{r}
devtools::session_info()
```

# Pipelines

```{r, fig.width=20, fig.height=20}
targets::tar_visnetwork()
```
