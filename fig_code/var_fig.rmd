---
title: variance figure
---


```{r}
library(tidyverse)
setwd("..")

settings <- yaml::yaml.load_file("settings.yml")
var_val <- read_csv("./data/var_val.csv")
source("fig_theme.r")

#sd(rlnorm(100, log(80), 1)) /  sd(rlnorm(100, log(40), 0.1))
log_var <- function(mu, sigma) {
  (exp(sigma^2) - 1) * exp(2 * mu + sigma^2)
}

#log_var(2, 1)

log_var_inv <- function(v, sigma) {
  tmp <- 0.5 * (log(v) - sigma^2 - log(exp(sigma^2) - 1))
  exp(tmp)
}


v <- 10^4
mu <- log(40)

exp(log(v) - 2 * mu)

log_mu_inv <- function(v, mu){
  tmp <- log(1 - exp(log(v) - 2 * mu))
  sqrt(-tmp)
}

log_mu_inv <- function(v, mu) {
  esig2 <- 0.5 * (1 + sqrt(1 + 4*exp(log(v) - 2 *mu)))
  log(esig2) %>% sqrt
}

v1 <- log_var(log(40), 0.9)
log_mu_inv(v1, log(40))

log_mu_inv(c(40, 16), c(log(40), log(40)))

log10(0.1)
log10(1)
log10(10)

const <- 10^seq(-1,1, by = 0.05) 

moge <- log_var(log(40), 0.1)
log_var_inv(log_var(log(40), 0.1), 0.1)
log_mu_inv(log_var(log(40), 0.1), log(40))
log_mu_inv(c(400000, 16), c(log(40), log(40)))

mu1 <- 55
sigma1 <- seq(0.1, 1, by = 0.1)
sigma1 <- seq(0.1, 1, length = 10)

var(log(GL$LMAp)) /var(log(GL$LMAs))
var((GL$LMAp)) /var((GL$LMAs))

log_mu_inv(log_var_inv(), log(median(GL$LMAp)))

para1 <- expand.grid(sigma1, sigma1) %>%
  mutate(ratio1 = Var1/Var2)

var1 <- log_var(log(mu1), sigma1)
var2 <- log_var(log(80), sigma1)

para2 <- expand.grid(var1, var2) %>%
  mutate(ratio1 = Var1/Var2) %>%
  mutate(ratio2 = log(Var1)/log(Var2))

plot(para2$ratio1 ~ para1$ratio1)
plot(para2$ratio2 ~ para1$ratio1)



hist(para1$ratio1)
hist(para2$ratio1)

#log_V = log(e(s^2)-1) +2m - log(e(s^2))
#       = log(1 - e(-s^2)) + 2m
#
#log(1-e(-s^2)) = log_V - 2m
#1 - e(-s2) = exp(log_V - 2m)
#
#e(-s2) = 1 - exp(log_V - 2m) 
#
#-s^2 = log(1 - exp(log_v - 2m))
#
#2m = log_V - log(2- e(-s2))

sigma1 <- seq(0.3, 1, length = 10)
mu1 <- c(40)
const <- 10^seq(-1,1, by = 0.05) 
p_scale <- seq(0.1, 1, length = 40)
mu2 <- c(40)



para <- expand.grid(sigma1, mu1, p_scale, const, mu2) %>%
  as_data_frame
colnames(para) <- c("sigma1", 
                    "mu1", 
                    "Aarea_scale",
                    "const",
                    "mu2")

para2 <- para %>%
  mutate(LMAp_var = log_var(log(mu1), sigma1)) %>%
  #mutate(mu2 = log_var_inv(LMAp_var / const, sigma2)) %>%
  #filter(log(LMAp_var * 1/const ) < 2*log(mu2)) %>%
  mutate(sigma2 = log_mu_inv(LMAp_var * 1/const, log(mu2))) %>%
  #filter(log(LMAp_var) < 2*log(mu2)) %>%
  #mutate(sigma2 = log_mu_inv(LMAp_var, log(mu2))) %>%
  mutate(LMAs_var = log_var(log(mu2), sigma2)) %>%
  mutate(var_ratio = LMAp_var / (LMAs_var + LMAp_var)) %>%
  mutate(var_ratio2 = (LMAp_var/LMAs_var)) %>%
  mutate(moge = LMAp_var / (LMAp_var + LMAs_var) * 100) %>%
  mutate(moge = round(moge,1))

para2 %>%
  filter(Aarea_scale == 0.1) %>%
  plot(const ~ var_ratio2, .)


log_mu_inv(165, log(40))


para2 %>%
 # filter(Aarea_scale == 0.2) %>% 
  DT::datatable(.)


aa <- rlnorm(100, log(40), 0.1)
bb <- rlnorm(100, log(80), 0.3)
hist(aa)


var(aa)
var(bb)
var(aa)/var(bb)

sd(aa)/mean(aa)
sd(bb)/mean(bb)

sd(aa)/sd(bb)

#DT::datatable(para2)

#var_vec <- seq(0.1, 1, length = 100)
#p_scale <- seq(0.1, 1, length = 100)
#a_sd <- p_scale
#mu <- c(40, 80, 120)
##mu <- seq(40, 44, length = 5)
#mu <- 40
##p_scale <- c(0.1, 0.5, 1)
##a_sd <- c(0.1, 0.5, 1)
#para <- expand.grid(var_vec, 0.5, p_scale, 0.01, mu, mu) 
#colnames(para) <- c("LMAp_sd", "LMAs_sd", "Aarea_scale", "mu_sd", "mu1", "mu2")
#
dat_fun <- function(n){
  LMAp <- rlnorm(100, log(para2$mu1[n]), para2$sigma1[n])
  LMAs <- rlnorm(100, log(para2$mu2[n]), para2$sigma2[n])
  log_mu <- 1.5 + para$Aarea_scale[n] * log(LMAp)
  Aarea <- rlnorm(100, log_mu, 0.5)
  dat <- data_frame(LMAp, LMAs, Aarea) %>%
    mutate(LMA = LMAp + LMAs) %>%
    filter(is.finite(Aarea))
  dat
}

cor_fun <- function(data) {
  cor(log(data$Aarea), log(data$LMA))
}

b_fun <- function(data) {
  res <- lm(log(Aarea) ~ log(LMA), data = data)
  res[[1]][2]
}

before <- proc.time()
para3 <- para2 %>%
  mutate(res = map(1:nrow(.), dat_fun)) %>%
  as_data_frame
after <- proc.time()
after - before

var_fun <- function(data) {
  var_p <- var(data$LMAp)
  var_s <- var(data$LMAs)
  #cov_ps <- cov(data$LMAp, data$LMAs)
  #var_t <- var(data$LMA)
  var_LMAm <- var_p /(var_p + var_s) * 100
  #var_LMAs <- var_s /(var_p + var_s) * 100
  var_LMAm 
  #data_frame(var_LMAm, var_LMAs)
}

para4 <- para3 %>%
  mutate(r = map_dbl(res, cor_fun)) %>%
  mutate(b = map_dbl(res,b_fun)) %>%
  mutate(var_LMAm = map_dbl(res,var_fun)) %>%
  dplyr::select(-res) 

para4 %>%
  #filter(Aarea_scale == 0.2) %>% 
  #filter(sigma1 == sigma2) %>%
  DT::datatable(.)

para5 <- para4 %>%
  mutate(var_ratio3 = round(var_ratio2, 1)) %>%
  filter(var_ratio3 > 0)

para5$var_ratio3 %>% unique %>% sort

simvar <- ggplot(para4 %>% filter(b < 1.2 & b > -0.2),
#simvar <- ggplot(para4,
                 aes(x = const, y = Aarea_scale, fill = b)) +
  geom_raster() +
  scale_fill_gradient2(midpoint = 0.5,
                       name = "Mass \nproportionality") +
  theme(panel.background = element_rect(fill = "#073642")) +
  xlab("Var(LMAm)/Var(LMAs)") +
  ylab("Scaling slope") +
#  scale_x_log10(limits=c(0.1, 10)) 
  scale_x_log10() 

simvar


 # geom_point(data = var_dat2, aes(x = mid, y = X50.)) +
 # geom_errorbar(data = var_dat2,
 #               aes(ymin = X2.5.,
 #                   ymax = X97.5.,
 #                   x = mid),
 #               width = 0) +
 # geom_errorbarh(data = var_dat2,
 #               aes(xmin = low,
 #                   xmax = up,
 #                   y = X50.),
 #                height = 0)

simvar



my_ggsave("./figs/simvar.png",
          simvar,
          height = 6,
          width = 10)

simvar2 <- ggplot(para4 %>% filter(b < 1 & b > 0),
                 aes(x = sigma1/sigma2, y = Aarea_scale, fill = b)) +
  geom_raster() +
  scale_fill_gradient2(midpoint = 0.5,
                       name = "Mass \nproportionality") +
  theme(panel.background = element_rect(fill = "#073642")) +
  xlab("Var(LMAm)/Var(LMAs)") +
  ylab("Scaling slope") #+

hist(para2$sigma1/para2$sigma2)

```
