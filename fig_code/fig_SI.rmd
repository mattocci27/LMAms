---
title: Figures for LMA paper SI
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      cache=FALSE,
                      message=FALSE)
```

```{r}
library(tidyverse)
library(stringr)
library(lazyeval)
library(scales)
library(cowplot)
library(ggrepel)
library(ggthemes)
library(rstan)
library(bayesplot)

settings <- yaml::yaml.load_file("../settings.yml")
r_vals <- yaml::yaml.load_file("../r_val.yml")
p_letters <- yaml::yaml.load_file("../letters.yml")
source("../fig_theme.r")

```

```{r}

scatter_plt <- function(data) {
  ggplot(data, aes(x = Val, y = Val2, 
                               fill = gr, 
                               col = gr)) +
  geom_point(shape = 21) +
  facet_grid(Trait2 ~ LMA,
             scales = "free",
             switch = "both", 
             labeller = labeller(Trait2 = label_parsed,
                                 LMA = label_parsed
                                 )) +
  geom_text(data = lab1, aes(label = lab), 
            hjust = 0.25,
            vjust = 0.25,
            size = 8 * 5/14,
            show.legend = FALSE,
            color = "black") +
  #geom_text(data = lab1, aes(label = r_vals, x = Val_max), 
  #          hjust = 1,
  #          vjust= 0.25,
  #          size = 8 * 5/14,
  #          parse = TRUE,
  #          color = "black",
  #          show.legend = FALSE) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_x_log10(breaks = my_breaks_x(), expand = c(0.1, 0)) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0)) +
  xlab("") +
  ylab("") +
  theme_LES()
}

```

```{r}
load("../rda/GL_LMAms_more_rand.rda")

# 6 converged
n <- 6
GL_summary <- rand_res$summary[[n]]
dat_r <- rand_res$data[[n]]

tmp <- rand_res$model[[n]]
mcmc_trace(tmp, pars = c("amas[1]",  "amas[2]", "lp__"))

mcmc_trace(tmp, pars = c("p[68]", "p[5]", "p[3]", "p[4]"))

DT::datatable(GL_summary %>% round(2))

GL <- dat %>%
  mutate(LMA = dat_r$LMA,
         LL = dat_r$LL,
         Aarea = dat_r$A,
         Rarea = dat_r$R) %>%
  as_tibble %>%
  mutate(LMAp = GL_summary[str_detect(rownames(GL_summary),
                            "log_LMAp"), "X50."] %>%  exp) %>%
  mutate(LMAs = GL_summary[str_detect(rownames(GL_summary),
                            "log_LMAs\\["), "X50."] %>%  exp)

GL_dat <- GL %>%
  gather(LMA, Val,
         c(LMA, LMAs, LMAp)) %>%
  gather(Trait, Val2, c(Aarea, Rarea, LL)) %>%
  as.data.frame %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA", "LMAm", "LMAs"))) %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA~(~g~m^{-2})", "LMAm~(~g~m^{-2})", "LMAs~(~g~m^{-2})"))) %>%
  mutate(DE = factor(DE,
          levels = c("D", "E", "U"))) %>%
  mutate(gr = factor(DE,
          labels = c("Deciduous", "Evergreen", "Unclassified"))) %>%
  mutate(Trait = factor(Trait,
    levels = c("Aarea", "Rarea", "LL"))) %>%
  mutate(Trait2 = factor(Trait,
    labels = c("italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "italic(R)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "LL~(months)"
               ))) %>%
  #arrange(desc(gr))
  arrange(gr) %>% as_tibble


hist(GL$LMAp / GL$LMA)

fit_m <- lm(log(LMAs) ~ log(LMAp), GL)
fit_s <- lm(log(LMAp) ~ log(LMAs), GL)
fit_Rm <- lm(log(Rarea) ~ log(LMAp), GL)
fit_Rs <- lm(log(Rarea) ~ log(LMAs), GL)
fit_Am <- lm(log(Aarea) ~ log(LMAp), GL)
fit_As <- lm(log(Aarea) ~ log(LMAs), GL)

res_m  <- residuals(fit_m)
res_s  <- residuals(fit_s)
res_Rm  <- residuals(fit_Rm)
res_Rs  <- residuals(fit_Rs)
res_Am  <- residuals(fit_Am)
res_As  <- residuals(fit_As)

par(mfrow=c(1,2))
plot(res_m, res_Rm)
plot(res_s, res_Rs)
par(mfrow=c(1,1))

par(mfrow=c(1,2))
plot(res_m, res_Am)
plot(res_s, res_As)
par(mfrow=c(1,1))



# GL LES plot ----------------------------------------------------------------0
GL_dat1 <- GL_dat %>%
  filter(Trait == "LL" |
         Trait == "Aarea" |
         Trait == "Rarea")

lim_GL <- lim_func(GL_dat1 %>% filter(gr != "Rand"), 
                   trait = "Val")
lim_GL2 <- lim_func(GL_dat1 %>% filter(gr != "Rand"),
                    trait = "Val2", LMA = FALSE)

lab1 <- tibble(lab = paste("(", letters[1:9], ")", sep = ""),
                   Val2 = lim_GL2$max_val %>% rep(each = 3),
                   Val = lim_GL$min_val %>% rep(3),
                   Val_max = lim_GL$max_val %>% rep(3),
                   gr = "Evergreen",
                   r_vals = r_vals$r_vals$GL %>% unlist,
                   Trait2 = rep(lim_GL2$Trait2, each = 3),
                   LMA = rep(lim_GL$LMA, 3)
                   )

fills <- c("Deciduous" = settings$fills$D,
          "Evergreen" = settings$fills$E,
          "Unclassified" = settings$fills$U)

cols <- c("Deciduous" = settings$colors$D,
          "Evergreen" = settings$colors$E,
          "Unclassified" = settings$colors$U)

GL_plot <- scatter_plt(GL_dat1)

summary(GL_dat1)
summary(lab1)

my_ggsave("../figs/GL_rand.png", GL_plot)
```

![GL](../figs/GL_rand.png)

# PA

```{r}
load("../rda/PA_LMAms_L0_more_rand.rda")

#1-3 not converged 1 is relatively ok
n <- 2
PAres <- rand_res$model[[n]]
PA_summary <- rand_res$summary[[n]]
dat_r <- rand_res$data[[n]]

tmp <- rand_res$model[[n]]
mcmc_trace(tmp, pars = c("am", "as", "lp__"))
mcmc_trace(tmp, pars = c("p[68]", "p[5]", "p[3]", "p[4]"))

DT::datatable(PA_summary %>% round(2))

PA_p_mat <- rstan::extract(PAres, "p")[[1]] 
PA_p_vec <- apply(PA_p_mat, 2, median)
PA_p_vec_lo <- apply(PA_p_mat, 2, function(x)quantile(x, 0.025))
PA_p_vec_up <- apply(PA_p_mat, 2, function(x)quantile(x, 0.975))


LLpred_mat <- as.data.frame(PAres) %>%
  as_tibble %>%
  select(contains("Mu")) %>%
  select(contains(",2]")) %>%
  as.matrix

preLL <- apply(LLpred_mat, 2, function(x) median(exp(x)))

PA <- dat %>%
  mutate(LMA = dat_r$LMA,
         LL = dat_r$LL,
         Aarea = dat_r$A,
         Rarea = dat_r$R) %>%
  as_data_frame %>%
  mutate(LMAp = LMA * PA_p_vec) %>%
  mutate(LMAs = LMA - LMAp)  %>%
  #mutate(preLL = preLL) %>%
  mutate(site2 = ifelse(site == "PNM", "DRY", "WET")) %>%
  mutate(sp_site_strata = paste(sp, site2, strata, sep = "_")) %>%
  mutate(site_strata = paste(site2, strata, sep = "_"))

PA_dat <- PA %>%
  gather(LMA, Val,
         c(LMA, LMAs, LMAp)) %>%
  gather(Trait, Val2, c(Aarea, Rarea, LL)) %>%
  as.data.frame %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA", "LMAm", "LMAs"))) %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA~(~g~m^{-2})", "LMAm~(~g~m^{-2})", "LMAs~(~g~m^{-2})"))) %>%
  mutate(site_strata = factor(site_strata,
          levels = c("WET_CAN", "DRY_CAN", "WET_UNDER", "DRY_UNDER"))) %>%
  mutate(Trait = factor(Trait,
    levels = c("Aarea", "Rarea", "LL"))) %>%
  mutate(Trait2 = factor(Trait,
    labels = c("italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "italic(R)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "LL~(months)"
               ))) %>%
  mutate(gr = factor(site_strata,
    labels = c("Sun-Wet",
               "Sun-Dry",
               "Shade-Wet",
               "Shade-Dry"
                      ))) %>%
  #arrange(desc(gr))
  arrange(gr) %>% as_tibble

hist(PA$LMAp / PA$LMA)

fit_m <- lm(log(LMAs) ~ log(LMAp), PA)
fit_s <- lm(log(LMAp) ~ log(LMAs), PA)
fit_Rm <- lm(log(Rarea) ~ log(LMAp), PA)
fit_Rs <- lm(log(Rarea) ~ log(LMAs), PA)
fit_Am <- lm(log(Aarea) ~ log(LMAp), PA)
fit_As <- lm(log(Aarea) ~ log(LMAs), PA)

res_m  <- residuals(fit_m)
res_s  <- residuals(fit_s)
res_Rm  <- residuals(fit_Rm)
res_Rs  <- residuals(fit_Rs)
res_Am  <- residuals(fit_Am)
res_As  <- residuals(fit_As)

par(mfrow=c(1,2))
plot(res_m, res_Rm)
plot(res_s, res_Rs)
par(mfrow=c(1,1))

par(mfrow=c(1,2))
plot(res_m, res_Am)
plot(res_s, res_As)
par(mfrow=c(1,1))


# PA LES plot ----------------------------------------------------------------0
PA_dat1 <- PA_dat %>%
  filter(Trait == "LL" |
         Trait == "Aarea" |
         Trait == "Rarea")

lim_PA <- lim_func(PA_dat1 %>% filter(site_strata != "Rand"), 
                   trait = "Val")
lim_PA2 <- lim_func(PA_dat1 %>% filter(site_strata != "Rand"),
                    trait = "Val2", LMA = FALSE)

lab1 <- tibble(lab = paste("(", letters[1:9], ")", sep = ""),
                   Val2 = lim_PA2$max_val %>% rep(each = 3),
                   Val = lim_PA$min_val %>% rep(3),
                   Val_max = lim_PA$max_val %>% rep(3),
                   gr = "Sun-Dry",
                   r_vals = r_vals$r_vals$PA %>% unlist,
                   Trait2 = rep(lim_PA2$Trait2, each = 3),
                   LMA = rep(lim_PA$LMA, 3)
                   )

fills <- c("Sun-Dry" = settings$fills$sun_dry,
          "Sun-Wet" = settings$fills$sun_wet,
          "Shade-Dry" = settings$fills$shade_dry,
          "Shade-Wet" = settings$fills$shade_wet)

cols <- c("Sun-Dry" = settings$colors$sun_dry,
          "Sun-Wet" = settings$colors$sun_wet,
          "Shade-Dry" = settings$colors$shade_dry,
          "Shade-Wet" = settings$colors$shade_wet)

PA_plot <- scatter_plt(PA_dat1)

my_ggsave("../figs/PA_rand.png", PA_plot)
```

![PA](../figs/PA_rand.png)

```{r, eval = F}

# LL plot ---------------------------------------------------------------------

LL_dat <- PA %>%
  as.data.frame %>%
  mutate(site_strata = factor(site_strata,
          levels = c("WET_CAN", "DRY_CAN", "WET_UNDER", "DRY_UNDER"))) %>%
  mutate(gr = factor(site_strata,
    labels = c("Sun-Wet",
               "Sun-Dry",
               "Shade-Wet",
               "Shade-Dry"
                      )))

labLL <- tibble(
                   LL = Inf,
                   Val = min(PA$LL),
                   Val_max = max(PA$LL),
                   gr = "Sun-Dry",
                   r_vals = r_vals$r_vals$PA_LL$preLL_LL
                   )

LL_plot <- ggplot(LL_dat, aes(x = preLL, y = LL, 
                              fill = gr, col = gr)) + 
  geom_point(shape = 21) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_x_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(labLL$Val), max(labLL$Val_max))) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0), 
                limits = c(min(labLL$Val), max(labLL$Val_max))) +
  xlab("Predicted LL (months)") +
  ylab("Observed LL (months)") +
  geom_abline(aes(slope = 1, intercept = 0), 
              lty = 2, 
              lwd = 0.25, 
              col = "gray20") +
 # geom_text(data = labLL, aes(label = r_vals, x = Val_max, y = 2.5), 
 #           colour = "black",
 #           hjust = 1,
 #           vjust= 0,
 #           parse = TRUE,
 #           show.legend = FALSE) +
  coord_fixed() +
  theme_LES() +
  theme(
    legend.position = c(0.2, 0.85),
    axis.title.x = element_text(margin = margin(t = 1,
                                                b = 1,
                                                l = 0,
                                                r = 0)),
    axis.title.y = element_text(margin = margin(t = 1,
                                                b = 1,
                                                l = 1,
                                                r = 1))
        )

my_ggsave("../figs/LL_rand.png", LL_plot,
          width = 6.7,
          height = 6.7)

## LMAm vs LMAs

```

![LL](../figs/LL_rand.png)
