---
title: Diagnostics for randomized data
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
#rmdformats::material
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
      toc: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,
                      warning=FALSE,
                      cache=FALSE,
                      message=FALSE)
```

```{r, cache=FALSE}
library(tidyverse)
library(rstan)
library(scales)
library(memisc)
library(bayesplot)
library(patchwork)
library(tictoc)
settings <- yaml::yaml.load_file("../settings.yml")
```


```{r GLdata, eval=TRUE, comment=NA}
tic()
load("../rda/GL_Aps_LLs_rand.rda")
toc()
GL <- dat
GLrand <- rand_dat
GLres <- rand_res  |>
  mutate(dataset = "GLOPNET")
```



```{r, PAdata, eval=TRUE}
tic()
load("../rda/PA_Ap_LLs_opt_more_rand.rda")
toc()
PA <- dat
PArand <- rand_dat
PAres <- rand_res |>
  mutate(dataset = "Panama")

res <- bind_rows(GLres, PAres)
```

```{r, eval=FALSE}
rm(rand_res)
rm(GLres)
rm(PAres)
res <- res |>
  dplyr::select(-model)
```

# Diagnostics

## Rhat

```{r Rhat, fig.height=9, eval=TRUE, comment=NA}
#load("test.Rda")
hist_dat <- res %>%
  mutate(Rhat = map(summary, ~ .$Rhat)) %>%
  dplyr::select(null_model, dataset, Rhat) %>%
  unnest(cols = c(Rhat)) %>%
  filter(!is.nan(Rhat))

max_Rhat <- hist_dat %>%
  group_by(null_model, dataset) %>%
  summarize(Rhat_max = max(Rhat))

hist_dat2 <- full_join(hist_dat, max_Rhat,
                       by = c("null_model" = "null_model",
                                     "dataset" = "dataset")) %>%
  mutate(conv = ifelse(Rhat_max > 1.1, "Not-convergent", "Convergent"))

p1 <- hist_dat2 |>
  filter(dataset == "GLOPNET") |>
  ggplot(aes(Rhat, fill = conv)) +
    geom_histogram() +
    geom_vline(xintercept = 1.1) +
    facet_wrap( ~ null_model, scale = "free") +
    ggtitle("GLOPNET") +
    theme_light() +
    theme(legend.position = c(0.7, 0.15))

p2 <- hist_dat2 |>
  filter(dataset != "GLOPNET") |>
  ggplot(aes(Rhat, fill = conv)) +
    geom_histogram() +
    geom_vline(xintercept = 1.1) +
    facet_wrap( ~ null_model, scale = "free") +
    ggtitle("Panama") +
    theme_light() +
    theme(legend.position = "none")

p1 / p2 +
  plot_annotation(tag_levels = "a")

```


Only the 9th simulation of the GLOPNET data and the 8th simulation of the Panama data showed convegence of the posterior distibution based on the Gelman-Rubin statistic with a convergence threshold of 1.1.

Check posterior distributions for 10 randomized datasets.


```{r, eval=FALSE}

color_scheme_set("mix-brightblue-gray")

check_trace <- function(x) {
  fit <- GLres$model[[x]]
  post_cp <- as.array(fit)
  np_cp <- nuts_params(fit)

  div_style <- scatter_style_np(div_color = "red",
  div_shape = 15,
  div_alpha = 0.8,
  div_size = 4)

  mcmc_scatter(
    post_cp,
    pars = c("L_sigma[1]", "L_sigma[2]"),
    np = np_cp,
    np_style = div_style
  ) +
    ggtitle(str_c("Rand", x, sep = " "))
}

tic()
1:10 |>
  map(check_trace) |>
  walk(print)
toc()

```

## Divergent transitions for GLOPNET

```{r trace, eval=TRUE, fig.height=3}
color_scheme_set("mix-brightblue-gray")

check_trace <- function(x) {
  fit <- GLres$model[[x]]
  np_cp <- nuts_params(fit)
  mcmc_trace(fit,
 # pars = c("Z[2,3]", "lp__"),
    pars = c("L_sigma[1]", "L_sigma[2]"),
   np = np_cp) +
    ggtitle(str_c("Rand", x, sep = " "))
}


tic()
1:10 |>
  map(check_trace) |>
  walk(print)
toc()

```

Divergent transitions indicate biased estimates for posterior distributions.
Although Rand 2 and 10 did not show divergent transitions but these model did not
show any patterns (See the figures below). The other models showed divergent transitions.

## Divergent transitions for Panama

All the simluations showed divergent transitions.

```{r trace2, eval=TRUE, fig.height=3}

check_trace2 <- function(x) {
  fit <- PAres$model[[x]]
  np_cp <- nuts_params(fit)
  mcmc_trace(fit,
    pars = c("L_sigma[1]", "L_sigma[2]"),
   np = np_cp) +
    ggtitle(str_c("Rand", x, sep = " "))
}

tic()
1:10 |>
  map(check_trace2) |>
  walk(print)
toc()

```

# GLOPNET (rand 2)

The 2nd simulation did not show divergent transition but it was not convergent, which suggests posteriors distirubitons are not relaiable.

```{r}
n <- 2
```

```{r, GLdata2, echo=FALSE}
make_GL <- function(n) {
  sGL <- GLres$summary[[n]]

  sGL %>%
    round(3) %>%
    DT::datatable(.)

  tmp <- GLrand$data[[n]]

  GL0 <- GL %>%
    as_tibble %>%
    dplyr::select(sp, DE, GF)

  GL2 <- tibble(LMA = tmp$LMA,
                  Aarea = tmp$A,
                  LL = tmp$LL,
                  Rarea = tmp$R)

  p_mat <- rstan::extract(GLres$model[[n]], "p")[[1]]
  p_vec <- apply(p_mat, 2, mean)

  GL3 <- bind_cols(GL0, GL2) |>
    mutate(LMAp = LMA * p_vec) |>
    mutate(LMAs = LMA - LMAp)

  d <- read_csv("../data/nature.csv")

  dd <- data.frame(Narea = 10^d$`log.Narea`,
          Parea = 10^d$`log.Parea`,
          sp = d$Species) %>%
          group_by(sp) %>%
          summarize(Narea = mean(Narea, na.omit = T),
              Parea = mean(Parea, na.omit = T))

  GL4 <- left_join(GL3, dd, by = "sp") %>%
    mutate(gr = factor(DE,
      labels = c("Deciduous",
                "Evergreen",
                "Unclassified"
                        ))) %>%
    arrange(desc(gr))
}

make_GL_long <- function(data) {
  data %>%
    gather(LMA, val, c("LMA", "LMAp", "LMAs")) %>%
    gather(trait, val2, c("Aarea", "LL", "Rarea"))
}

fills <- c("Deciduous" = settings$fills$D,
          "Evergreen" = settings$fills$E,
          "Unclassified" = settings$fills$U)

cols <- c("Deciduous" = settings$colors$D,
          "Evergreen" = settings$colors$E,
          "Unclassified" = settings$colors$U)

```

## A~area~, R~area~, LL


```{r ARL, echo=F, message = F, eval=TRUE}
GL2 <- make_GL(n)
GL3 <- make_GL_long(GL2)

ggplot(GL3, aes(x = val, y = val2, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

```

## LMAp vs LMAs

```{r ps, echo = F, message = F,eval=TRUE}
ggplot(GL2, aes(x = LMAp, y = LMAs, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  xlab("LMAp") +
  ylab("LMAs") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

```

## Trait means

The results look nice and do not alter main conclusions.

```{r box, echo = F, message = F, eval=FALSE}
ggplot(GL2, aes(x = gr, y = val,
                fill = gr,
                col = gr)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols)
```


# GLOPNET (rand 9)

The 9th simulation was convergent but it showed divergent transition, which suggests posteriors distirubitons are not relaiable.

```{r}
n <- 9
```
## A~area~, R~area~, LL


```{r ARL2, echo = F, cache = F, eval=TRUE}

GL2 <- make_GL(n)
GL3 <- make_GL_long(GL2)

ggplot(GL3, aes(x = val, y = val2, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))
```

## LMAp vs LMAs


```{r ps2, echo = F, message = F,eval=TRUE}
ggplot(GL2, aes(x = LMAp, y = LMAs, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  xlab("LMAp") +
  ylab("LMAs") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

```

# Panama (rand 2)

```{r}
n <- 2
```

```{r, PAdata2, eval=TRUE}

make_PA <- function(n) {
  sPA <- PAres$summary[[n]]

  tmp <- PArand$data[[n]]

  PA0 <- PA %>%
    as_tibble %>%
    dplyr::select(sp, site, strata) %>%
    mutate(site2 = ifelse(site == "PNM", "DRY", "WET")) %>%
    mutate(sp_site_strata = paste(sp, site2, strata, sep = "_")) %>%
    mutate(site_strata = paste(site2, strata, sep = "_")) %>%
    mutate(site_strata = factor(site_strata,
            levels = c("WET_CAN", "DRY_CAN", "WET_UNDER", "DRY_UNDER"))) %>%
    mutate(gr = factor(site_strata,
      labels = c("Sun-Wet",
                "Sun-Dry",
                "Shade-Wet",
                "Shade-Dry"
                        )))

  PA2 <- tibble(LMA = tmp$LMA,
                  Aarea = tmp$A,
                  LL = tmp$LL,
                  Rarea = tmp$R
                  )

  PA3 <- bind_cols(PA2, PA0)

  p_mat <- rstan::extract(PAres$model[[n]], "p")[[1]]
  p_vec <- apply(p_mat, 2, mean)

  PA4 <- PA3 |>
    mutate(LMAp = LMA * p_vec) |>
    mutate(LMAs = LMA - LMAp)
  PA4
}


fills2 <- c("Sun-Dry" = settings$fills$sun_dry,
          "Sun-Wet" = settings$fills$sun_wet,
          "Shade-Dry" = settings$fills$shade_dry,
          "Shade-Wet" = settings$fills$shade_wet)

cols2 <- c("Sun-Dry" = settings$colors$sun_dry,
          "Sun-Wet" = settings$colors$sun_wet,
          "Shade-Dry" = settings$colors$shade_dry,
          "Shade-Wet" = settings$colors$shade_wet)
```

```{r ARL_PA, eval=TRUE}

PA2 <- make_PA(n)
PA3 <- make_GL_long(PA2)

ggplot(PA3, aes(x = val, y = val2, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills2) +
  scale_colour_manual(values = cols2) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

```

```{r ps_PA, echo = F, message = F,eval=TRUE}
ggplot(PA2, aes(x = LMAp, y = LMAs, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  xlab("LMAp") +
  ylab("LMAs") +
  scale_fill_manual(values = fills2) +
  scale_colour_manual(values = cols2) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

```

# Panama (rand 8)

```{r}
n <- 8
```

```{r ARL_PA2, eval=TRUE}

PA2 <- make_PA(n)
PA3 <- make_GL_long(PA2)

ggplot(PA3, aes(x = val, y = val2, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills2) +
  scale_colour_manual(values = cols2) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

```

```{r ps_PA2, echo = F, message = F,eval=TRUE}
ggplot(PA2, aes(x = LMAp, y = LMAs, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  xlab("LMAp") +
  ylab("LMAs") +
  scale_fill_manual(values = fills2) +
  scale_colour_manual(values = cols2) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

```