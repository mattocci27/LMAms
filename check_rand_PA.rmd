---
title: Diagnostics for randomized data (Panama)
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
#rmdformats::material
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
      toc: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      cache=FALSE,
                      message=FALSE)
```

```{r}

library(tidyverse)
library(rstan)
library(scales)
library(memisc)
library(bayesplot)

settings <- yaml::yaml.load_file("settings.yml")
```

```{r}

load("./rda/PA_LMAms_L0_more_rand.rda")

```

# Diagnostics

```{r}

#color_scheme_set("darkgray")
color_scheme_set("mix-brightblue-gray")

check_trace <- function(x) {
  fit <- rand_res$model[[x]]
  np_cp <- nuts_params(fit)
  mcmc_trace(fit, pars = c("Z[2,3]", "lp__"), np = np_cp) +
    ggtitle(str_c("Rand", x, sep = " "))
}


p <- 1:9  %>%
  map(check_trace)

p %>%
  walk(print)

```


```{r}
rand_n <- 1
summary_PA_LDL <- rand_res$summary[[rand_n]]

summary_PA_LDL %>%
  round(3) %>%
  DT::datatable(.)

PA <- dat %>%
  as_tibble %>%
  mutate(LMA = rand_res$data[[rand_n]]$LMA) %>%
  mutate(Aarea = rand_res$data[[rand_n]]$A) %>%
  mutate(Rarea = rand_res$data[[rand_n]]$R) %>%
  mutate(site2 = ifelse(site == "PNM", "DRY", "WET")) %>%
  mutate(sp_site_strata = paste(sp, site2, strata, sep = "_")) %>%
  mutate(site_strata = paste(site2, strata, sep = "_"))

P_vec <- paste("p[", 1:nrow(PA), "]", sep = "")
mu2_vec <- paste("mu2[", 1:nrow(PA), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(PA), ",2]", sep = "")
temp_LMAp <- summary_PA_LDL[P_vec, "mean"] * PA$LMA
temp_LMAs <- PA$LMA - temp_LMAp
#temp_LL <- exp(summary_PA_LDL[mu2_vec, "mean"])

Mu_mcmc <- extract(rand_res$model[[rand_n]], pars = "Mu")[[1]] 

preLL <- Mu_mcmc[,,2] %>% apply(., 2, median) %>% exp

PA <- PA %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs) %>%
  mutate(preLL = preLL) 

```
# Trait correlations

## A~area~, R~area~, LL

*Note that MCMC didn't work well at all.* Open symbols indicate sun leaves and closed symbols indicate shade leaves. 

```{r, echo = F, message = F}

PA2 <- PA %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs")) %>%
  gather(trait, val2, c("Aarea", "LL", "Rarea")) %>%
  gather(trait2, val3, c("Narea","Parea","cell_area","cell_vol"))


ggplot(PA2, aes(x = val, y = val2, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA and LD") +
  ylab("Traits") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))




```

## Observed LL vs predicted LL

Note: Light and site effects were not included in this model.

```{r, echo = F, message = F}

my_breaks <- function(...){
  c(0.002, 0.005, 0.02, 0.05, 0.1, 0.2,  0.5, 1, 2, 5, 10, 20, 50, 100, 200, 500)
}


ggplot(PA, aes(x = LL, y = preLL, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  xlab("obsLL") +
  ylab("preLL") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  geom_abline(aes(slope = 1, intercept = 0), 
              lty = 2, 
              lwd = 0.25, 
              col = "gray20") +
  scale_x_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(PA$LL), max(PA$LL))) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0), 
                limits = c(min(PA$LL), max(PA$LL))) +
  coord_fixed()
cor.test(log(PA$LL), log(PA$preLL))



```

## Cell~area~, Cell~vol~ (= cellulose density), N~area~, P~area~

```{r, echo = F, message = F}
ggplot(PA2, aes(x = val, y = val3, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  facet_grid(trait2 ~ LMA, scale = "free") +
  xlab("LMA and LD") +
  ylab("Traits") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))
```

## LMAp vs LMAs

```{r, echo = F, message = F}
ggplot(PA, aes(x = LMAp, y = LMAs, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  xlab("LMAm") +
  ylab("LMAs") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))
```

## Trait means

The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}

ggplot(PA2 %>% filter(LMA != "LDs"), aes(x = site_strata, y = val,
                                         fill = site_strata,
                                         col = site_strata)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))


```


## Trait means

The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}


ggplot(PA2 %>% filter(LMA != "LDs"), aes(x = site_strata, y = val,
                                         fill = site_strata,
                                         col = site_strata)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))

```

# Pairwise cor for all randomized data

```{r}
get_PA <- function(x) {
  summary_PA_LDL <- rand_res$summary[[x]]

  PA <- dat %>%
    as_tibble %>%
    mutate(LMA = rand_res$data[[x]]$LMA) %>%
    mutate(Aarea = rand_res$data[[x]]$A) %>%
    mutate(Rarea = rand_res$data[[x]]$R) %>%
    mutate(site2 = ifelse(site == "PNM", "DRY", "WET")) %>%
    mutate(sp_site_strata = paste(sp, site2, strata, sep = "_")) %>%
    mutate(site_strata = paste(site2, strata, sep = "_"))

  P_vec <- paste("p[", 1:nrow(PA), "]", sep = "")
#mu2_vec <- paste("mu2[", 1:nrow(PA), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(PA), ",2]", sep = "")
  temp_LMAp <- summary_PA_LDL[P_vec, "mean"] * PA$LMA
  temp_LMAs <- PA$LMA - temp_LMAp
#temp_LL <- exp(summary_PA_LDL[mu2_vec, "mean"])

  Mu_mcmc <- extract(rand_res$model[[x]], pars = "Mu")[[1]] 

  preLL <- Mu_mcmc[,,2] %>% apply(., 2, median) %>% exp

  PA <- PA %>%
    mutate(LMAp = temp_LMAp) %>%
    mutate(LMAs = temp_LMAs) %>%
    mutate(preLL = preLL) 

}

PA_list <- 1:9 %>%
  map(get_PA)

rand_nd <- tibble(rand = 1:9) %>%
  mutate(data = PA_list)

rand_nd %>%
  mutate(LL_LMAs = map_dbl(data, ~ cor(.$LL, .$LMAs))) %>%
  mutate(LL_LMAp = map_dbl(data, ~ cor(.$LL, .$LMAp))) %>%
  mutate(LL_preLL = map_dbl(data, ~ cor(.$LL, .$preLL))) %>%
  mutate(Aarea_LMAs = map_dbl(data, ~ cor(.$Aarea, .$LMAs))) %>%
  mutate(Aarea_LMAp = map_dbl(data, ~ cor(.$Aarea, .$LMAp))) %>%
  mutate(Rarea_LMAs = map_dbl(data, ~ cor(.$Rarea, .$LMAs))) %>%
  mutate(Rarea_LMAp = map_dbl(data, ~ cor(.$Rarea, .$LMAp))) 

```
