---
title: Panama results using MVN (Kikuzawa model)
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      message=FALSE)
```


```{r, echo = T, message = F}
library(loo)
library(rstan)
library(dplyr)
library(scales)
library(memisc)
library(plot3D)
library(modeler)
library(cowplot)

settings <- yaml::yaml.load_file("../settings.yml")
#r_vals <- yaml::yaml.load_file("../r_val.yml")
p_letters <- yaml::yaml.load_file("../letters.yml")
source("../fig_theme.r")


```


```{r, cache=TRUE, comment=NA}

#load("./data/PA_latent_model_light_more_obs.rda")
load("../data/GL_latent_model_orderd_obs.rda")

GL_summary <- data.frame(summary(res)$summary) %>%
  round(3)
DT::datatable(GL_summary)
GL <- dat
P_vec <- paste("p[", 1:nrow(GL), "]" ,sep = "")

GL <- GL %>%
  mutate(DE = ifelse(GL$DE == "", "U", as.character(DE))) 

#mu2_vec <- paste("mu2[", 1:nrow(GL), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(GL), ",2]", sep = "")
temp_LMAp <- GL_summary[P_vec, "mean"] * GL$LMA
temp_LMAs <- GL$LMA - temp_LMAp
#temp_LL <- exp(GL_summary[mu2_vec, "mean"])

GL <- GL %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs) 

```


# Fig. 1 

## GL ver.

```{r, cache=TRUE, comment=NA}

theme_set(theme_LES() +
          theme(axis.text.x = element_text(size = 6),
                axis.text.y = element_text(size = 6),
                axis.title = element_text(size = 6),
                axis.ticks.length = unit(-0.1, "cm"),
                axis.title.y = element_text(margin = margin(t = 0,
                                                            b = 0,
                                                            l = -5,
                                                            r = 0)),
                axis.title.x = element_text(margin = margin(t = 0,
                                                            b = -5,
                                                            l = -5,
                                                            r = -5)),
                ))



p1 <- ggplot(GL, aes(LMAp, LMAs)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(LMAm~(g~m^{-2}))) +
  ylab(expression(LMAs~(g~m^{-2}))) 

p2 <- ggplot(GL, aes(LMA, Aarea)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(Total~LMA~(g~m^{-2}))) +
  ylab(expression(italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})))

p3 <- ggplot(GL, aes(LMA, y = Aarea / LMA)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(Total~LMA~(g~m^{-2}))) +
  ylab(expression(italic(A)[mass]~(~mu~mol~g^{-1}~s^{-1})))

p4 <- plot_grid(p1, p2, p3, ncol = 3,
          labels = c("A", "B", "C"),
          label_size = 9) 

my_ggsave("../figs/fig_h.png", p4,
          height = 4)

cor.test(log(GL$LMAp), log(GL$LMAs))

#fig1 <- ggdraw() +
#  draw_plot(p1, 0, 0, 0.33, 1) +
#  draw_plot(p2, 0.33, 0, 0.66, 1) +
#  draw_plot(p3, 0.66, 0, 1, 1) +
#  draw_plot_label(c("A", "B", "C"),
#                  c(0, 0.33, 0.66), 
#                  c(1, 1, 1), size = 9)


```

##  hypo. ver.

```{r, cache=TRUE, comment=NA}

set.seed(12)
N <- 200
LMAp <- rlnorm(N, log(40), 0.1)
LMAs <- rlnorm(N, log(80), 0.8)
LMA <- LMAp + LMAs
#Aarea <- rlnorm(N, log(LMAp^0.8*LMAs^-0.2), 0.3)
Aarea <-  LMAp
tmp <- data_frame(LMA, LMAp, LMAs, Aarea)

p1 <- ggplot(tmp, aes(LMAp, LMAs)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(LMAm~(g~m^{-2}))) +
  ylab(expression(LMAs~(g~m^{-2}))) 

p2 <- ggplot(tmp, aes(LMA, Aarea)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(Total~LMA~(g~m^{-2}))) +
  ylab(expression(italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})))

p3 <- ggplot(tmp, aes(LMA, y = Aarea / LMA)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(Total~LMA~(g~m^{-2}))) +
  ylab(expression(italic(A)[mass]~(~mu~mol~g^{-1}~s^{-1})))

p4 <- plot_grid(p1, p2, p3, ncol = 3,
          labels = c("A", "B", "C"),
          label_size = 9) 

my_ggsave("../figs/fig_h2.png", p4,
          height = 4)

```

##  hypo. ver.2

using $\alpha_s < 0$


```{r, cache=TRUE, comment=NA}

set.seed(12)
N <- 200
LMAp <- rlnorm(N, log(80), 0.7)
LMAs <- rlnorm(N, log(80), 0.8)
LMA <- LMAp + LMAs
Aarea <- rlnorm(N, log(1.9 * LMAp^0.35*LMAs^-0.24), 0.3)
tmp <- data_frame(LMA, LMAp, LMAs, Aarea)

p1 <- ggplot(tmp, aes(LMAp, LMAs)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(LMAm~(g~m^{-2}))) +
  ylab(expression(LMAs~(g~m^{-2}))) 

p2 <- ggplot(tmp, aes(LMA, Aarea)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(Total~LMA~(g~m^{-2}))) +
  ylab(expression(italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})))

p3 <- ggplot(tmp, aes(LMA, y = Aarea / LMA)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(Total~LMA~(g~m^{-2}))) +
  ylab(expression(italic(A)[mass]~(~mu~mol~g^{-1}~s^{-1})))

p4 <- plot_grid(p1, p2, p3, ncol = 3,
          labels = c("A", "B", "C"),
          label_size = 9) 

my_ggsave("../figs/fig_h3.png", p4,
          height = 4)

```

##  hypo. ver.3

using $\alpha_s < 0$


```{r, cache=TRUE, comment=NA}

set.seed(12)
N <- 200
LMAp <- rlnorm(N, log(80), 0.7)
LMAs <- rlnorm(N, 0.5 * log(LMAp) * 1.9, 0.8)
LMA <- LMAp + LMAs
Aarea <- rlnorm(N, log(1.9 * LMAp^0.35*LMAs^-0.24), 0.3)
tmp <- data_frame(LMA, LMAp, LMAs, Aarea)

p1 <- ggplot(tmp, aes(LMAp, LMAs)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(LMAm~(g~m^{-2}))) +
  ylab(expression(LMAs~(g~m^{-2}))) 

p2 <- ggplot(tmp, aes(LMA, Aarea)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(Total~LMA~(g~m^{-2}))) +
  ylab(expression(italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})))

p3 <- ggplot(tmp, aes(LMA, y = Aarea / LMA)) +
  geom_point(alpha = 0.8) +
  scale_x_log10() +
  scale_y_log10() +
  xlab(expression(Total~LMA~(g~m^{-2}))) +
  ylab(expression(italic(A)[mass]~(~mu~mol~g^{-1}~s^{-1})))

p4 <- plot_grid(p1, p2, p3, ncol = 3,
          labels = c("A", "B", "C"),
          label_size = 9) 

my_ggsave("../figs/fig_h4.png", p4,
          height = 4)

```


```{r, cache=TRUE, comment=NA}
n <- 40
x_pred <- seq(min(GL$LMAp), max(GL$LMAp), length = n)
y_pred <- seq(min(GL$LMAs), max(GL$LMAs), length = n)
xy <- expand.grid(x = x_pred, y = y_pred)

z_pred <- matrix(exp(2.69)* xy$x^0.365 * xy$y^(-0.3),
                 nrow = n, ncol=n)

scatter3D(GL$LMAp, GL$LMAs, GL$Aarea,
          surf = list(x = x_pred, y = y_pred, z = z_pred,
                      facets = NA),
          theta = -35,
          phi = 20)


n <- 20

x_pred <- seq(min(log(GL$LMAp)), max(log(GL$LMAp)), length = n)
y_pred <- seq(min(log(GL$LMAs)), max(log(GL$LMAs)), length = n)
xy <- expand.grid(x = x_pred, y = y_pred)

z_pred <- matrix(1.92 + 0.356*xy$x -0.24 *xy$y,
                 nrow = n, ncol=n)


scatter3D(log(GL$LMAp), log(GL$LMAs), log(GL$Aarea),
          bty = "b2",
          surf = list(x = x_pred, y = y_pred, z = z_pred, 
                      facets = NA),
          theta = 35,
          phi = 30)

scatter3D_fancy <- function(x, y, z,..., colvar = z)
  {
   panelfirst <- function(pmat) {
      XY <- trans3D(x, y, z = rep(min(z), length(z)), pmat = pmat)
      scatter2D(XY$x, XY$y, colvar = colvar, pch = 16, 
              cex = 0.8, add = TRUE, colkey = FALSE, col = "gray")
   
      XY <- trans3D(x = rep(min(x), length(x)), y, z, pmat = pmat)
      scatter2D(XY$x, XY$y, colvar = colvar, pch = 16, 
              cex = 0.8, add = TRUE, colkey = FALSE, col = "gray")

      XY <- trans3D(y = rep(min(y), length(y)), x, z, pmat = pmat)
      scatter2D(XY$x, XY$y, colvar = colvar, pch = 16, 
              cex = 0.8, add = TRUE, colkey = FALSE, col = "gray")
  }
  scatter3D(x, y, z, ..., colvar = NULL, panel.first=panelfirst,
    colkey = list(length = 0.5, width = 0.5, cex.clab = 0.75)) 
}


A_plt <- scatter3D_fancy(log(GL$LMAp), log(GL$LMAs), log(GL$Aarea),
          bty = "b2",
          groups = GL$DE,
          #surf = list(x = x_pred, y = y_pred, z = z_pred, 
          #            facets = NA),
          #col = cols2,
          xlab = "LMAm",
          ylab = "LMAs",
          zlab = "Aarea",
          pch = 16,
          theta = 130,
          phi = 30)

LL_plt <- scatter3D_fancy(log(GL$LMAp), log(GL$LMAs), log(GL$LL),
          bty = "b2",
          groups = GL$DE,
          #surf = list(x = x_pred, y = y_pred, z = z_pred, 
          #            facets = NA),
          xlab = paste("LMAm~(~g~m^{-2})"),
          ylab = "LMAs",
          zlab = "LL",
          pch = 16,
          theta = 120,
          phi = 20)

R_plt <- scatter3D_fancy(log(GL$LMAp), log(GL$LMAs), log(GL$Rarea),
          bty = "b2",
          groups = GL$DE,
          #surf = list(x = x_pred, y = y_pred, z = z_pred, 
          #            facets = NA),
          xlab = paste("LMAm~(~g~m^{-2})"),
          ylab = "LMAs",
          zlab = "Rarea",
          pch = 16,
          theta = 130,
          phi = 20)


```


```{r, eval = F}
scatter3D_fancy(log(GL$LMAp), log(GL$LMAs), log(GL$Aarea),
          bty = "b2",
          groups = GL$DE,
          #surf = list(x = x_pred, y = y_pred, z = z_pred, 
          #            facets = NA),
          col = cols2,
          pch = 16,
          theta = 130,
          phi = 20)

scatter3D_fancy(data = GL,
          Aarea ~ LMAp + LAMs,
          bty = "b2",
          #surf = list(x = x_pred, y = y_pred, z = z_pred, 
          #            facets = NA),
          theta = 130,
          phi = 20)


fills <- c("Deciduous" = settings$fills$D,
          "Evergreen" = settings$fills$E,
          "Unclassified" = settings$fills$U)

cols <- c("Deciduous" = settings$colors$D,
          "Evergreen" = settings$colors$E,
          "Unclassified" = settings$colors$U)

cols2 <- cols[as.factor(GL$DE)]
names(cols2) <- NULL
fills2 <- fills[as.factor(GL$DE)]
names(fills2) <- NULL

s3d <- scatterplot3d(data.frame(log(GL$LMAp), log(GL$LMAs), log(GL$Aarea)),
              color = cols2,
              bg = fills2,
              pch = 21,
              angle = 80)

s3d$plane3d(x_pred, y_pred, z_pred)

moge <- trans3D(GL$LMAp, GL$LMAs, z = rep(min(GL$Aarea), length(GL$Aarea)))


ggplot(GL, aes(x = LMA, y = Aarea)) +
  geom_point() +
  stat_smooth(method="lm") +
  scale_x_log10()+
  scale_y_log10()

scatter3d(x = sep.l, y = pet.l, z = sep.w)

n <- 20
x_pred <- seq(min(log(GL$LMAp)), max(log(GL$LMAp)), length = n)
y_pred <- seq(min(log(GL$LMAs)), max(log(GL$LMAs)), length = n)
xy <- expand.grid(x = x_pred, y = y_pred)

z_pred <- matrix(1.92 + 0.356*xy$x -0.24 *xy$y,
                 nrow = n, ncol=n)

GL_plt <- plot_ly(data = GL,
        x = ~log(LMAp),
        y = ~log(LMAs),
        z = ~log(Rarea),
        type = "scatter3d",
        color = ~DE,
        colors = "Set2",
        mode = "markers"
        )
GL_plt

GL_plt %>%
  export(file = "filename.svg",
         selenium = RSelenium::rsDriver(browser = "chrome"))

GL_plt2 <- add_trace(p = GL_plt,
                    x = x_pred,
                    y = y_pred,
                    z = z_pred %>% t,
                    type = "surface")
GL_plt2

```

```{r, eval = F}

set.seed(123)
xx <- rnorm(100)
yy <- rnorm(100)

dat <- data_frame(xx,yy)

library(rstanarm)

hoge <- stan_glm(yy ~ xx, data = dat)

fits <- hoge %>% 
  as_data_frame %>% 
  dplyr::select(-sigma)
names(fits) <- c("intercept", "xx")

n_draws <- 500
alpha_level <- .15
col_draw <- "grey60"
col_median <-  "#3366FF"

ggplot(dat) + 
  aes(x = xx, y = yy) + 
  # Plot a random sample of rows as gray semi-transparent lines
  geom_abline(aes(intercept = intercept, slope = xx), 
              data = sample_n(fits, n_draws), color = col_draw, 
              alpha = alpha_level) + 
  # Plot the median values in blue
  geom_abline(intercept = median(fits$intercept), 
              slope = median(fits$xx), 
              size = 1, color = col_median) +
  geom_point() 


```


```{r}




moge <- glm(log(LL) ~ log(LMAp) + log(LMAs), GL, family = gaussian)
summary(moge)

#partial_plot(moge, "LMAp")


rho12 <- cor(log(GL$LMAp), log(GL$LMAs))
rho23 <- cor(log(GL$LMAp), log(GL$Aarea))
rho13 <- cor(log(GL$Aarea), log(GL$LMAs))

(rho23 - rho12 * rho13) / (sqrt(1-rho12^2)  * sqrt(1-rho13^2))
(rho13 - rho12 * rho23) / (sqrt(1-rho12^2)  * sqrt(1-rho23^2))


fit1 <- lm(log(LMAp) ~ log(LMAs), GL)
LMAm_res <- residuals(fit1)
LLm_res <- lm(log(LL) ~ log(LMAs), GL) %>% residuals
cor.test(log(GL$Aarea), (LMAm_res))


fit2 <- lm(log(LMAs) ~ log(LMAp), GL)
LMAs_res <- residuals(fit2)
LLs_res <- lm(log(LL) ~ log(LMAp), GL) %>% residuals
cor.test(log(GL$Aarea), (LMAs_res))

plot(LMAm_res, log(GL$LL))
plot(LMAs_res, log(GL$LL))

par(mfrow=c(2,2))
plot(LL ~ LMAs, GL, log = "xy")
plot(LMAm_res, LLm_res)
plot(LL ~ LMAp, GL, log = "xy")
plot(LMAs_res, LLs_res)
par(mfrow=c(2,2))


pmat <- extract(res, "p")[[1]]

i <- 1
N <- 4000
r1 <- numeric(N)
r2 <- numeric(N)
for (i in 1:N) {
  LMAp <- pmat[i,] * GL$LMA
  LMAs <- GL$LMA - LMAp
  fit1 <- lm(log(LMAs) ~ log(LMAp))
  fit2 <- lm(log(LMAp) ~ log(LMAs))
  fit3 <- lm(log(GL$LL) ~ log(LMAp))
  fit4 <- lm(log(GL$LL) ~ log(LMAs))

  LMAm_res <- residuals(fit1)
  LMAs_res <- residuals(fit2)
  LMAm_res2 <- residuals(fit3)
  LMAs_res2 <- residuals(fit4)
  r1[i] <- cor(LMAm_res2, LMAm_res) # Aarea-LMAs
  r2[i] <- cor(LMAs_res2, LMAs_res) # Aarea-LMAm
}

cor.test(log(GL$LL), log(GL$LMA))

quantile(r1, 0.5)
quantile(r1, 0.025)
quantile(r1, 0.975)

quantile(r2, 0.5)
quantile(r2, 0.025)
quantile(r2, 0.975)


```

```{r}
before <- proc.time()
N <- 4000
r_As <- numeric(N)
r_Am <- r_Rs <- r_Rm <- r_Lm <- r_Ls <- r_As
for (i in 1:N) {
  LMAp <- pmat[i,] * GL$LMA
  LMAs <- GL$LMA - LMAp

  fit_m <- lm(log(LMAs) ~ log(LMAp))
  fit_s <- lm(log(LMAp) ~ log(LMAs))
  fit_Am <- lm(log(GL$Aarea) ~ log(LMAp))
  fit_As <- lm(log(GL$Aarea) ~ log(LMAs))
  fit_Rm <- lm(log(GL$Rarea) ~ log(LMAp))
  fit_Rs <- lm(log(GL$Rarea) ~ log(LMAs))
  fit_Lm <- lm(log(GL$LL) ~ log(LMAp))
  fit_Ls <- lm(log(GL$LL) ~ log(LMAs))

  res_m  <- residuals(fit_m)
  res_s  <- residuals(fit_s)
  res_Am  <- residuals(fit_Am)
  res_As  <- residuals(fit_As)
  res_Rm  <- residuals(fit_Rm)
  res_Rs  <- residuals(fit_Rs)
  res_Lm  <- residuals(fit_Lm)
  res_Ls  <- residuals(fit_Ls)

  r_Am[i] <- cor(res_s, res_As) # Aarea-LMAm
  r_As[i] <- cor(res_m, res_Am) # Aarea-LMAs
  r_Rm[i] <- cor(res_s, res_Rs) #
  r_Rs[i] <- cor(res_m, res_Rm) #
  r_Lm[i] <- cor(res_s, res_Ls) #
  r_Ls[i] <- cor(res_m, res_Lm) #
}

after <- proc.time()
after - before

quant_fun <- function(x) c(quantile(x, 0.5), quantile(x, 0.025), quantile(x, 0.975))

GL_cor_tbl <- rbind(
  quant_fun(r_Am),
  quant_fun(r_As),
  quant_fun(r_Rm),
  quant_fun(r_Rs),
  quant_fun(r_Lm),
  quant_fun(r_Ls)) %>%
  as_data_frame


```

```{r, cache=TRUE, comment=NA}
N <- 4000

moge_fun <- function(i) {
  r_As <- numeric(N)
  for (i in 1:N) {
    LMAp <- pmat[i,] * GL$LMA
    LMAs <- GL$LMA - LMAp
    fit_m <- lm(log(LMAs) ~ log(LMAp))
    fit_Am <- lm(log(GL$Aarea) ~ log(LMAp))
    res_m  <- residuals(fit_m)
    res_Am  <- residuals(fit_Am)
    r_As[i] <- cor(res_m, res_Am) # Aarea-LMAs
  }
  r_As
}

system.time(aa <- moge_fun(N))

moge_fun2 <- function(i) {
    LMAp <- pmat[i,] * GL$LMA
    LMAs <- GL$LMA - LMAp
    fit_m <- lm(log(LMAs) ~ log(LMAp))
    fit_Am <- lm(log(GL$Aarea) ~ log(LMAp))
    res_m  <- residuals(fit_m)
    res_Am  <- residuals(fit_Am)
    cor(res_m, res_Am) # Aarea-LMAs
}

system.time(bb <- sapply(1:N, moge_fun2))


LMAp_mat <- apply(pmat, 1, function(x){GL$LMA * x}) %>% t
LMAs_mat <- apply(LMAp_mat, 1, function(x){GL$LMA - x}) %>% t

plot(LMAp_mat[i,], LMAp)
plot(LMAs_mat[i,], LMAs)

moge_fun3 <- function(i) {
    fit_m <- lm(log(LMAs_mat[i,]) ~ log(LMAp_mat[i,]))
    fit_Am <- lm(log(GL$Aarea) ~ log(LMAp_mat[i,]))
    res_m  <- residuals(fit_m)
    res_Am  <- residuals(fit_Am)
     cor(res_m, res_Am) # Aarea-LMAs
}

system.time(bb2 <- sapply(1:N, moge_fun3))

system.time(aa2 <- moge_fun3(N))
plot(aa, bb2)


LMA_m_fun <- function(i) {
    fit_m <- lm(log(LMAs_mat[i,]) ~ log(LMAp_mat[i,]))
    residuals(fit_m)
}

LMA_s_fun <- function(i) {
    fit_m <- lm(log(LMAp_mat[i,]) ~ log(LMAs_mat[i,]))
    residuals(fit_m)
}

res_fun <- function(i, LMA, trait) {
    fit_m <- lm(log(trait) ~ log(LMA[i,]))
    residuals(fit_m)
}

res_fun2 <- function(N, LMA, trait){
  sapply(1:N, res_fun, LMA, trait) %>%
    apply(., 1, median)
}

before <- proc.time()

GL2 <- GL %>%
  mutate(res_m = sapply(1:N, LMA_m_fun) %>% apply(., 1, median)) %>%
  mutate(res_s = sapply(1:N, LMA_s_fun) %>% apply(., 1, median)) %>%
  mutate(Aarea_s = res_fun2(N, LMAs_mat, GL$Aarea)) %>%
  mutate(Aarea_m = res_fun2(N, LMAp_mat, GL$Aarea)) %>%
  mutate(Rarea_s = res_fun2(N, LMAs_mat, GL$Rarea)) %>%
  mutate(Rarea_m = res_fun2(N, LMAp_mat, GL$Rarea)) %>%
  mutate(LL_s = res_fun2(N, LMAs_mat, GL$LL)) %>%
  mutate(LL_m = res_fun2(N, LMAp_mat, GL$LL))

after <- proc.time()
after - before

par(mfrow = c(2,2))
plot(LL_s ~ res_s, GL2)
plot(LL_m ~ res_m, GL2)
par(mfrow = c(1,1))

fills <- c("Deciduous" = settings$fills$D,
          "Evergreen" = settings$fills$E,
          "Unclassified" = settings$fills$U)

cols <- c("Deciduous" = settings$colors$D,
          "Evergreen" = settings$colors$E,
          "Unclassified" = settings$colors$U)


```{r, cache=TRUE, comment=NA}

GL_fig_dat <- GL %>%
  gather(Trait, val2, c(Aarea, Rarea, LL)) %>%
  mutate(DE = factor(DE,
          levels = c("D", "E", "U"))) %>%
  mutate(gr = factor(DE,
          labels = c("Deciduous", "Evergreen", "Unclassified"))) %>%
  mutate(Trait = factor(Trait,
    levels = c("Aarea", "Rarea", "LL"))) %>%
  mutate(Trait2 = factor(Trait,
    labels = c("italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "italic(R)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "LL~(months)"))) %>%
  mutate(LMA2 = "LMA~(~g~m^{-2})")

GL_fig_dat2 <- GL2 %>%
  gather(resLMA, val, c(res_m, res_s)) %>%
  gather(resTrait, val2, c(Aarea_s, Rarea_s, LL_s,
                           Aarea_m, Rarea_m, LL_m)) %>%
  mutate(tmp1 = str_split(resLMA, "_") %>% sapply(., "[[", 2)) %>%
  mutate(tmp2 = str_split(resTrait, "_") %>% sapply(., "[[", 2)) %>%
  mutate(resTrait2 = str_split(resTrait, "_") %>% sapply(., "[[", 1)) %>%
  filter(tmp1 == tmp2) %>%
  dplyr::select(resLMA, resTrait, resTrait2, val, val2, DE) %>%
  mutate(DE = factor(DE,
          levels = c("D", "E", "U"))) %>%
  mutate(gr = factor(DE,
          labels = c("Deciduous", "Evergreen", "Unclassified"))) %>%
  mutate(resLMA = factor(resLMA,
         levels = c("res_s", "res_m"))) %>%
  #mutate(resLMA = factor(resLMA,
  #  labels = c("LMAm~residuals", "LMAs~residuals~(~g~m^{-2})"))) %>%
  mutate(resLMA = factor(resLMA,
    labels = c("LMAm residuals", "LMAs residuals"))) %>%
  mutate(resTrait2 = factor(resTrait2,
                            levels = c("Aarea", "Rarea", "LL"))) %>%
  mutate(resTrait2 = factor(resTrait2,
    labels = c("italic(A)[area]~residuals",
               "italic(R)[area]~residuals",
               "LL~residuals"))) 


GL_figA <- ggplot(GL_fig_dat, aes(x = LMA, y = val2,
                                  col = gr,
                                  fill = gr)) +
  geom_point(shape = 21) +
  facet_grid(Trait2 ~ LMA2,
             scales = "free",
             switch = "both", 
             labeller = labeller(Trait2 = label_parsed,
                                 LMA2 = label_parsed)) +
  scale_colour_manual(values = cols) +
  scale_fill_manual(values = fills) +
  scale_x_log10(breaks = my_breaks_x(), expand = c(0.1, 0)) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0)) +
  xlab("") +
  ylab("") +
  theme_LES() 

GL_figA2 <- GL_figA +
  theme(legend.position = "none")
  #theme(legend.text = element_blank(),
  #      legend.key = element_rect(fill = NULL, colour = NULL)
  #      )

GL_figA2

GL_figB <- ggplot(GL_fig_dat2, aes(x = val, y = val2,
                       color = gr, fill = gr)) +
  geom_point(shape = 21) +
  scale_fill_manual(values = fills) +
  scale_color_manual(values = cols) +
  facet_grid(resTrait2~resLMA,
             switch = "both",
             scale = "free",
             labeller = labeller(resTrait2 = label_parsed#,
                                 #resLMA = label_parsed
             )) +
  xlab("") +
  ylab("") +
  theme_LES() +
  theme(legend.position = "none")

legend2 <- get_legend(GL_figA)

fig2 <- ggdraw() +
  draw_plot(GL_figA, 0, 0, 0.33, 1) +
  draw_plot(GL_figB, 0.33, 0, 0.66, 1) +
  draw_plot_label(c("A", "B"), c(0, 0.33), c(1,1), size = 9)

fig2

fig3 <- plot_grid(GL_figA2, GL_figB,
                  labels = c("A", "B"),
                  label_size = 9,
                  rel_widths = c(0.59, 1))

fig4 <- plot_grid(legend2, fig3,  ncol = 1,
                  rel_heights = c(.1, 2))
fig4

my_ggsave("../figs/GL_2.png", fig4)


```


# Panama

```{r, cache=TRUE, comment=NA}
load("../data/PA_latent_replusive_model_light2_more_obs.rda")

summary_PA_LDL <- data.frame(summary(res)$summary)

PA <- dat %>%
  as_data_frame %>%
  mutate(site2 = ifelse(site == "PNM", "DRY", "WET")) %>%
  mutate(sp_site_strata = paste(sp, site2, strata, sep = "_")) %>%
  mutate(site_strata = paste(site2, strata, sep = "_"))

P_vec <- paste("p[", 1:nrow(PA), "]", sep = "")
#mu2_vec <- paste("mu2[", 1:nrow(PA), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(PA), ",2]", sep = "")
temp_LMAp <- summary_PA_LDL[P_vec, "mean"] * PA$LMA
temp_LMAs <- PA$LMA - temp_LMAp
#temp_LL <- exp(summary_PA_LDL[mu2_vec, "mean"])

PA <- PA %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs) 

```

```{r}

pmat <- extract(res, "p")[[1]]
before <- proc.time()
N <- 4000
r_As <- numeric(N)
r_Am <- r_Rs <- r_Rm <- r_Lm <- r_Ls <- r_As
for (i in 1:N) {
  LMAp <- pmat[i,] * PA$LMA
  LMAs <- PA$LMA - LMAp

  fit_sm <- lm(log(LMAs) ~ log(LMAp))
  fit_ms <- lm(log(LMAp) ~ log(LMAs))
  fit_Am <- lm(log(PA$Aarea) ~ log(LMAp))
  fit_As <- lm(log(PA$Aarea) ~ log(LMAs))
  fit_Rm <- lm(log(PA$Rarea) ~ log(LMAp))
  fit_Rs <- lm(log(PA$Rarea) ~ log(LMAs))
  fit_Lm <- lm(log(PA$LL) ~ log(LMAp))
  fit_Ls <- lm(log(PA$LL) ~ log(LMAs))

  res_sm  <- residuals(fit_sm)
  res_ms  <- residuals(fit_ms)
  res_Am  <- residuals(fit_Am)
  res_As  <- residuals(fit_As)
  res_Rm  <- residuals(fit_Rm)
  res_Rs  <- residuals(fit_Rs)
  res_Lm  <- residuals(fit_Lm)
  res_Ls  <- residuals(fit_Ls)

  r_Am[i] <- cor(res_ms, res_As) # Aarea-LMAm
  r_As[i] <- cor(res_sm, res_Am) # Aarea-LMAs
  r_Rm[i] <- cor(res_ms, res_Rs) #
  r_Rs[i] <- cor(res_sm, res_Rm) #
  r_Lm[i] <- cor(res_ms, res_Ls) #
  r_Ls[i] <- cor(res_sm, res_Lm) #
}

after <- proc.time()
after - before

rbind(
  quant_fun(r_Am),
  quant_fun(r_As),
  quant_fun(r_Rm),
  quant_fun(r_Rs),
  quant_fun(r_Lm),
  quant_fun(r_Ls)) %>%
  as_data_frame

```


```{r, cache=TRUE, comment=NA}

pmat <- extract(res, "p")[[1]]
LMAp_mat <- apply(pmat, 1, function(x){PA$LMA * x}) %>% t
LMAs_mat <- apply(LMAp_mat, 1, function(x){PA$LMA - x}) %>% t

LMA_m_fun <- function(i) {
    fit_m <- lm(log(LMAs_mat[i,]) ~ log(LMAp_mat[i,]) + PA$strata)
    residuals(fit_m)
}

LMA_s_fun <- function(i) {
    fit_m <- lm(log(LMAp_mat[i,]) ~ log(LMAs_mat[i,]) + PA$strata)
    #fit_m <- lm(log(LMAp_mat[i,]) ~ log(LMAs_mat[i,]))
    residuals(fit_m)
}

res_fun <- function(i, LMA, trait) {
    fit_m <- lm(log(trait) ~ log(LMA[i,]) + PA$strata)
    #fit_m <- lm(log(trait) ~ log(LMA[i,]))
    residuals(fit_m)
}

res_fun2 <- function(N, LMA, trait){
  sapply(1:N, res_fun, LMA, trait) %>%
    apply(., 1, median)
}

before <- proc.time()
PA2 <- PA %>%
  mutate(res_m = sapply(1:N, LMA_m_fun) %>% apply(., 1, median)) %>%
  mutate(res_s = sapply(1:N, LMA_s_fun) %>% apply(., 1, median)) %>%
  mutate(Aarea_s = res_fun2(N, LMAs_mat, PA$Aarea)) %>%
  mutate(Aarea_m = res_fun2(N, LMAp_mat, PA$Aarea)) %>%
  mutate(Rarea_s = res_fun2(N, LMAs_mat, PA$Rarea)) %>%
  mutate(Rarea_m = res_fun2(N, LMAp_mat, PA$Rarea)) %>%
  mutate(LL_s = res_fun2(N, LMAs_mat, PA$LL)) %>%
  mutate(LL_m = res_fun2(N, LMAp_mat, PA$LL))

after <- proc.time()
after - before

par(mfrow = c(2,2))
plot(LL_s ~ res_s, PA2)
plot(LL_m ~ res_m, PA2)
par(mfrow = c(1,1))

PA_fig_dat <- PA %>%
  gather(Trait, val2, c(Aarea, Rarea, LL)) %>%
  mutate(site_strata = factor(site_strata,
          levels = c("WET_CAN", "DRY_CAN", "WET_UNDER", "DRY_UNDER"))) %>%
  mutate(gr = factor(site_strata,
    labels = c("Sun-Wet",
               "Sun-Dry",
               "Shade-Wet",
               "Shade-Dry"
                      ))) %>%
  mutate(Trait = factor(Trait,
    levels = c("Aarea", "Rarea", "LL"))) %>%
  mutate(Trait2 = factor(Trait,
    labels = c("italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "italic(R)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "LL~(months)"))) %>%
  mutate(LMA2 = "LMA~(~g~m^{-2})")

PA_fig_dat2 <- PA2 %>%
  gather(resLMA, val, c(res_m, res_s)) %>%
  gather(resTrait, val2, c(Aarea_s, Rarea_s, LL_s,
                           Aarea_m, Rarea_m, LL_m)) %>%
  mutate(tmp1 = str_split(resLMA, "_") %>% sapply(., "[[", 2)) %>%
  mutate(tmp2 = str_split(resTrait, "_") %>% sapply(., "[[", 2)) %>%
  mutate(resTrait2 = str_split(resTrait, "_") %>% sapply(., "[[", 1)) %>%
  filter(tmp1 == tmp2) %>%
  mutate(site_strata = factor(site_strata,
          levels = c("WET_CAN", "DRY_CAN", "WET_UNDER", "DRY_UNDER"))) %>%
  mutate(gr = factor(site_strata,
    labels = c("Sun-Wet",
               "Sun-Dry",
               "Shade-Wet",
               "Shade-Dry"
                      ))) %>%
  mutate(resLMA = factor(resLMA,
         levels = c("res_s", "res_m"))) %>%
  mutate(resLMA = factor(resLMA,
    labels = c("LMAm~(~g~m^{-2})", "LMAs~(~g~m^{-2})"))) %>%
  mutate(resTrait2 = factor(resTrait2,
                            levels = c("Aarea", "Rarea", "LL"))) %>%
  mutate(resTrait2 = factor(resTrait2,
    labels = c("italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "italic(R)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "LL~(months)"))) 


fills <- c("Sun-Dry" = settings$fills$sun_dry,
          "Sun-Wet" = settings$fills$sun_wet,
          "Shade-Dry" = settings$fills$shade_dry,
          "Shade-Wet" = settings$fills$shade_wet)

cols <- c("Sun-Dry" = settings$colors$sun_dry,
          "Sun-Wet" = settings$colors$sun_wet,
          "Shade-Dry" = settings$colors$shade_dry,
          "Shade-Wet" = settings$colors$shade_wet)

PA_figA <- ggplot(PA_fig_dat, aes(x = LMA, y = val2,
                                  col = gr,
                                  fill = gr)) +
  geom_point(shape = 21) +
  facet_grid(Trait2 ~ LMA2,
             scales = "free",
             switch = "both", 
             labeller = labeller(Trait2 = label_parsed,
                                 LMA2 = label_parsed)) +
  scale_colour_manual(values = cols) +
  scale_fill_manual(values = fills) +
  scale_x_log10(breaks = my_breaks_x(), expand = c(0.1, 0)) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0)) +
  xlab("") +
  ylab("") +
  theme_LES() 

PA_figA2 <- PA_figA +
  theme(legend.position = "none")
  #theme(legend.text = element_blank(),
  #      legend.key = element_rect(fill = NULL, colour = NULL)
  #      )

PA_figA2


PA_figB <- ggplot(PA_fig_dat2, aes(x = val, y = val2,
                       color = gr, fill = gr)) +
  geom_point(shape = 21) +
  scale_fill_manual(values = fills) +
  scale_color_manual(values = cols) +
  facet_grid(resTrait2~resLMA,
             switch = "both",
             scale = "free",
             labeller = labeller(resTrait2 = label_parsed,
                                 resLMA = label_parsed
             )) +
  xlab("") +
  ylab("") +
  theme_LES() +
  theme(legend.position = "none")

legend2 <- get_legend(PA_figA)

fig3 <- plot_grid(PA_figA2, PA_figB,
                  labels = c("A", "B"),
                  label_size = 9,
                  rel_widths = c(0.5, 1))

fig4 <- plot_grid(legend2, fig3,  ncol = 1,
                  rel_heights = c(.1, 2))
fig4

my_ggsave("../figs/PA_2.png", fig4)


A_res <- lm(log(Aarea) ~ strata, PA) %>%
  residuals()
R_res <- lm(log(Rarea) ~ strata, PA) %>%
  residuals()
LL_res <- lm(log(LL) ~ strata, PA) %>%
  residuals()
LMA_res <- lm(log(LMA) ~ strata, PA) %>%
  residuals()

PA3  <- PA %>%
  mutate(A_res) %>%
  mutate(R_res) %>%
  mutate(LMA_res) %>%
  mutate(LL_res) 

PA_fig_dat3 <- PA3 %>%
  gather(resTrait, val2, c(A_res, R_res, LL_res)) %>%
  mutate(site_strata = factor(site_strata,
          levels = c("WET_CAN", "DRY_CAN", "WET_UNDER", "DRY_UNDER"))) %>%
  mutate(gr = factor(site_strata,
    labels = c("Sun-Wet",
               "Sun-Dry",
               "Shade-Wet",
               "Shade-Dry"
                      ))) %>%
  mutate(resTrait = factor(resTrait,
    levels = c("A_res", "R_res", "LL_res"))) %>%
  mutate(resTrait2 = factor(resTrait,
    labels = c("italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "italic(R)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "LL~(months)"))) %>%
  mutate(LMA2 = "LMA~(~g~m^{-2})")



PA_figA3 <- ggplot(PA_fig_dat3, aes(x = LMA_res, y = val2,
                                  col = gr,
                                  fill = gr)) +
  geom_point(shape = 21) +
  facet_grid(resTrait2 ~ LMA2,
             scales = "free",
             switch = "both", 
             labeller = labeller(resTrait2 = label_parsed,
                                 LMA2 = label_parsed)) +
  scale_colour_manual(values = cols) +
  scale_fill_manual(values = fills) +
  scale_x_log10(breaks = my_breaks_x(), expand = c(0.1, 0)) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0)) +
  xlab("") +
  ylab("") +
  theme_LES() 

PA_figA3


```



```{r, eval = F}
set.seed(123)
N <- 100
LMAm <- rlnorm(N, 2, 1)
LMAs <- rlnorm(N, 2, 2)

LMA <- LMAm + LMAs

LMAm2 <- LMAm^0.9
LMAs2 <- LMAs^ (-0.5)
LMA2 <- LMAm2 + LMAs2

var(LMAm)
var(LMAs)
var(LMA)

var(LMAm2)
var(LMAs2)
var(LMA2)

var(GL$LMAp)
var(GL$LMAs)
cov(GL$LMAs, GL$LMAp)
var(GL$LMA)

LMAp2 <- GL$LMAp^0.365
LMAs2 <- GL$LMAs^-0.24

var(LMAp2)
var(GL$LMA - LMAp2)
var(GL$LMA)

```

```{r, eval = F}

sun <- PA %>%
  filter(strata == "CAN")
shade <- PA %>%
  filter(strata == "UNDER")


LMAp <- sun$LMAp
LMAs <- sun$LMAs
LMA <- sun$LMA
LMAp2 <- sun$LMAp^0.63
LMAs2 <- sun$LMAs^0.14
var(LMAp)
var(LMAs)
var(LMA)

var(LMAp2)
var(LMAs2)
var(LMA)
var(LMA - LMAp2 - LMAs2)
var(LMAp2) / var(LMA)
var(LMAs2) / var(LMA)

as <- seq(-1, 0.2, length = 1000)
tmp <- NULL
for (i in 1:1000) tmp[i] <- var(PA$LMAs^as[i])
plot(as, tmp, type = "l")

tmp2 <- rlnorm(100)
var(tmp2)
var(0.5 * tmp2)

var(tmp2^0.99)
var(tmp2^0.5)
var(tmp2^0.1)

xx <- seq(-0.2, 0.5, length = 100)
yy <- 100 ^ xx
yy2 <- 20 ^ xx
yy3 <- 500 ^ xx
plot(xx, yy3, type = "l")
points(xx, yy2, type = "l", lty = 2)
points(xx, yy, type = "l", lty = 3)

var(LMAp2) + var(LMAs2) + var(LMA - LMAp2 - LMAs2) + 2 * cov(LMA, LMAp2) + 2 * cov(LMA, LMAs2) + 2 * cov(LMAp2, LMAs2)
var(LMA)

hist((LMAp2 + LMAs2) / LMA)

var(log(LMAp2))
var(log(LMAs2))
var(log(PA$LMA))

var(log(LMAp2)) + var(log(LMAs2)) + 2 * cov(LMAp2, LMAs2)

var(log(LMAp2 + LMAs2))
var(log(LMAp2)) + var(log(LMAs2)) + 2 * cov(log(LMAp2), log(LMAs2))

40^0.2 / 20^0.2

4^0.2 / 2^0.2


```
