---
title: Panama results
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
---

$$
\begin{aligned}
LMAm_i = f_i \times LMA_i \\
LMAs_i = (1-f_i) \times LMA_i
\end{aligned}
$$

$$
A_{area\ i} = \alpha_0 LMAm_{i}^{\alpha_m} LMAs_{i}^{\alpha_s} \\
LL_{i} = \beta_0 LMAm_{i}^{\beta_m} LMAs_{i}^{\beta_s} \\
R_{area\ i} = \gamma_0 LMAm_{i}^{\gamma_m} LMAs_{i}^{\gamma_s}
$$

$$
Z =
\begin{bmatrix}
\alpha_0 &\beta_0 &\gamma_0 \\
\alpha_m &\beta_m &\gamma_m \\
\alpha_s &\beta_s &\gamma_s \\
\end{bmatrix}
$$

$$
\begin{bmatrix}
1 &logLMA_i & logLMAs_{i} &Light_i
\end{bmatrix}
$$

$$
Mu = X \times Z
$$

Some parameters are exchangeable. For example, $[f_i, \ \alpha_m, \ \alpha_s]$ = [0.2, 0.5, 1.0] and [0.8, 1.0, 0.5] return the identical expected mean of $A~area~$. When the posterior distributions from different chains were symmetric (as above), I switched labels so that $\alpha_m$ > $\alpha_s$ (LMAm is associated with metabolic rates by our definition).

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```


```{r, echo = F, message = F}
library(loo)
library(rstan)
library(scales)
library(memisc)
library(tidyverse)
library(stringr)
library(lazyeval)
library(cowplot)
library(ggrepel)
library(ggthemes)

```

# Model code

```{r}
setwd("..")
getwd()

load("./data/PA_latent_repulsive_model_more_obs.rda")

get_stancode(res) %>% cat
```

# Check divergent transitions


```{r, echo = F, message = F}
waic(extract_log_lik(res, "log_lik"))$waic
loo(extract_log_lik(res, "log_lik"))

PA <- dat %>%
  as_data_frame %>%
  mutate(site2 = ifelse(site == "PNM", "DRY", "WET")) %>%
  mutate(sp_site_strata = paste(sp, site2, strata, sep = "_")) %>%
  mutate(site_strata = paste(site2, strata, sep = "_"))

```

There is no divergent transitions (i.e., no fatal error).

```{r}
divergent <- get_sampler_params(res, inc_warmup = FALSE)[[1]][, 'divergent__']
sum(divergent)
```


# Label problem

Only chain 3 of MCMC shows $\alpha_m > \alpha_s$. So I need to exchange $\alpha_m$ and $\alpha_s$ for the chain 1, 2 and 4.

```{r}

fit <- res
params <- extract(fit)
m <- 4000
Z_i <- params$Z[,1:3,1:3]

tmp <- data_frame(iter = 1:m,
           alpha_m = Z_i[,2,1],
           alpha_s = Z_i[,3,1]
           ) %>%
  gather(para, val, 2:3)

tmp_text <- data_frame(x = c(0, 1000, 2000, 3000),
                       y = 0.7,
                       lab = c("chain1->", "chain2->", "chain3->", "chain4->"))

ggplot(tmp, aes(x = iter, y = val)) +
  geom_line(aes(col = para)) +
  geom_vline(xintercept = c(0, 1000,2000,3000)) +
  geom_text(data = tmp_text, aes(x = x, y =y , label = lab))
```

Same for $\beta_m$, $\beta_m$, $\gamma_m$, $\gamma_s$ and $f_i$

```{r}

tmp <- data_frame(iter = 1:m,
           beta_m = Z_i[,2,2],
           beta_s = Z_i[,3,2]
           ) %>%
  gather(para, val, 2:3)

ggplot(tmp, aes(x = iter, y = val)) +
  geom_line(aes(col = para)) +
  geom_vline(xintercept = c(0, 1000,2000,3000)) +
  geom_text(data = tmp_text, aes(x = x, y = 0.5 , label = lab))


tmp <- data_frame(iter = 1:m,
           gamma_m = Z_i[,2,3],
           gamma_s = Z_i[,3,3]
           ) %>%
  gather(para, val, 2:3)

ggplot(tmp, aes(x = iter, y = val)) +
  geom_line(aes(col = para)) +
  geom_vline(xintercept = c(0, 1000,2000,3000)) +
  geom_text(data = tmp_text, aes(x = x, y = 1 , label = lab))


p_m <- params$p

tmp <- data_frame(iter = 1:m,
           f_1 = p_m[,1],
           para = "f_1"
           )
ggplot(tmp, aes(x = iter, y = f_1)) +
  geom_line(aes(col = para)) +
  geom_vline(xintercept = c(0, 1000,2000,3000)) +
  geom_text(data = tmp_text, aes(x = x, y = 1 , label = lab))


```

Thus, posterior distributions looks bad.

```{r}
traceplot(res, par = "Z", ncol = 3)
```


```{r}

summary_PA_LDL <- data.frame(summary(res)$summary)

summary_PA_LDL %>%
  round(3) %>%
  DT::datatable(.)

```

# Fixing labels manually

$\alpha_m$ <- $\alpha_m$ of chain 3 or $\alpha_s$ of chain 1, 2, and 4.

$\alpha_s$ <- $\alpha_s$ of chain 3 or $\alpha_m$ of chain 1, 2, and 4.


```{r}
#mcmc_res <- extract(fit) %>% as.data.frame
#params1 <- as.data.frame(extract(fit, permuted=FALSE)[,1,])
#params2 <- as.data.frame(extract(fit, permuted=FALSE)[,2,])
#params3 <- as.data.frame(extract(fit, permuted=FALSE)[,3,])
#params4 <- as.data.frame(extract(fit, permuted=FALSE)[,4,])

#get_stancode(fit) %>% cat
postZ <- params$Z
postp <- params$p
re_am <- postZ[, 2,1]
re_as <- postZ[, 3,1]
re_bm <- postZ[, 2,2]
re_bs <- postZ[, 3,2]
re_rm <- postZ[, 2,3]
re_rs <- postZ[, 3,3]


```


# Main results from here


# Correlation between LMAp and LMAs at each MCMC step

```{r}
p_est <- NULL
LMAp_mcmc <- list()
LMAs_mcmc <- list()
for (i in 1:130) {
  re_p0 <- postp[,i]
  p_est[i] <- mean(re_p0)
  LMAp_mcmc[[i]] <- re_p0 * PA$LMA[i]
  LMAs_mcmc[[i]] <- (1 - re_p0) * PA$LMA[i]
}

names(p_est) <- paste0("p",1:130)

LMAps_cor <- NULL
for (i in 1:4000){
  LMAps_cor[i] <- cor(
  sapply(LMAp_mcmc, "[[", i) %>% log,
  sapply(LMAs_mcmc, "[[", i) %>% log)
}

Mu_mcmc <- extract(fit, pars = "Mu")[[1]]

preLL <- Mu_mcmc[,,2] %>% apply(., 2, mean) %>% exp
preA <- Mu_mcmc[,,1] %>% apply(., 2, mean) %>% exp
preR <- Mu_mcmc[,,3] %>% apply(., 2, mean) %>% exp

preLL_lo <- Mu_mcmc[,,2] %>% apply(., 2, function(x)quantile(x, 0.025)) %>% exp
preLL_up <- Mu_mcmc[,,2] %>% apply(., 2, function(x)quantile(x, 0.975)) %>% exp
preA_lo <- Mu_mcmc[,,1] %>% apply(., 2, function(x)quantile(x, 0.025)) %>% exp
preA_up <- Mu_mcmc[,,1] %>% apply(., 2, function(x)quantile(x, 0.975)) %>% exp
preR_lo <- Mu_mcmc[,,3] %>% apply(., 2, function(x)quantile(x, 0.025)) %>% exp
preR_up <- Mu_mcmc[,,3] %>% apply(., 2, function(x)quantile(x, 0.975)) %>% exp
preLL1 <- Mu_mcmc[1,,2] %>% exp

hist(LMAps_cor)
#mu2_vec <- paste("mu2[", 1:nrow(PA), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(PA), ",2]", sep = "")
temp_LMAp <- p_est * PA$LMA
temp_LMAs <- PA$LMA - temp_LMAp

PA <- PA %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs)  %>%
  mutate(preLL = preLL) %>%
  mutate(preA = preA) %>%
  mutate(preR = preR) %>%
  mutate(preLL_lo = preLL_lo) %>%
  mutate(preLL_up = preLL_up) %>%
  mutate(preA_lo = preA_lo) %>%
  mutate(preA_up = preA_up) %>%
  mutate(preR_lo = preR_lo) %>%
  mutate(preR_up = preR_up) %>%
  mutate(preLL1 = preLL1)

write.csv(PA,"../data/PA_res.csv", row.names = F)
#PA <- read_csv("./data/PA_res.csv")

#cor.test(log(PA$LMA), log(PA$Narea))
#cor.test(log(PA$LMAp), log(PA$Narea))

PA %>% DT::datatable(.)

```

## R values

```{r, eval = F, echo = F}

my_cor <- function(LMA = c("LMAp", "LMAs"), trait) {
  cor1 <- NULL
  PA <- as.data.frame(PA)

  if (LMA=="LMAp") {
    for (i in 1:4000){
      cor1[i] <- cor.test(
      sapply(LMAp_mcmc, "[[", i) %>% log,
      log(PA[,paste(trait)]))$estimate
    }
      } else {
      for (i in 1:4000){
        cor1[i] <- cor.test(
        sapply(LMAs_mcmc, "[[", i) %>% log,
        log(PA[,paste(trait)]))$estimate
      }
    }
  cor1 %>% median %>% round(2)
}
my_cor2 <- function(LMA = c("LMAp", "LMAs"), trait) {
  cor1 <- NULL
  PA <- as.data.frame(PA)

  if (LMA=="LMAp") {
    for (i in 1:4000){
      cor1[i] <- cor.test(
      sapply(LMAp_mcmc, "[[", i) %>% log,
      log(PA[,paste(trait)]))$estimate
    }
      } else {
      for (i in 1:4000){
        cor1[i] <- cor.test(
        sapply(LMAs_mcmc, "[[", i) %>% log,
        log(PA[,paste(trait)]))$estimate
      }
    }
  cor1
}

my_corLL <- function(){
  cor1 <- NULL
  for (i in 1:4000) {
  cor1[i] <- cor(Mu_mcmc[i,,2], log(PA$LL))
  }
  cor1 %>% median %>% round(2)
}

R2_LL <- function(){
  y <- log(PA$LL)
  ypred <- Mu_mcmc[,,2]
  e <- -1 * sweep(ypred, 2, y )
  var_ypred <- apply(ypred, 1, var)
  var_e <- apply(e, 1, var)
  R2 <- var_ypred / (var_ypred + var_e)
  R2 %>% median %>% round(2)
}


cor.test(log(PA$Narea), log(PA$LMAp))

output <- "../PA_r_val.yml"
out <- file(paste(output), "w") # write

writeLines(paste0("r_vals:"),
           out,
           sep = "\n")
writeLines(paste0("  PA:"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_Aarea: 'italic(r) == ", cor.test(log(PA$Aarea), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAm_Aarea: 'italic(r) == ",  my_cor(LMA = "LMAp", trait = "Aarea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMAs_Aarea: 'italic(r) == ",  my_cor(LMA = "LMAs", trait = "Aarea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMA_Rarea: 'italic(r) == ", cor.test(log(PA$Rarea), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAm_Rarea: 'italic(r) == ",  my_cor(LMA = "LMAp", trait = "Rarea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMAs_Rarea: 'italic(r) == ",  my_cor(LMA = "LMAs", trait = "Rarea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMA_LL: 'italic(r) == ", cor.test(log(PA$LL), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAm_LL: 'italic(r) == ",  my_cor(LMA = "LMAp", trait = "LL"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMAs_LL: 'italic(r) == ",  my_cor(LMA = "LMAs", trait = "LL"),"'"),
  out,
  sep = "\n")

writeLines(paste0("  PA_NP:"),
           out,
           sep = "\n")

writeLines(paste0("    LMA_Narea: 'italic(r) == ", cor.test(log(PA$Narea), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAm_Narea: 'italic(r) == ",  my_cor(LMA = "LMAp", trait = "Narea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMAs_Narea: 'italic(r) == ",  my_cor(LMA = "LMAs", trait = "Narea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMA_Parea: 'italic(r) == ", cor.test(log(PA$Parea), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAm_Parea: 'italic(r) == ",  my_cor(LMA = "LMAp", trait = "Parea"),"'"),
  out,
  sep = "\n")

writeLines(paste0("    LMAs_Parea: 'italic(r) == ",  my_cor(LMA = "LMAs", trait = "Parea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMA_cell_area: 'italic(r) == ", cor.test(log(PA$cell_area), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")

writeLines(paste0("    LMAm_cell_area: 'italic(r) == ",  my_cor(LMA = "LMAp", trait = "cell_area"),"'"),
  out,
  sep = "\n")

writeLines(paste0("    LMAs_cell_area: 'italic(r) == ",  my_cor(LMA = "LMAs", trait = "cell_area"),"'"),
  out,
  sep = "\n")

writeLines(paste0("  PA_LL:"),
           out,
           sep = "\n")
writeLines(paste0("    preLL_LL: 'italic(r^2) == ", R2_LL(),"'"),
  out,
  sep = "\n")

close(out)

```

```{r}

R2_LL <- function(){
  y <- log(PA$LL)
  ypred <- Mu_mcmc[,,2]
  e <- -1 * sweep(ypred, 2, y )
  var_ypred <- apply(ypred, 1, var)
  var_e <- apply(e, 1, var)
  R2 <- var_ypred / (var_ypred + var_e)
  R2 %>% median %>% round(2)
}

R2_R <- function(){
  y <- log(PA$Rarea)
  ypred <- Mu_mcmc[,,3]
  e <- -1 * sweep(ypred, 2, y )
  var_ypred <- apply(ypred, 1, var)
  var_e <- apply(e, 1, var)
  R2 <- var_ypred / (var_ypred + var_e)
  R2 %>% median %>% round(2)
}

R2_A <- function(){
  y <- log(PA$Aarea)
  ypred <- Mu_mcmc[,,1]
  e <- -1 * sweep(ypred, 2, y )
  var_ypred <- apply(ypred, 1, var)
  var_e <- apply(e, 1, var)
  R2 <- var_ypred / (var_ypred + var_e)
  R2 %>% median %>% round(2)
}

output <- "../PA_r_val.yml"
out <- file(paste(output), "w") # write

writeLines(paste0("r_vals:"),
           out,
           sep = "\n")

writeLines(paste0("  PA:"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_Aarea: 'italic(r) == ", cor.test(log(PA$Aarea), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAp_Aarea: 'italic(r) == ", cor.test(log(PA$Aarea), log(PA$LMAp))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_Aarea: 'italic(r) == ", cor.test(log(PA$Aarea), log(PA$LMAs))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_Rarea: 'italic(r) == ", cor.test(log(PA$Rarea), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAp_Rarea: 'italic(r) == ", cor.test(log(PA$Rarea), log(PA$LMAp))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_Rarea: 'italic(r) == ", cor.test(log(PA$Rarea), log(PA$LMAs))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_LL: 'italic(r) == ", cor.test(log(PA$LL), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAp_LL: 'italic(r) == ", cor.test(log(PA$LL), log(PA$LMAp))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_LL: 'italic(r) == ", cor.test(log(PA$LL), log(PA$LMAs))$estimate %>% round(2),"'"),
           out,
           sep = "\n")


writeLines(paste0("  PA_LMAms:"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_LMAm: ", cor.test(log(PA$LMAp), log(PA$LMAs))$estimate %>% round(2)),
           out,
           sep = "\n")
writeLines(paste0("    p_val: ", cor.test(log(PA$LMAp), log(PA$LMAs))$p.value %>% round(2)),
           out,
           sep = "\n")


writeLines(paste0("  PA_NP:"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_Narea: 'italic(r) == ", cor.test(log(PA$Narea), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAp_Narea: 'italic(r) == ", cor.test(log(PA$Narea), log(PA$LMAp))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_Narea: 'italic(r) == ", cor.test(log(PA$Narea), log(PA$LMAs))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_Parea: 'italic(r) == ", cor.test(log(PA$Parea), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAp_Parea: 'italic(r) == ", cor.test(log(PA$Parea), log(PA$LMAp))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_Parea: 'italic(r) == ", cor.test(log(PA$Parea), log(PA$LMAs))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_cell_area: 'italic(r) == ", cor.test(log(PA$cell_area), log(PA$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAp_cell_area: 'italic(r) == ", cor.test(log(PA$cell_area), log(PA$LMAp))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_cell_area: 'italic(r) == ", cor.test(log(PA$cell_area), log(PA$LMAs))$estimate %>% round(2),"'"),
           out,
           sep = "\n")

writeLines(paste0("  PA_LL:"),
           out,
           sep = "\n")
writeLines(paste0("    preLL_LL: 'italic(r^2) == ", R2_LL(),"'"),
  out,
  sep = "\n")
writeLines(paste0("    preA_Aarea: 'italic(r^2) == ", R2_A(),"'"),
  out,
  sep = "\n")
writeLines(paste0("    preR_Rarea: 'italic(r^2) == ", R2_R(),"'"),
  out,
  sep = "\n")

close(out)

```


# Trait correlations

## A~area~, R~area~, LL

Open symbols indicate sun leaves and closed symbols indicate shade leaves.

```{r, echo = F, message = F}

setwd("..")
settings <- yaml::yaml.load_file("./settings.yml")
r_vals <- yaml::yaml.load_file("PA_r_val.yml")
p_letters <- yaml::yaml.load_file("letters.yml")
source("fig_theme.r")

PA2 <- PA %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs")) %>%
  gather(trait, val2, c("Aarea", "LL", "Rarea")) %>%
  gather(trait2, val3, c("Narea","Parea","cell_area","cell_vol"))

PA_dat <- PA %>%
  gather(LMA, Val,
         c(LMA, LMAs, LMAp)) %>%
  gather(Trait, Val2, c(Aarea, Rarea, LL,
                        Parea, Narea, cell_area)) %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA", "LMAm", "LMAs"))) %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA~(~g~m^{-2})", "LMAm~(~g~m^{-2})", "LMAs~(~g~m^{-2})"))) %>%
  mutate(site_strata = factor(site_strata,
          levels = c("WET_CAN", "DRY_CAN", "WET_UNDER", "DRY_UNDER"))) %>%
  mutate(Trait = factor(Trait,
    levels = c("Aarea", "Rarea", "LL", "Narea", "Parea", "cell_area"))) %>%
  mutate(Trait2 = factor(Trait,
    labels = c("italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "italic(R)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "LL~(months)",
               "italic(N)[area]~(~g~m^{-2})",
               "italic(P)[area]~(~g~m^{-2})",
               "italic(CL)[area]~(~g~m^{-2})"
               ))) %>%
  mutate(gr = factor(site_strata,
    labels = c("Sun-Wet",
               "Sun-Dry",
               "Shade-Wet",
               "Shade-Dry"
                      ))) %>%
  arrange(gr)

# PA LES plot ----------------------------------------------------------------0
PA_dat1 <- PA_dat %>%
  filter(Trait == "LL" |
         Trait == "Aarea" |
         Trait == "Rarea")

lim_PA <- lim_func(PA_dat1 %>% filter(site_strata != "Rand"),
                   trait = "Val")
lim_PA2 <- lim_func(PA_dat1 %>% filter(site_strata != "Rand"),
                    trait = "Val2", LMA = FALSE)

lab1 <- data_frame(lab = paste("(", letters[1:9], ")", sep = ""),
                   Val2 = lim_PA2$max_val %>% rep(each = 3),
                   Val = lim_PA$min_val %>% rep(3),
                   Val_max = lim_PA$max_val %>% rep(3),
                   gr = "Sun-Dry",
                   r_vals = r_vals$r_vals$PA %>% unlist,
                   Trait2 = rep(lim_PA2$Trait2, each = 3),
                   LMA = rep(lim_PA$LMA, 3)
                   )

fills <- c("Sun-Dry" = settings$fills$sun_dry,
          "Sun-Wet" = settings$fills$sun_wet,
          "Shade-Dry" = settings$fills$shade_dry,
          "Shade-Wet" = settings$fills$shade_wet)

cols <- c("Sun-Dry" = settings$colors$sun_dry,
          "Sun-Wet" = settings$colors$sun_wet,
          "Shade-Dry" = settings$colors$shade_dry,
          "Shade-Wet" = settings$colors$shade_wet)

PA_plot <- scatter_plt(PA_dat1)

print(PA_plot)

my_ggsave("./figs/PA.png", PA_plot)

```

## Observed LL vs predicted LL

Looks OK but each group has less steep slope. Our model tend to under-and over-esimate LL for long- and short-LL leaves, respectively.

```{r, echo = F, message = F}


LL_dat <- PA %>%
  mutate(site_strata = factor(site_strata,
          levels = c("WET_CAN", "DRY_CAN", "WET_UNDER", "DRY_UNDER"))) %>%
  mutate(gr = factor(site_strata,
    labels = c("Sun-Wet",
               "Sun-Dry",
               "Shade-Wet",
               "Shade-Dry"
                      )))

labLL <- data_frame(
                   LL = Inf,
                   #Val = min(PA$LL),
                   #Val_max = max(PA$LL),
                   Val = min(PA$preLL_lo),
                   Val_max = max(PA$preLL_up),
                   gr = "Sun-Dry",
                   r_vals = r_vals$r_vals$PA_LL$preLL_LL
                   )


LL_plot2 <- ggplot(LL_dat, aes(x = LL, y = preLL,
                              fill = gr, col = gr)) +
  geom_errorbar(aes(ymin = preLL_lo, ymax = preLL_up), alpha = 0.8, col = "gray") +
  geom_point(shape = 21) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_x_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(labLL$Val), max(labLL$Val_max))) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(labLL$Val), max(labLL$Val_max))) +
  ylab("Predicted LL (months)") +
  xlab("Observed LL (months)") +
  geom_abline(aes(slope = 1, intercept = 0),
              lty = 2,
              lwd = 0.25,
              col = "gray20") +
  geom_text(data = labLL, aes(label = r_vals, x = Val_max, y = 2.5),
            colour = "black",
            hjust = 1,
            vjust= 0,
            parse = TRUE,
            show.legend = FALSE) +
  coord_fixed() +
  theme_LES() +
  theme(
    legend.position = c(0.2, 0.85),
    axis.title.x = element_text(margin = margin(t = 1,
                                                b = 1,
                                                l = 0,
                                                r = 0)),
    axis.title.y = element_text(margin = margin(t = 1,
                                                b = 1,
                                                l = 1,
                                                r = 1))
        )

print(LL_plot2)

my_ggsave("../figs/LL_plot.png", LL_plot2,
          width = 6.7,
          height = 6.7)

cor.test(log(PA$LL), log(PA$preLL))

```

## A, R

```{r}

labA <- data_frame(
                   LL = Inf,
                   Val = min(PA$Aarea),
                   Val_max = max(PA$Aarea),
                   gr = "Sun-Dry",
                   r_vals = r_vals$r_vals$PA_LL$preA_Aarea
                   )

A_plot2 <- ggplot(LL_dat, aes(x = Aarea, y = preA,
                              fill = gr, col = gr)) +
  geom_errorbar(aes(ymin = preA_lo, ymax = preA_up), alpha = 0.8, col = "gray") +
  geom_point(shape = 21) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_x_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(labA$Val), max(labA$Val_max))) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(labA$Val), max(labA$Val_max))) +
  ylab("Predicted A (months)") +
  xlab("Observed A (months)") +
  geom_abline(aes(slope = 1, intercept = 0),
              lty = 2,
              lwd = 0.25,
              col = "gray20") +
  geom_text(data = labA, aes(label = r_vals, x = Val_max, y = 2.5),
            colour = "black",
            hjust = 1,
            vjust= 0,
            parse = TRUE,
            show.legend = FALSE) +
  coord_fixed() +
  theme_LES() +
  theme(
    legend.position = c(0.2, 0.85),
    axis.title.x = element_text(margin = margin(t = 1,
                                                b = 1,
                                                l = 0,
                                                r = 0)),
    axis.title.y = element_text(margin = margin(t = 1,
                                                b = 1,
                                                l = 1,
                                                r = 1))
        )

print(A_plot2)

my_ggsave("../figs/A_plot.png", A_plot2,
          width = 6.7,
          height = 6.7)

labR <- data_frame(
         LL = Inf,
         Val = min(PA$Rarea),
         Val_max = max(PA$Rarea),
         gr = "Sun-Dry",
         r_vals = r_vals$r_vals$PA_LL$preR_Rarea
         )

R_plot2 <- ggplot(LL_dat, aes(x = Rarea, y = preR,
                              fill = gr, col = gr)) +
  geom_errorbar(aes(ymin = preR_lo, ymax = preR_up), alpha = 0.8, col = "gray") +
  geom_point(shape = 21) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_x_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(labR$Val), max(labR$Val_max))) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(labR$Val), max(labR$Val_max))) +
  ylab("Predicted R (months)") +
  xlab("Observed R (months)") +
  geom_abline(aes(slope = 1, intercept = 0),
              lty = 2,
              lwd = 0.25,
              col = "gray20") +
  geom_text(data = labR, aes(label = r_vals, x = Val_max, y = 2.5),
            colour = "black",
            hjust = 1,
            vjust= 0,
            parse = TRUE,
            show.legend = FALSE) +
  coord_fixed() +
  theme_LES() +
  theme(
    legend.position = c(0.2, 0.85),
    axis.title.x = element_text(margin = margin(t = 1,
                                                b = 1,
                                                l = 0,
                                                r = 0)),
    axis.title.y = element_text(margin = margin(t = 1,
                                                b = 1,
                                                l = 1,
                                                r = 1))
        )

print(R_plot2)

my_ggsave("../figs/R_plot.png", R_plot2,
          width = 6.7,
          height = 6.7)

```

## Cell~area~, Cell~vol~ (= cellulose density), N~area~, P~area~

```{r, echo = F, message = F}


PA_dat2 <- PA_dat %>%
  filter(Trait == "Narea" |
         Trait == "Parea" |
         Trait == "cell_area")


lim_PA <- lim_func(PA_dat2 %>% filter(site_strata != "Rand"),
                   trait = "Val")
lim_PA2 <- lim_func(PA_dat2 %>% filter(site_strata != "Rand"),
                    trait = "Val2", LMA = FALSE)
lab1 <- data_frame(lab = paste("(", letters[1:9], ")", sep = ""),
                   Val2 = lim_PA2$max_val %>% rep(each = 3),
                   Val = lim_PA$min_val %>% rep(3),
                   Val_max = lim_PA$max_val %>% rep(3),
                   gr = "Sun-Dry",
                   r_vals = r_vals$r_vals$PA_NP %>% unlist,
                   Trait2 = rep(lim_PA2$Trait2, each = 3),
                   LMA = rep(lim_PA$LMA, 3)
                   )

PA_NPC_plot <- scatter_plt(PA_dat2)

print(PA_NPC_plot)

my_ggsave("../figs/PA_NPC.png", PA_NPC_plot)

```

## LMAp vs LMAs

```{r, echo = F, message = F}
ggplot(PA, aes(x = LMAp, y = LMAs, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  xlab("LMAm") +
  ylab("LMAs") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))
```

## Trait means

The results look OK.

```{r, echo = F, message = F, eval = T}

ggplot(PA2, aes(x = site_strata, y = val,
                                         fill = site_strata,
                                         col = site_strata)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))

```


## Decomposition of LMA variation

```{r}

var_p <- function(data)cov(data$LMA, data$LMAp)
var_s <- function(data)cov(data$LMA, data$LMAs)
var_t <- function(data)var(data$LMA)

var_p <- function(data)var(data$LMAp)
var_s <- function(data)var(data$LMAs)
cov_ps <- function(data)cov(data$LMAp, data$LMAs)
var_t <- function(data)var(data$LMA)

var_dat <- PA %>%
  group_by(strata) %>%
  nest %>%
  mutate(var_LMAm = map_dbl(data, var_p)) %>%
  mutate(var_LMAs = map_dbl(data, var_s)) %>%
  mutate(cov_ms = 2 * map_dbl(data, cov_ps)) %>%
  mutate(var_total = map_dbl(data, var_t)) %>%
  dplyr::select(-data)

var_dat_s <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_LMAm + var_LMAs) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_LMAm + var_LMAs) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance))

var_dat_s2 <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_total) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_total) * 100) %>%
  mutate(cov_LMAm_LMAs = cov_ms / (var_total) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance, cov_LMAm_LMAs))

```

1) var(LMAm) & var(LMAs) & 2*cov(LMAm, LMAs), 2)relative contribution: var(LMAm)/(var(LMAm) + var(LMAs)) & var(LMAs) /(var(LMAm) + var(LMAs))

```{r, echo = F, eval = T}

ggplot(var_dat_s2, aes(x = strata, y = val, fill = var)) +
  geom_col() +
  ylab("val (%)")


ggplot(var_dat_s, aes(x = strata, y = val, fill = var)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format())

```

# Randomized dataset

```{r}

load("../data/PA_latent_replusive_model_light2_more_rand.rda")

res <- rand_res$model[[1]]
tmp <- rand_res$data[[1]]

PA <- dat %>%
  as_data_frame %>%
  mutate(site2 = ifelse(site == "PNM", "DRY", "WET")) %>%
  mutate(sp_site_strata = paste(sp, site2, strata, sep = "_")) %>%
  mutate(site_strata = paste(site2, strata, sep = "_")) %>%
  mutate(LMA = tmp$LMA) %>%
  mutate(Aarea = tmp$A) %>%
  mutate(LL = tmp$LL) %>%
  mutate(Rarea = tmp$R)

```

## There are divergent transitions (fatal errors)

This means the model cannot reliable posterior distributions.

```{r}
pairs(res, pars = c("Z[1,1]","Z[1,2]"))
```

## No label problems?

It seems that MCMC tried to reduce the residuals for the expected LL and R~area~, which results in the failure for estimating A~area~.

```{r}


fit <- res
params <- extract(fit)
m <- 4000
Z_i <- params$Z[,1:3,1:3]

tmp <- data_frame(iter = 1:m,
           alpha_m = Z_i[,2,1],
           alpha_s = Z_i[,3,1]
           ) %>%
  gather(para, val, 2:3)

tmp_text <- data_frame(x = c(0, 1000, 2000, 3000),
                       y = 0.7,
                       lab = c("chain1->", "chain2->", "chain3->", "chain4->"))

ggplot(tmp, aes(x = iter, y = val)) +
  geom_line(aes(col = para)) +
  geom_vline(xintercept = c(0, 1000,2000,3000)) +
  geom_text(data = tmp_text, aes(x = x, y =y , label = lab))

traceplot(res, par = "Z", ncol = 3)

summary_PA <- data.frame(summary(res)$summary)

summary_PA %>%
  round(3) %>%
  DT::datatable(.)

```

add mean LMAm and LMAs

```{r}

mcmc_res <- extract(fit) %>% as.data.frame

p_est <- mcmc_res[,paste0("p.",  1:130)] %>% apply(.,2,mean)

Mu_mcmc <- extract(fit, pars = "Mu")[[1]]
preLL <- Mu_mcmc[,,2] %>% apply(., 2, mean) %>% exp
preA <- Mu_mcmc[,,1] %>% apply(., 2, mean) %>% exp
preR <- Mu_mcmc[,,3] %>% apply(., 2, mean) %>% exp

temp_LMAp <- p_est * PA$LMA
temp_LMAs <- PA$LMA - temp_LMAp

PA <- PA %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs)  %>%
  mutate(preLL = preLL) %>%
  mutate(preR = preR) %>%
  mutate(preA = preA)

plot(preR ~ Rarea, log = "xy", PA)
plot(preA ~ Aarea, log = "xy", PA)
plot(preLL ~ LL, log = "xy", PA)

plot(LL ~ preLL, PA, log= "xy")

```

## LMAm and LMAs vs N~area~, P~area~ and LL

```{r, echo = F, message = F}

setwd("..")

PA_dat <- PA %>%
  gather(LMA, Val,
         c(LMA, LMAs, LMAp)) %>%
  gather(Trait, Val2, c(Aarea, Rarea, LL,
                        Parea, Narea, cell_area)) %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA", "LMAm", "LMAs"))) %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA~(~g~m^{-2})", "LMAm~(~g~m^{-2})", "LMAs~(~g~m^{-2})"))) %>%
  mutate(site_strata = factor(site_strata,
          levels = c("WET_CAN", "DRY_CAN", "WET_UNDER", "DRY_UNDER"))) %>%
  mutate(Trait = factor(Trait,
    levels = c("Aarea", "Rarea", "LL", "Narea", "Parea", "cell_area"))) %>%
  mutate(Trait2 = factor(Trait,
    labels = c("italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "italic(R)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "LL~(months)",
               "italic(N)[area]~(~g~m^{-2})",
               "italic(P)[area]~(~g~m^{-2})",
               "italic(CL)[area]~(~g~m^{-2})"
               ))) %>%
  mutate(gr = factor(site_strata,
    labels = c("Sun-Wet",
               "Sun-Dry",
               "Shade-Wet",
               "Shade-Dry"
                      ))) %>%
  arrange(gr)

# PA LES plot ----------------------------------------------------------------0
PA_dat1 <- PA_dat %>%
  filter(Trait == "LL" |
         Trait == "Aarea" |
         Trait == "Rarea")

lim_PA <- lim_func(PA_dat1 %>% filter(site_strata != "Rand"),
                   trait = "Val")
lim_PA2 <- lim_func(PA_dat1 %>% filter(site_strata != "Rand"),
                    trait = "Val2", LMA = FALSE)

lab1 <- data_frame(lab = paste("(", letters[1:9], ")", sep = ""),
                   Val2 = lim_PA2$max_val %>% rep(each = 3),
                   Val = lim_PA$min_val %>% rep(3),
                   Val_max = lim_PA$max_val %>% rep(3),
                   gr = "Sun-Dry",
                   r_vals = "",
                   Trait2 = rep(lim_PA2$Trait2, each = 3),
                   LMA = rep(lim_PA$LMA, 3)
                   )

fills <- c("Sun-Dry" = settings$fills$sun_dry,
          "Sun-Wet" = settings$fills$sun_wet,
          "Shade-Dry" = settings$fills$shade_dry,
          "Shade-Wet" = settings$fills$shade_wet)

cols <- c("Sun-Dry" = settings$colors$sun_dry,
          "Sun-Wet" = settings$colors$sun_wet,
          "Shade-Dry" = settings$colors$shade_dry,
          "Shade-Wet" = settings$colors$shade_wet)

PA_plot <- scatter_plt(PA_dat1)

print(PA_plot)

my_ggsave("./figs/PA_rand.png", PA_plot)

```

## Observed LL vs predicted LL


```{r, echo = F, message = F}


LL_dat <- PA %>%
  mutate(site_strata = factor(site_strata,
          levels = c("WET_CAN", "DRY_CAN", "WET_UNDER", "DRY_UNDER"))) %>%
  mutate(gr = factor(site_strata,
    labels = c("Sun-Wet",
               "Sun-Dry",
               "Shade-Wet",
               "Shade-Dry"
                      )))

labLL <- data_frame(
                   LL = Inf,
                   Val = min(PA$LL),
                   Val_max = max(PA$LL),
                   gr = "Sun-Dry",
                   r_vals = ""
                   )

LL_plot <- ggplot(LL_dat, aes(x = preLL, y = LL,
                              fill = gr, col = gr)) +
  geom_point(shape = 21) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_x_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(labLL$Val), max(labLL$Val_max))) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(labLL$Val), max(labLL$Val_max))) +
  xlab("Predicted LL (months)") +
  ylab("Observed LL (months)") +
  geom_abline(aes(slope = 1, intercept = 0),
              lty = 2,
              lwd = 0.25,
              col = "gray20") +
  geom_text(data = labLL, aes(label = r_vals, x = Val_max, y = 2.5),
            colour = "black",
            hjust = 1,
            vjust= 0,
            parse = TRUE,
            show.legend = FALSE) +
  coord_fixed() +
  theme_LES() +
  theme(
    legend.position = c(0.2, 0.85),
    axis.title.x = element_text(margin = margin(t = 1,
                                                b = 1,
                                                l = 0,
                                                r = 0)),
    axis.title.y = element_text(margin = margin(t = 1,
                                                b = 1,
                                                l = 1,
                                                r = 1))
        )

print(LL_plot)

my_ggsave("../figs/LL_plot_rand.png", LL_plot,
          width = 6.7,
          height = 6.7)

cor.test(log(LL_dat$preLL), log(LL_dat$LL))

```

# Model code

```{r}
get_stancode(res) %>% cat
```

# R info

```{r}
sessionInfo()
```
