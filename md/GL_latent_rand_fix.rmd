---
title: GLOPNET results using normal distribution (potential)
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

Note: Still using a name "LMAp". .

\begin{align}
  &E[\mathrm{net \; photosynthesis}]
  = E[A_{\mathrm{area} \; i}]
  = \alpha_0\mathrm{LMAp}^{\alpha_p} \\
  &E[\mathrm{LL}_{i}] = \beta_{0} \mathrm{LMAs}_i^{\beta_s} \\
  &E[R_{\mathrm{area} \; i}] = r_0 \mathrm{LMAp}^{r_p}_{i} \mathrm{LMAs}^{r_s}_{i}
\end{align}


```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      message=FALSE)
```


```{r, echo = F, message = F}
library(loo)
library(rstan)
library(dplyr)
library(scales)
library(memisc)


theme_set(theme_light())

settings <- yaml::yaml.load_file("../settings.yml")
```


```{r, echo = F, message = F}

#load("./data/GL_sitePL_LD_L_MVN_obs.rda")
load("../data/GL_latent_model_rand.rda")
#load("./data/GL_latent_model_rand.rda")


pairs(rand_res$model[[1]], pars = c("Z[1,1]", "Z[2,1]", "Z[3,1]", "lp__"))
pairs(rand_res$model[[2]], pars = c("Z[1,1]", "Z[2,1]", "Z[3,1]", "lp__"))
pairs(rand_res$model[[3]], pars = c("Z[1,1]", "Z[2,1]", "Z[3,1]", "lp__"))


traceplot(rand_res$model[[1]], pars = "Z")
traceplot(rand_res$model[[2]], pars = "Z")
traceplot(rand_res$model[[3]], pars = "Z")

summary_GL_LDL <- rand_res$summary[[1]]

summary_GL_LDL %>% 
  round(3) %>%
  DT::datatable(.)

traceplot(rand_res$model[[1]], pars = c("p[1]",
                        "p[2]",
                        "p[3]",
                        "lp__"
                        ))
traceplot(rand_res$model[[1]], pars = "L_Omega")

temp <- rand_dat$data[[1]] 

GL0 <- dat %>%
  as_data_frame %>%
  dplyr::select(sp, DE, GF)

GL <- data_frame(LMA = temp$LMA,
                 Aarea = temp$A,
                 LL = temp$LL,
                 Rarea = temp$R)

GL <- bind_cols(GL0, GL)


#P_vec <- paste("p[", 1:nrow(GL), "]", sep = "")
LMAp_vec <- paste("log_LMAp[", 1:nrow(GL), "]", sep = "")
LMAs_vec <- paste("log_LMAs[", 1:nrow(GL), "]", sep = "")
mu2_vec <- paste("Mu[", 1:nrow(GL), ",2]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(GL), ",2]", sep = "")
temp_LMAp <- summary_GL_LDL[LMAp_vec, "mean"] 
temp_LMAs <- summary_GL_LDL[LMAs_vec, "mean"] 
temp_LL <- exp(summary_GL_LDL[mu2_vec, "mean"])

GL <- GL %>%
  mutate(LMAp = temp_LMAp %>% exp) %>%
  mutate(LMAs = temp_LMAs %>% exp) %>%
  mutate(preLL = temp_LL) 

tmp <- GL %>%
  dplyr::select(sp, DE) 

d <- read_csv("../data/nature02403-s2.csv", skip = 10)

dd <- data.frame(Narea = 10^d$`log Narea`,
        Parea = 10^d$`log Parea`,
        sp = d$Species) %>%
        group_by(sp) %>%
        summarize(Narea = mean(Narea, na.omit = T),
            Parea = mean(Parea, na.omit = T))

GL <- left_join(GL, dd, by = "sp") %>%
  mutate(gr = factor(DE,
    labels = c("Deciduous",
               "Evergreen",
               "Unclassified"
                      ))) %>%
  arrange(desc(gr))


```

```{r,eval=F}

par_fun <- function(x) as.data.frame(extract(res, permuted=FALSE)[,x,])

par_dat <- map(1:n_chains, par_fun)
Z21 <- function(x) x$`Z[2,1]`
Z31 <- function(x) x$`Z[3,1]`
p1 <- function(x) x$`p[1]`
am <- function(x) x$am
as <- function(x) x$as
bm <- function(x) x$bm
bs <- function(x) x$bs

fig_dat <- data_frame(chain = 1:n_chains) %>%
  mutate(p1 = lapply(par_dat, p1)) %>%
  mutate(Z21 = lapply(par_dat, Z21)) %>%
  mutate(Z31 = lapply(par_dat, Z31)) %>%
  mutate(am = lapply(par_dat, am)) %>%
  mutate(as = lapply(par_dat, as)) %>%
  mutate(bm = lapply(par_dat, bm)) %>%
  mutate(bs = lapply(par_dat, bs)) %>%
  unnest

ggplot(fig_dat, aes(x = Z21, y = Z31, col = as.factor(chain))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)

ggplot(fig_dat, aes(x = am, y = as, col = as.factor(chain))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)

ggplot(fig_dat, aes(x = bm, y = bs, col = as.factor(chain))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)

ggplot(fig_dat, aes(x = Z21, y = p1, col = as.factor(chain))) +
  geom_point()

aa <- rbeta(100, 2.75, 8.25) + rbeta(100, 8.25, 2.75)
hist(aa/2)


rbf <- function(r) exp(-(0.5*r)^2)
xx <- seq(-4,8, length = 100)

plot(xx, rbf(xx - 0.75), type = "l")
points(xx, rbf(xx - 2.75), type = "l")

```


```{r}

fit <- rand_res$model[[1]]

#fit %>% as.array %>% dim

params <- extract(fit)

m <- 4000

library(mvtnorm)

Z_i <- params$Z[,1:3,1:3]


plot(1:m, Z_i[,2,1], type = "l", col ="orange",ylim=c(-0.8,0.8))
points(1:m, Z_i[,3,1], type = "l", col ="violet")

plot(1:m, Z_i[,2,2], type = "l", col ="orange",ylim=c(-1, 2))
points(1:m, Z_i[,3,2], type = "l", col ="violet")

plot(1:m, Z_i[,2,3], type = "l", col ="orange",ylim=c(-0.5,0.8))
points(1:m, Z_i[,3,3], type = "l", col ="violet")

lp_m <- params$lp__
p_m <- params$p
rho13 <- params$rho13

plot(1:m, rho13, type = "l", col ="orange")
plot(1:m, lp_m, type = "l", col ="orange")
plot(1:m, p_m[,1], type = "l", col ="orange")


Sigma_i <- params$Sigma[,1:3,1:3]
L_sigma_i <- params$L_sigma[,]

```

# para fix

```{r}
mcmc_res <- extract(fit) %>% as.data.frame
params1 <- as.data.frame(extract(fit, permuted=FALSE)[,1,])
params2 <- as.data.frame(extract(fit, permuted=FALSE)[,2,])
params3 <- as.data.frame(extract(fit, permuted=FALSE)[,3,])
params4 <- as.data.frame(extract(fit, permuted=FALSE)[,4,])

plot(params1$`Z[2,1]`, params3$`Z[2,1]`)

get_stancode(fit) %>% cat

re_am <- c(params1$`Z[3,1]`,
	 			 params2$`Z[2,1]`,
	 			 params3$`Z[2,1]`,
	 			 params4$`Z[3,1]`)

re_as <- c(params1$`Z[2,1]`,
	 			 params2$`Z[3,1]`,
	 			 params3$`Z[3,1]`,
	 			 params4$`Z[2,1]`)

re_bm <- c(params1$`Z[3,2]`,
	 			 params2$`Z[2,2]`,
         params3$`Z[2,2]`,
         params4$`Z[3,2]`)

re_bs <- c(params1$`Z[2,2]`,
           params2$`Z[3,2]`,
           params3$`Z[3,2]`,
           params4$`Z[2,2]`)

re_rm <- c(params1$`Z[3,3]`,
	 			 params2$`Z[2,3]`,
         params3$`Z[2,3]`,
         params4$`Z[3,3]`)

re_rs <- c(params1$`Z[2,3]`,
           params2$`Z[3,3]`,
           params3$`Z[3,3]`,
           params4$`Z[2,3]`)

re_p1 <- c(1-params1$`p[1]` ,
          params2$`p[1]` ,
          params3$`p[1]` ,
          1-params4$`p[1]` )

re_p0 <- c(1 - params1[,paste0("p[",1:198,"]")],
  params2[,paste0("p[",1:198,"]")],
  params3[,paste0("p[",1:198,"]")],
  1 - params4[,paste0("p[",1:198,"]")]) %>% unlist 

re_p <- array(NA, 
              dim = c(4000, 198))

mpc <- fit@sim$iter-fit@sim$warmup

tmp <- array(c(re_am,
               re_as,
               re_bm,
               re_bs,
               re_rm,
               re_rs
                  ),
             dim = c(mpc * 4, 6))

tmp2 <- tmp

#par(mfrow=c(5,5))
for (i in 1:198) {
  re_p0 <- c(1 - params1[,paste0("p[",i,"]")],
    params2[,paste0("p[",i,"]")],
    params3[,paste0("p[",i,"]")],
    1 - params4[,paste0("p[",i,"]")]) 
 # hist(re_p0)
  tmp2 <- cbind(tmp2, re_p0)
}
par(mfrow=c(1,1))

amu <- array(NA,dim = c(mpc,fit@sim$chains,dim(tmp2)[2]))
for (cc in 1:fit@sim$chains) amu[,cc,] = tmp2[(1:mpc)+(cc-1)*mpc,]
mmu <- monitor(amu, print = F, warmup = 0)
rownames(mmu) <- c("am", "as", "bm", "bs", "rm", "rs", 
                   paste0("p",1:198))

mmu %>% DT::datatable(.)

mcmc_re <- data_frame(alpha_m = amu[,,1] %>% as.vector,
             alpha_s = amu[,,2] %>% as.vector,
             beta_m = amu[,,3] %>% as.vector,
             beta_s = amu[,,4] %>% as.vector,
             gamma_m = amu[,,5] %>% as.vector,
             gamma_s = amu[,,6] %>% as.vector
             ) %>%
  mutate(iter = rep(1:1000, 4)) %>%
  mutate(chain = rep(1:4, each = 1000) %>% as.factor)

mcmc_re2 <- mcmc_re %>%
  gather(para, val, 1:6)

ggplot(mcmc_re2, aes(x = iter, y = val, col = chain)) +
  geom_line() +
  facet_wrap(~para)

```


```{r}

GL <- dat
P_vec <- paste("p[", 1:nrow(GL), "]" ,sep = "")

GL <- GL %>%
  mutate(DE = ifelse(GL$DE == "", "U", as.character(DE))) 

p_est<-NULL
LMAp_mcmc <- list()
LMAs_mcmc <- list()
for (i in 1:198) {
  re_p0 <- c(1 - params1[,paste0("p[",i,"]")],
    params2[,paste0("p[",i,"]")],
    params3[,paste0("p[",i,"]")],
    1 - params4[,paste0("p[",i,"]")]) 
  p_est[i] <- median(re_p0)
  LMAp_mcmc[[i]] <- re_p0 * GL$LMA[i]
  LMAs_mcmc[[i]] <- (1 - re_p0) * GL$LMA[i]
}


LMAps_cor <- NULL
for (i in 1:4000){
  LMAps_cor[i] <- cor(
                  sapply(LMAp_mcmc, "[[", i) %>% log,
                  sapply(LMAs_mcmc, "[[", i) %>% log)
}

hist(LMAps_cor)

#mu2_vec <- paste("mu2[", 1:nrow(GL), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(GL), ",2]", sep = "")
temp_LMAp <- p_est * GL$LMA
temp_LMAs <- GL$LMA - temp_LMAp
#temp_LL <- exp(GL_summary[mu2_vec, "mean"])

GL <- GL %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs) 

log_LMAp <- rstan::extract(res, "log_LMAp")[[1]]
log_LMAs <- rstan::extract(res, "log_LMAs")[[1]]
#as <- rstan::extract(res, "beta[3]")[[1]]

tmp <- GL %>%
  dplyr::select(sp, DE) 

d <- read_csv("../data/nature02403-s2.csv", skip = 10)

dd <- data.frame(Narea = 10^d$`log Narea`,
        Parea = 10^d$`log Parea`,
        sp = d$Species) %>%
        group_by(sp) %>%
        summarize(Narea = mean(Narea, na.omit = T),
            Parea = mean(Parea, na.omit = T))

GL <- left_join(GL, dd, by = "sp") %>%
  mutate(gr = factor(DE,
    labels = c("Deciduous",
               "Evergreen",
               "Unclassified"
                      ))) %>%
  arrange(desc(gr))

```

```{r, echo = F, eval = T}
waic(extract_log_lik(res,"log_lik"))$waic
loo(extract_log_lik(res,"log_lik"))
moge <- loo(extract_log_lik(res,"log_lik")) 
plot(moge)
pareto_k_ids(moge, threshold = 0.3)
```

# Paramters 

```{r, echo = F, eval = F}

plot(res)

```

```{r, echo = F}

var_p <- function(data)cov(data$LMA, data$LMAp)
var_s <- function(data)cov(data$LMA, data$LMAs)
var_t <- function(data)var(data$LMA)

var_p <- function(data)var(data$LMAp)
var_s <- function(data)var(data$LMAs)
cov_ps <- function(data)cov(data$LMAp, data$LMAs)
var_t <- function(data)var(data$LMA)

var_dat <- GL %>%
  mutate(site = "GL") %>%
  group_by(site) %>%
  nest %>%
  mutate(var_LMAm = map_dbl(data, var_p)) %>%
  mutate(var_LMAs = map_dbl(data, var_s)) %>%
  mutate(cov_ms = 2 * map_dbl(data, cov_ps)) %>%
  mutate(var_total = map_dbl(data, var_t)) %>%
  dplyr::select(-data)

var_dat_s <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_LMAm + var_LMAs) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_LMAm + var_LMAs) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance))

var_dat_s2 <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_total) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_total) * 100) %>%
  mutate(cov_LMAm_LMAs = cov_ms / (var_total) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance, cov_LMAm_LMAs)) 

```



```{r, echo = F, eval = F}
# R values

#R values are based on posterior distributions of LMAs

par(mfrow = c(1,2))
apply(log_LMAs, 1, function(x)cor(x, log(GL$Aarea))) %>% hist(main = "LMAs vs Aarea, R")
apply(log_LMAs, 1, function(x)cor(x, log(GL$Aarea))^2) %>% hist(main = "LMAs vs Aarea, R2")

apply(log_LMAs, 1, function(x)cor(x, log(GL$Aarea + GL$Rarea))) %>% hist(main = "LMAs vs Aarea + Rarea, R")
apply(log_LMAs, 1, function(x)cor(x, log(GL$Aarea + GL$Rarea))^2) %>% hist(main = "LMAs vs Aarea + Rarea, R2")


apply(log_LDs, 1, function(x)cor(x, log(GL$Aarea))) %>% hist(main = "LMAs/LT vs Aarea, R")
apply(log_LDs, 1, function(x)cor(x, log(GL$Aarea))^2) %>% hist(main = "LMAs/LT vs Aarea, R2")


apply(log_LDs, 1, function(x)cor(x, log(GL$Aarea + GL$Rarea))) %>% hist(main = "LMAs/LT vs Aarea + Rarea, R")
apply(log_LDs, 1, function(x)cor(x, log(GL$Aarea + GL$Rarea))^2) %>% hist(main = "LMAs/LT vs Aarea + Rarea, R2")
```


# Trait correlations

## A~area~, R~area~, LL

Open symbols indicate sun leaves and closed symbols indicate shade leaves. The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}

GL2 <- GL %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs")) %>%
  gather(trait, val2, c("Aarea", "LL", "Rarea")) 

GL3 <- GL %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs")) %>%
  #gather(trait, val2, c("Aarea", "LL", "Rarea")) %>%
  gather(trait2, val3, c("Narea","Parea")) 

fills <- c("Deciduous" = settings$fills$D,
          "Evergreen" = settings$fills$E,
          "Unclassified" = settings$fills$U)

cols <- c("Deciduous" = settings$colors$D,
          "Evergreen" = settings$colors$E,
          "Unclassified" = settings$colors$U)

ggplot(GL2, aes(x = val, y = val2, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


```

## Observed LL vs predicted LL

Note: Light and site effects were not included in this model.

```{r, echo = F, message = F}

#ggplot(GL, aes(x = LL, y = preLL, fill = gr, col = gr)) +
#  geom_point(shape = 21) +
#  xlab("obsLL") +
#  ylab("preLL") +
#  scale_fill_manual(values = fills) +
#  scale_colour_manual(values = cols) +
#  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
#              labels = trans_format("log10", math_format(10^.x))) +
#  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
#              labels = trans_format("log10", math_format(10^.x)))
#
#
#cor.test(log(GL$LL), log(GL$preLL))


```


##  N~area~, P~area~

```{r, echo = F, message = F}

ggplot(GL3, aes(x = val, y = val3, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait2 ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

cor.test(log(GL$LMA), log(GL$Narea))

cor.test(log(GL$LMAp), log(GL$Narea))


```

## LMAp vs LMAs

```{r, echo = F, message = F}

ggplot(GL, aes(x = LMAp, y = LMAs, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  xlab("LMAm") +
  ylab("LMAs") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


cor.test(log(GL$LMAp) , log(GL$LMAs))

```

## Trait means

The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}

ggplot(GL2, aes(x = gr, y = val,
                                         fill = gr,
                                         col = gr)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) 


```


# Decomposition of LMA variation 

1) var(LMAm) & var(LMAs) & 2*cov(LMAm, LMAs), 2)relative contribution: var(LMAm)/(var(LMAm) + var(LMAs)) & var(LMAs) /(var(LMAm) + var(LMAs))

```{r, echo = F}

ggplot(var_dat_s2, aes(x = site, y = val, fill = var)) +
  geom_col() +
  ylab("val (%)") 

ggplot(var_dat_s, aes(x = site, y = val, fill = var)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format())

```


```{r, echo = F, message = F, eval = F}

cor.test(log(GL$LMA), log(GL$cell_area))
cor.test(log(GL$LMAs), log(GL$cell_area))

cor.test(log(GL$LD), log(GL$cell_vol))
cor.test(log(GL$LDs), log(GL$cell_vol))


cor.test(log(GL$LMA), log(GL$Narea))
cor.test(log(GL$LMAp), log(GL$Narea))

cor.test(log(GL$LMA), log(GL$Parea))
cor.test(log(GL$LMAp), log(GL$Parea))

apply(log_LMAp, 1, function(x)cor(x, log(GL$Narea))) %>% hist(main = "LMAp vs Narea, R")
apply(log_LMAp, 1, function(x)cor(x, log(GL$Parea))) %>% summary

apply(log_LMAp, 1, function(x)cor(x, log(GL$Narea))) %>% hist(main = "LMAp vs Narea, R")

apply(log_LMAp, 1, function(x)cor(x, log(GL$Rarea))) %>% quantile(0.025)
cor.test(log(GL$LMA), log(GL$Rarea))

apply(log_LMAs, 1, function(x)cor(x, log(GL$cell_area))) %>% hist(main = "LMAp vs Narea, R")

```


```{r, echo = F, message = F, eval = F}

ggplot(tmp3, aes(x = LD_shade, y = LD_sun)) +
  geom_point() +
  facet_grid(~site) +
  geom_abline(slope=1, lty = 2) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  coord_fixed()


ggplot(tmp3, aes(x = cell_vol_shade, y = cell_vol_sun)) +
  geom_point() +
  facet_grid(~site) +
  geom_abline(slope=1, lty = 2) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  coord_fixed()


ggplot(GL, aes(x = site_strata, y = cell_vol,
               fill = site_strata,
               col = site_strata)) +
  geom_boxplot() +
  #geom_violin() +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))

ggplot(GL, aes(x = site_strata, y = LD,
               fill = site_strata,
               col = site_strata)) +
  geom_boxplot() +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))



ggplot(GL, aes(x = site_strata, y = cell_area,
               fill = site_strata,
               col = site_strata)) +
  #geom_violin() +
  geom_boxplot() +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))

ggplot(GL, aes(x = LD, y = Aarea, fill = site, col = site, shape = strata)) +
  geom_point()  +
  facet_grid(site ~ strata)  +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_colour_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

ggplot(GL, aes(x = LD, y = Aarea, fill = site, col = site, shape = strata)) +
  geom_point()  +
  facet_grid( ~ strata)  +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_colour_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


ggplot(GL, aes(x = cell_vol, y = Aarea, fill = site, col = site, shape = strata)) +
  geom_point()  +
  facet_grid(site ~ strata)  +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_colour_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


ggplot(GL, aes(x = cell_vol, y = Aarea, fill = site, col = site, shape = strata)) +
  geom_point()  +
  facet_grid( ~ strata)  +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_colour_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


ggplot(GL, aes(x = cell_area, y = Aarea, fill = site, col = site, shape = strata)) +
  geom_point()  +
  facet_grid(site ~ strata)  +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_colour_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


rbf <- function(r) exp(-(1*r)^2)
xx <- seq(-2,2, length = 100)
plot(xx, rbf(xx - 0.25), type = "l")
points(xx, rbf(xx + 0.6), type = "l")


```
