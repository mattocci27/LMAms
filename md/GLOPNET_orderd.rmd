---
title: GLOPNET results
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
---

$$
\begin{aligned}
LMAm_i = f_i \times LMA_i \\
LMAs_i = (1-f_i) \times LMA_i
\end{aligned}
$$

$$
A_{area\ i} = \alpha_0 LMAm_{i}^{\alpha_m} LMAs_{i}^{\alpha_s} \\
LL_{i} = \beta_0 LMAm_{i}^{\beta_m} LMAs_{i}^{\beta_s}  \\
R_{area\ i} = \gamma_0 LMAm_{i}^{\gamma_m} LMAs_{i}^{\gamma_s}
$$


$$
Z =
\begin{bmatrix}
\alpha_0 &\beta_0 &\gamma_0 \\
\alpha_m &\beta_m &\gamma_m \\
\alpha_s &\beta_s &\gamma_s \\
\end{bmatrix}
$$

$$
X =
\begin{bmatrix}
1 &logLMA_i & logLMAs_{i}
\end{bmatrix}
$$

$$
Mu = X \times Z
$$

Some parameters are exchangeable. For example, $[f_i, \ \alpha_m, \ \alpha_s]$ = [0.2, 0.5, 1.0] and [0.8, 1.0, 0.5] return the identical expected mean of A~area~. When the posterior distributions from different chains were symmetric (as above), I switched labels so that $\alpha_m$ > $\alpha_s$ (LMAm is associated with metabolic rates by our definition).



```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      message=FALSE)
```


```{r, echo = F, message = F}
library(loo)
library(rstan)
library(scales)
library(memisc)
library(tidyverse)
library(stringr)
library(lazyeval)
library(cowplot)
library(ggrepel)
library(ggthemes)
```

# Check divergent transitions

```{r}

setwd("..")
getwd()
#load("./data/GL_latent_model_orderd_obs.rda")
load("./data/GL_GL_LMAms_obs.rda")

GL <- dat
GL <- GL %>%
  mutate(DE = ifelse(GL$DE == "", "U", as.character(DE)))

```



There is no divergent transitions (i.e., no fatal error).

```{r}
divergent <- get_sampler_params(res, inc_warmup=FALSE)[[1]][,'divergent__']
sum(divergent)
```


# Label problem

Chain 2 and 3 of MCMC show $\alpha_m > \alpha_s$. So I need to exchange $\alpha_m$ and $\alpha_s$ for the chain 1 and 4.


```{r}

fit <-res
params <- extract(fit)
m <- 4000
Z_i <- params$Z[,1:3,1:3]

tmp <- data_frame(iter = 1:m,
           alpha_m = Z_i[,2,1],
           alpha_s = Z_i[,3,1]
           ) %>%
  gather(para, val, 2:3)

tmp_text <- data_frame(x = c(0, 1000, 2000, 3000),
                       y = 0.7,
                       lab = c("chain1->", "chain2->", "chain3->", "chain4->"))

ggplot(tmp, aes(x = iter, y = val)) +
  geom_line(aes(col = para)) +
  geom_vline(xintercept = c(0, 1000,2000,3000)) +
  geom_text(data = tmp_text, aes(x = x, y =y , label = lab))
```

Same for $\beta_m$, $\beta_m$, $\gamma_m$, $\gamma_s$ and $f_i$

```{r}

tmp <- data_frame(iter = 1:m,
           beta_m = Z_i[,2,2],
           beta_s = Z_i[,3,2]
           ) %>%
  gather(para, val, 2:3)

ggplot(tmp, aes(x = iter, y = val)) +
  geom_line(aes(col = para)) +
  geom_vline(xintercept = c(0, 1000,2000,3000)) +
  geom_text(data = tmp_text, aes(x = x, y = 0.5 , label = lab))


tmp <- data_frame(iter = 1:m,
           gamma_m = Z_i[,2,3],
           gamma_s = Z_i[,3,3]
           ) %>%
  gather(para, val, 2:3)

ggplot(tmp, aes(x = iter, y = val)) +
  geom_line(aes(col = para)) +
  geom_vline(xintercept = c(0, 1000,2000,3000)) +
  geom_text(data = tmp_text, aes(x = x, y = 1 , label = lab))


p_m <- params$p

tmp <- data_frame(iter = 1:m,
           f_1 = p_m[,1],
           para = "f_1"
           )
ggplot(tmp, aes(x = iter, y = f_1)) +
  geom_line(aes(col = para)) +
  geom_vline(xintercept = c(0, 1000,2000,3000)) +
  geom_text(data = tmp_text, aes(x = x, y = 1 , label = lab))


```

Thus, posterior distributions looks bad.

```{r}
summary_GL <- data.frame(summary(res)$summary)

summary_GL %>%
  round(3) %>%
  DT::datatable(.)

```

# Fixing labels manually

$\alpha_m$ <- $\alpha_m$ of chain 2 and 3 or $\alpha_s$ of chain 1 and 4.

$\alpha_s$ <- $\alpha_s$ of chain 2 and 3 or $\alpha_m$ of chain 1 and 4.


```{r}
mcmc_res <- extract(fit) %>% as.data.frame
params1 <- as.data.frame(extract(fit, permuted=FALSE)[,1,])
params2 <- as.data.frame(extract(fit, permuted=FALSE)[,2,])
params3 <- as.data.frame(extract(fit, permuted=FALSE)[,3,])
params4 <- as.data.frame(extract(fit, permuted=FALSE)[,4,])

re_am <- c(params1$`Z[2,1]`,
	 			 params2$`Z[2,1]`,
	 			 params3$`Z[2,1]`,
	 			 params4$`Z[2,1]`)

re_as <- c(params1$`Z[3,1]`,
	 			 params2$`Z[3,1]`,
	 			 params3$`Z[3,1]`,
	 			 params4$`Z[3,1]`)

re_bm <- c(params1$`Z[2,2]`,
	 			 params2$`Z[2,2]`,
         params3$`Z[2,2]`,
         params4$`Z[2,2]`)

re_bs <- c(params1$`Z[3,2]`,
           params2$`Z[3,2]`,
           params3$`Z[3,2]`,
           params4$`Z[3,2]`)

re_rm <- c(params1$`Z[2,3]`,
	 			 params2$`Z[2,3]`,
         params3$`Z[2,3]`,
         params4$`Z[2,3]`)

re_rs <- c(params1$`Z[3,3]`,
           params2$`Z[3,3]`,
           params3$`Z[3,3]`,
           params4$`Z[3,3]`)

re_p1 <- c(params1$`p[1]` ,
          params2$`p[1]` ,
          params3$`p[1]` ,
          params4$`p[1]` )

re_p0 <- c(params1[,paste0("p[",1:198,"]")],
  params2[,paste0("p[",1:198,"]")],
  params3[,paste0("p[",1:198,"]")],
  params4[,paste0("p[",1:198,"]")]) %>% unlist

re_p <- array(NA,
              dim = c(4000, 198))

mpc <- fit@sim$iter-fit@sim$warmup

tmp <- array(c(re_am,
               re_as,
               re_bm,
               re_bs,
               re_rm,
               re_rs
                  ),
             dim = c(mpc * 4, 6))

tmp2 <- tmp

#par(mfrow=c(5,5))
for (i in 1:198) {
  re_p0 <- c(params1[,paste0("p[",i,"]")],
    params2[,paste0("p[",i,"]")],
    params3[,paste0("p[",i,"]")],
    params4[,paste0("p[",i,"]")])
 # hist(re_p0)
  tmp2 <- cbind(tmp2, re_p0)
}
par(mfrow=c(1,1))

amu <- array(NA,dim = c(mpc,fit@sim$chains,dim(tmp2)[2]))
for (cc in 1:fit@sim$chains) amu[,cc,] = tmp2[(1:mpc)+(cc-1)*mpc,]
mmu <- monitor(amu, print = F, warmup = 0)
rownames(mmu) <- c("am", "as", "bm", "bs", "rm", "rs",
                   paste0("p",1:198))

mcmc_re <- data_frame(alpha_m = amu[,,1] %>% as.vector,
             alpha_s = amu[,,2] %>% as.vector,
             beta_m = amu[,,3] %>% as.vector,
             beta_s = amu[,,4] %>% as.vector,
             gamma_m = amu[,,5] %>% as.vector,
             gamma_s = amu[,,6] %>% as.vector
             ) %>%
  mutate(iter = rep(1:1000, 4)) %>%
  mutate(chain = rep(1:4, each = 1000) %>% as.factor)

mcmc_re2 <- mcmc_re %>%
  gather(para, val, 1:6)


```


New parameters look good.

```{r}
mmu %>% round(3) %>% DT::datatable(.)

ggplot(mcmc_re2, aes(x = iter, y = val, col = chain)) +
  geom_line() +
  facet_wrap(~para, nrow = 3)
```


# Main results

## Correlation between LMAp and LMAs at each MCMC step

```{r}
p_est<-NULL

LMAp_mcmc <- list()
LMAs_mcmc <- list()
for (i in 1:198) {
  re_p0 <- c(params1[,paste0("p[",i,"]")],
    params2[,paste0("p[",i,"]")],
    params3[,paste0("p[",i,"]")],
    params4[,paste0("p[",i,"]")])
  p_est[i] <- mean(re_p0)
  LMAp_mcmc[[i]] <- re_p0 * GL$LMA[i]
  LMAs_mcmc[[i]] <- (1 - re_p0) * GL$LMA[i]
}

names(p_est) <- paste0("p",1:198)

LMAps_cor <- NULL
for (i in 1:4000){
  LMAps_cor[i] <- cor(
  sapply(LMAp_mcmc, "[[", i) %>% log,
  sapply(LMAs_mcmc, "[[", i) %>% log)
}

Mu_mcmc <- extract(fit, pars = "Mu")[[1]]

temp_LMAp <- p_est * GL$LMA
temp_LMAs <- GL$LMA - temp_LMAp

GL <- GL %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs)  

d <- read_csv("../data/nature02403-s2.csv", skip = 10)

dd <- data.frame(Narea = 10^d$`log Narea`,
        Parea = 10^d$`log Parea`,
        sp = d$Species) %>%
        group_by(sp) %>%
        summarize(Narea = mean(Narea, na.omit = T),
            Parea = mean(Parea, na.omit = T))

GL <- left_join(GL, dd, by = "sp") %>%
  mutate(gr = factor(DE,
    labels = c("Deciduous",
               "Evergreen",
               "Unclassified"
                      ))) #%>%
  #arrange(desc(gr))


write.csv(GL, "../data/GL_res.csv", row.names = F)

hist(LMAps_cor)

```

## R values

```{r, eval = F, echo = F}

my_cor <- function(LMA = c("LMAp", "LMAs"), trait) {
  cor1 <- NULL
  GL <- as.data.frame(GL)

  if (LMA=="LMAp") {
    for (i in 1:4000){
      cor1[i] <- cor.test(
      sapply(LMAp_mcmc, "[[", i) %>% log,
      log(GL[,paste(trait)]))$estimate
    }
      } else {
      for (i in 1:4000){
        cor1[i] <- cor.test(
        sapply(LMAs_mcmc, "[[", i) %>% log,
        log(GL[,paste(trait)]))$estimate
      }
    }
  #cor1 %>% quantile(., 0.025) %>% round(2) %>% print
  cor1 %>% median %>% round(2)
}



output <- "../GL_r_val.yml"
out <- file(paste(output), "w") # write

writeLines(paste0("r_vals:"),
           out,
           sep = "\n")
writeLines(paste0("  GL:"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_Aarea: 'italic(r) == ", cor.test(log(GL$Aarea), log(GL$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAm_Aarea: 'italic(r) == ",  my_cor(LMA = "LMAp", trait = "Aarea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMAs_Aarea: 'italic(r) == ",  my_cor(LMA = "LMAs", trait = "Aarea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMA_Rarea: 'italic(r) == ", cor.test(log(GL$Rarea), log(GL$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAm_Rarea: 'italic(r) == ",  my_cor(LMA = "LMAp", trait = "Rarea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMAs_Rarea: 'italic(r) == ",  my_cor(LMA = "LMAs", trait = "Rarea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMA_LL: 'italic(r) == ", cor.test(log(GL$LL), log(GL$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAm_LL: 'italic(r) == ",  my_cor(LMA = "LMAp", trait = "LL"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMAs_LL: 'italic(r) == ",  my_cor(LMA = "LMAs", trait = "LL"),"'"),
  out,
  sep = "\n")

writeLines(paste0("  GL_NP:"),
           out,
           sep = "\n")

writeLines(paste0("    LMA_Narea: 'italic(r) == ", cor.test(log(GL$Narea), log(GL$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAm_Narea: 'italic(r) == ",  my_cor(LMA = "LMAp", trait = "Narea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMAs_Narea: 'italic(r) == ",  my_cor(LMA = "LMAs", trait = "Narea"),"'"),
  out,
  sep = "\n")
writeLines(paste0("    LMA_Parea: 'italic(r) == ", cor.test(log(GL$Parea), log(GL$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAm_Parea: 'italic(r) == ",  my_cor(LMA = "LMAp", trait = "Parea"),"'"),
  out,
  sep = "\n")

writeLines(paste0("    LMAs_Parea: 'italic(r) == ",  my_cor(LMA = "LMAs", trait = "Parea"),"'"),
  out,
  sep = "\n")

close(out)

```


```{r}

output <- "../GL_r_val.yml"
out <- file(paste(output), "w") # write

writeLines(paste0("r_vals:"),
           out,
           sep = "\n")
writeLines(paste0("  GL:"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_Aarea: 'italic(r) == ", cor.test(log(GL$Aarea), log(GL$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAp_Aarea: 'italic(r) == ", cor.test(log(GL$Aarea), log(GL$LMAp))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_Aarea: 'italic(r) == ", cor.test(log(GL$Aarea), log(GL$LMAs))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_Rarea: 'italic(r) == ", cor.test(log(GL$Rarea), log(GL$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAp_Rarea: 'italic(r) == ", cor.test(log(GL$Rarea), log(GL$LMAp))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_Rarea: 'italic(r) == ", cor.test(log(GL$Rarea), log(GL$LMAs))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_LL: 'italic(r) == ", cor.test(log(GL$LL), log(GL$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAp_LL: 'italic(r) == ", cor.test(log(GL$LL), log(GL$LMAp))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_LL: 'italic(r) == ", cor.test(log(GL$LL), log(GL$LMAs))$estimate %>% round(2),"'"),
           out,
           sep = "\n")

writeLines(paste0("  GL_NP:"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_Narea: 'italic(r) == ", cor.test(log(GL$Narea), log(GL$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAp_Narea: 'italic(r) == ", cor.test(log(GL$Narea), log(GL$LMAp))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_Narea: 'italic(r) == ", cor.test(log(GL$Narea), log(GL$LMAs))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMA_Parea: 'italic(r) == ", cor.test(log(GL$Parea), log(GL$LMA))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAp_Parea: 'italic(r) == ", cor.test(log(GL$Parea), log(GL$LMAp))$estimate %>% round(2),"'"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_Parea: 'italic(r) == ", cor.test(log(GL$Parea), log(GL$LMAs))$estimate %>% round(2),"'"),
           out,
           sep = "\n")


writeLines(paste0("  GL_LMAms:"),
           out,
           sep = "\n")
writeLines(paste0("    LMAs_LMAm: ", cor.test(log(GL$LMAp), log(GL$LMAs))$estimate %>% round(2)),
           out,
           sep = "\n")
writeLines(paste0("    p_val: ", cor.test(log(GL$LMAp), log(GL$LMAs))$p.value %>% round(2)),
           out,
           sep = "\n")

close(out)
```


## LMAm and LMAs vs A~area~, R~area~, LL

```{r}

setwd("..")
settings <- yaml::yaml.load_file("./settings.yml")
r_vals <- yaml::yaml.load_file("GL_r_val.yml")
p_letters <- yaml::yaml.load_file("letters.yml")
source("fig_theme.r")

GL_dat <- GL %>%
  gather(LMA, Val, c(LMA, LMAs, LMAp)) %>%
  gather(Trait, Val2, c(Aarea, Rarea, LL,
                        Parea, Narea)) %>%
  mutate(DE = factor(DE,
          levels = c("D", "E", "U"))) %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA", "LMAm", "LMAs"))) %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA~(~g~m^{-2})", "LMAm~(~g~m^{-2})", "LMAs~(~g~m^{-2})"))) %>%
  mutate(Trait = factor(Trait,
    levels = c("Aarea", "Rarea", "LL", "Narea", "Parea"))) %>%
  mutate(Trait2 = factor(Trait,
    labels = c("italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "italic(R)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "LL~(months)",
               "italic(N)[area]~(~g~m^{-2})",
               "italic(P)[area]~(~g~m^{-2})")))

# GL all scatterplot ---------------------------------------------------------

GL_dat1 <- GL_dat %>%
  filter(Trait == "LL" |
         Trait == "Aarea" |
         Trait == "Rarea")


lim_GL <- lim_func(GL_dat1,
                   trait = "Val")
lim_GL2 <- lim_func(GL_dat1,
                    trait = "Val2", LMA = FALSE)

lab1 <- data_frame(lab = paste("(", letters[1:9], ")", sep = ""),
                   Val2 = lim_GL2$max_val %>% rep(each = 3),
                  # Val2 = Inf,
                   Val = lim_GL$min_val %>% rep(3),
                   Val_max = lim_GL$max_val %>% rep(3),
                   gr = "Evergreen",
                   r_vals = r_vals$r_vals$GL %>% unlist,
                   Trait2 = rep(lim_GL2$Trait2, each = 3),
                   LMA = rep(lim_GL$LMA, 3)
                   )

fills <- c("Deciduous" = settings$fills$D,
          "Evergreen" = settings$fills$E,
          "Unclassified" = settings$fills$U)

cols <- c("Deciduous" = settings$colors$D,
          "Evergreen" = settings$colors$E,
          "Unclassified" = settings$colors$U)

scatter_plt <- function(data) {
  ggplot(data, aes(x = Val, y = Val2,
                               fill = gr,
                               col = gr)) +
  geom_point(shape = 21) +
  facet_grid(Trait2 ~ LMA,
             scales = "free",
             switch = "both",
             labeller = labeller(Trait2 = label_parsed,
                                 LMA = label_parsed)) +
  geom_text(data = lab1, aes(label = lab),
            hjust = 0.25,
            vjust = 0.25,
            size = 8 * 5/14,
            show.legend = FALSE,
            color = "black") +
  geom_text(data = lab1, aes(label = r_vals, x = Val_max),
            hjust = 1,
            vjust= 0.25,
            size = 8 * 5/14,
            parse = TRUE,
            color = "black",
            show.legend = FALSE) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_x_log10(breaks = my_breaks_x(), expand = c(0.1, 0)) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0)) +
  xlab("") +
  ylab("") +
  theme_LES()
}

GL_plot <- scatter_plt(GL_dat1)

print(GL_plot)

my_ggsave("./figs/GL.png", GL_plot)

```


## LMAm and LMAs vs N~area~, P~area~

```{r}

GL_dat2 <- GL_dat %>%
  filter(Trait == "Narea" |
         Trait == "Parea")

lim_GL <- lim_func(GL_dat2 %>% filter(DE != "Rand"),
                   trait = "Val")
lim_GL2 <- lim_func(GL_dat2 %>% filter(DE != "Rand"),
                    trait = "Val2", LMA = FALSE)

lab1 <- data_frame(lab = paste("(", letters[1:6], ")", sep = ""),
                   Val2 = lim_GL2$max_val %>% rep(each = 3),
                   Val = lim_GL$min_val %>% rep(2),
                   Val_max = lim_GL$max_val %>% rep(2),
                   gr = "Evergreen",
                   r_vals = r_vals$r_vals$GL_NP %>% unlist,
                   Trait2 = rep(lim_GL2$Trait2, each = 3),
                   LMA = rep(lim_GL$LMA, 2)
                   )

GL_NP_plot <- scatter_plt(GL_dat2)

print(GL_NP_plot)

my_ggsave("../figs/GL_NP.png", GL_NP_plot, height = 8.1)


```

## Trait means

```{r}


GL2 <- GL %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs"))

ggplot(GL2, aes(x = gr, y = val,
                                         fill = gr,
                                         col = gr)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols)
```


## Decomposition of LMA variation

1) var(LMAm) & var(LMAs) & 2*cov(LMAm, LMAs), 2)relative contribution: var(LMAm)/(var(LMAm) + var(LMAs)) & var(LMAs) /(var(LMAm) + var(LMAs))

```{r, echo = F}


var_p <- function(data)cov(data$LMA, data$LMAp)
var_s <- function(data)cov(data$LMA, data$LMAs)
var_t <- function(data)var(data$LMA)

var_p <- function(data)var(data$LMAp)
var_s <- function(data)var(data$LMAs)
cov_ps <- function(data)cov(data$LMAp, data$LMAs)
var_t <- function(data)var(data$LMA)

var_dat <- GL %>%
  mutate(site = "GL") %>%
  group_by(site) %>%
  nest %>%
  mutate(var_LMAm = map_dbl(data, var_p)) %>%
  mutate(var_LMAs = map_dbl(data, var_s)) %>%
  mutate(cov_ms = 2 * map_dbl(data, cov_ps)) %>%
  mutate(var_total = map_dbl(data, var_t)) %>%
  dplyr::select(-data)

var_dat_s <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_LMAm + var_LMAs) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_LMAm + var_LMAs) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance))

var_dat_s2 <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_total) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_total) * 100) %>%
  mutate(cov_LMAm_LMAs = cov_ms / (var_total) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance, cov_LMAm_LMAs))

ggplot(var_dat_s2, aes(x = site, y = val, fill = var)) +
  geom_col() +
  ylab("val (%)")

ggplot(var_dat_s, aes(x = site, y = val, fill = var)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format())

```

# Randomized data

```{r}

#load("../data/GL_latent_model_orderd_obs.rda")
load("../data/GL_latent_model_rand.rda")
#load("./data/GL_latent_model_rand.rda")

res <- rand_res$model[[1]]
tmp <- rand_res$data[[1]]

GL <- dat
GL <- GL %>%
  mutate(DE = ifelse(GL$DE == "", "U", as.character(DE))) %>%
  mutate(LMA = tmp$LMA) %>%
  mutate(Aarea = tmp$A) %>%
  mutate(LL = tmp$LL) %>%
  mutate(Rarea = tmp$R)

```

## There are divergent transitions (fatal errors)

```{r}
pairs(res, pars = c("Z[1,1]","Z[1,2]"))
```

## No label problems

Chains are mixed (Rhat almost < 1.1).

```{r}


fit <-res
params <- extract(fit)
m <- 4000
Z_i <- params$Z[,1:3,1:3]

tmp <- data_frame(iter = 1:m,
           alpha_m = Z_i[,2,1],
           alpha_s = Z_i[,3,1]
           ) %>%
  gather(para, val, 2:3)

tmp_text <- data_frame(x = c(0, 1000, 2000, 3000),
                       y = 0.7,
                       lab = c("chain1->", "chain2->", "chain3->", "chain4->"))

ggplot(tmp, aes(x = iter, y = val)) +
  geom_line(aes(col = para)) +
  geom_vline(xintercept = c(0, 1000,2000,3000)) +
  geom_text(data = tmp_text, aes(x = x, y =y , label = lab))

traceplot(res, par = "Z", ncol = 3)

summary_GL <- data.frame(summary(res)$summary)

summary_GL %>%
  round(3) %>%
  DT::datatable(.)

```


add mean LMAm and LMAs

```{r}

mcmc_res <- extract(fit) %>% as.data.frame

p_est <- mcmc_res[,paste0("p.",  1:198)] %>% apply(.,2,mean)

temp_LMAp <- p_est * GL$LMA
temp_LMAs <- GL$LMA - temp_LMAp

GL <- GL %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs)  

GL <- left_join(GL, dd, by = "sp") %>%
  mutate(gr = factor(DE,
    labels = c("Deciduous",
               "Evergreen",
               "Unclassified"
                      ))) %>%
  arrange(desc(gr))

```

## LMA vs A~area~, R~area~, LL

The example figure is based on a single randomized dataset. Basically randomized dataset does not produce any patterns.

```{r}

GL_dat <- GL %>%
  gather(LMA, Val, c(LMA, LMAs, LMAp)) %>%
  gather(Trait, Val2, c(Aarea, Rarea, LL,
                        Parea, Narea)) %>%
  mutate(DE = factor(DE,
          levels = c("D", "E", "U"))) %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA", "LMAm", "LMAs"))) %>%
  mutate(LMA = factor(LMA,
    labels = c("LMA~(~g~m^{-2})", "LMAm~(~g~m^{-2})", "LMAs~(~g~m^{-2})"))) %>%
  mutate(Trait = factor(Trait,
    levels = c("Aarea", "Rarea", "LL", "Narea", "Parea"))) %>%
  mutate(Trait2 = factor(Trait,
    labels = c("italic(A)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "italic(R)[area]~(~mu~mol~m^{-2}~s^{-1})",
               "LL~(months)",
               "italic(N)[area]~(~g~m^{-2})",
               "italic(P)[area]~(~g~m^{-2})")))

# GL all scatterplot ---------------------------------------------------------

GL_dat1 <- GL_dat %>%
  filter(Trait == "LL" |
         Trait == "Aarea" |
         Trait == "Rarea")

lim_GL <- lim_func(GL_dat1,
                   trait = "Val")
lim_GL2 <- lim_func(GL_dat1,
                    trait = "Val2", LMA = FALSE)
lab1 <- data_frame(lab = paste("(", letters[1:9], ")", sep = ""),
                   Val2 = lim_GL2$max_val %>% rep(each = 3),
                  # Val2 = Inf,
                   Val = lim_GL$min_val %>% rep(3),
                   Val_max = lim_GL$max_val %>% rep(3),
                   gr = "Evergreen",
                   r_vals = "",
                   Trait2 = rep(lim_GL2$Trait2, each = 3),
                   LMA = rep(lim_GL$LMA, 3)
                   )

GL_plot <- scatter_plt(GL_dat1)

print(GL_plot)

my_ggsave("../figs/GL_rand.png", GL_plot)
```

# Model code  

```{r}
get_stancode(res) %>% cat
```

# R info

```{r}
sessionInfo()
```
