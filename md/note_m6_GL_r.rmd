---
title: GLOPNET results (randomization)
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

LMAp and LMAs without scaling parameters produced artifact.

- alpha_0 LMAp^alpha_1 * LMAps^alpha_2
- beta_0 LMAs^beta_1 * LMAps^beta_2
- r_0 LMAp^r1 * LMAs^r2 * LMAps^r3



```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      message=FALSE)
```


```{r, echo = F, message = F}
library(loo)
library(rstan)
library(dplyr)
library(scales)
library(memisc)

theme_set(theme_light())
settings <- yaml::yaml.load_file("settings.yml")
```


```{r, echo = F, message = F}

#load("./data/PA_sitePL_LD_L_MVN_obs.rda")
load("./data/GL_m6_rand.rda")
#load("./data/GL_m6_obs.rda")

res <- rand_res$model[[1]]
#summary_PA_LDL <- data.frame(summary(res)$summary)

summary_GL_LDL <- rand_res$summary[[1]]

temp <- rand_dat$data[[1]] 

GL0 <- dat %>%
  as_data_frame %>%
  dplyr::select(sp, DE, GF)

GL <- data_frame(LMA = temp$LMA,
                 Aarea = temp$A,
                 LL = temp$LL,
                 Rarea = temp$R)

GL <- bind_cols(GL0, GL)

#P_vec <- paste("p[", 1:nrow(GL), "]", sep = "")
LMAp_vec <- paste("log_LMAp[", 1:nrow(GL), "]", sep = "")
LMAs_vec <- paste("log_LMAs[", 1:nrow(GL), "]", sep = "")
LMAps_vec <- paste("log_LMAps[", 1:nrow(GL), "]", sep = "")
mu2_vec <- paste("mu2[", 1:nrow(GL), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(GL), ",2]", sep = "")
temp_LMAp <- summary_GL_LDL[LMAp_vec, "mean"] 
temp_LMAs <- summary_GL_LDL[LMAs_vec, "mean"] 
temp_LMAps <- summary_GL_LDL[LMAps_vec, "mean"] 
temp_LL <- exp(summary_GL_LDL[mu2_vec, "mean"])

GL <- GL %>%
  mutate(LMAp = temp_LMAp %>% exp) %>%
  mutate(LMAs = temp_LMAs %>% exp) %>%
  mutate(LMAps = temp_LMAps %>% exp) %>%
  mutate(preLL = temp_LL) 

d <- read_csv("./data/nature02403-s2.csv", skip = 10)

dd <- data.frame(Narea = 10^d$`log Narea`,
        Parea = 10^d$`log Parea`,
        sp = d$Species) %>%
        group_by(sp) %>%
        summarize(Narea = mean(Narea, na.omit = T),
            Parea = mean(Parea, na.omit = T))

GL <- left_join(GL, dd, by = "sp") %>%
  mutate(gr = factor(DE,
    labels = c("Deciduous",
               "Evergreen",
               "Unclassified"
                      ))) %>%
  arrange(desc(gr))

#log_LMAp <- rstan::extract(res, "log_LMAp")[[1]]
#log_LMAs <- rstan::extract(res, "log_LMAs")[[1]]
#as <- rstan::extract(res, "beta[3]")[[1]]
#ap <- rstan::extract(res, "beta[2]")[[1]]
#preLL <- rstan::extract(res, "mu2")[[1]]


#cor.test(log(PA$LMAs), log(PA$Aarea)) %>% print

#cor.test(log(PA$LDs), log(PA$Aarea)) %>% print

```

```{r, echo = F}

var_p <- function(data)cov(data$LMA, data$LMAp)
var_s <- function(data)cov(data$LMA, data$LMAs)
var_t <- function(data)var(data$LMA)

var_p <- function(data)var(data$LMAp)
var_s <- function(data)var(data$LMAs)
cov_ps <- function(data)cov(data$LMAp, data$LMAs)
var_t <- function(data)var(data$LMA)

var_dat <- GL %>%
  mutate(site = "GL") %>%
  group_by(site) %>%
  nest %>%
  mutate(var_LMAm = map_dbl(data, var_p)) %>%
  mutate(var_LMAs = map_dbl(data, var_s)) %>%
  mutate(cov_ms = 2 * map_dbl(data, cov_ps)) %>%
  mutate(var_total = map_dbl(data, var_t)) %>%
  dplyr::select(-data)

var_dat_s <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_LMAm + var_LMAs) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_LMAm + var_LMAs) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance))

var_dat_s2 <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_total) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_total) * 100) %>%
  mutate(cov_LMAm_LMAs = cov_ms / (var_total) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance, cov_LMAm_LMAs)) 


```

```{r, echo = F, eval = T}

waic(extract_log_lik(res,"log_lik"))$waic
loo(extract_log_lik(res,"log_lik"))

cor(log(GL$LMAp), log(GL$Aarea))
cor(log(GL$preLL), log(GL$LL))
cor(log(GL$LMAp), log(GL$Rarea))

cor(log(GL$LMAp), log(GL$Aarea)) * cor(log(GL$preLL), log(GL$LL)) * cor(log(GL$LMAp), log(GL$Rarea))


tail(summary_GL_LDL)
```

# Paramters 

```{r, echo = F, eval = T}

plot(res)

traceplot(res)

```

# Trait correlations

## A~area~, R~area~, LL


Aarea vs LMAp and LL vs LMAs showed artifact. Open symbols indicate sun leaves and closed symbols indicate shade leaves.

```{r, echo = F, message = F}

GL2 <- GL %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs", "LMAps")) %>%
  gather(trait, val2, c("Aarea", "LL", "Rarea")) 

GL3 <- GL %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs", "LMAps")) %>%
  gather(trait2, val3, c("Narea","Parea")) 

fills <- c("Deciduous" = settings$fills$D,
          "Evergreen" = settings$fills$E,
          "Unclassified" = settings$fills$U)

cols <- c("Deciduous" = settings$colors$D,
          "Evergreen" = settings$colors$E,
          "Unclassified" = settings$colors$U)

ggplot(GL2, aes(x = val, y = val2, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

ggplot(GL2, aes(x = val, y = val2, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) 
```

## Observed LL vs predicted LL

Note: Light and site effects were not included in this model.

```{r, echo = F, message = F}

my_breaks <- function(...){
  c(0.002, 0.005, 0.02, 0.05, 0.1, 0.2,  0.5, 1, 2, 5, 10, 20, 50, 100, 200, 500)
}

ggplot(GL, aes(x = LL, y = preLL, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  xlab("obsLL") +
  ylab("preLL") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  geom_abline(aes(slope = 1, intercept = 0), 
              lty = 2, 
              lwd = 0.25, 
              col = "gray20") +
  scale_x_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(GL$LL), max(GL$LL))) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0), 
                limits = c(min(GL$LL), max(GL$LL))) +
  coord_fixed()


cor.test(log(GL$LL), log(GL$preLL))


```

##  N~area~, P~area~

```{r, echo = F, message = F}

ggplot(GL3, aes(x = val, y = val3, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  facet_grid(trait2 ~ LMA, scale = "free") +
  xlab("LMA") +
  ylab("Traits") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

cor.test(log(GL$LMA), log(GL$Narea))

cor.test(log(GL$LMAp), log(GL$Narea))


```

## LMAp vs LMAs

```{r, echo = F, message = F}
ggplot(GL, aes(x = LMAp, y = LMAs, fill = gr, col = gr)) +
  geom_point(shape = 21) +
  xlab("LMAm") +
  ylab("LMAs") +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))
```

## Trait means

The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}

ggplot(GL2, aes(x = gr, y = val,
                                         fill = gr,
                                         col = gr)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = fills) +
  scale_colour_manual(values = cols) 


```


# Decomposition of LMA variation 

1) var(LMAm) & var(LMAs) & 2*cov(LMAm, LMAs), 2)relative contribution: var(LMAm)/(var(LMAm) + var(LMAs)) & var(LMAs) /(var(LMAm) + var(LMAs))

```{r, echo = F}

ggplot(var_dat_s2, aes(x = site, y = val, fill = var)) +
  geom_col() +
  ylab("val (%)") 

ggplot(var_dat_s, aes(x = site, y = val, fill = var)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format())

```

```{r, eval = F}

LMAp <- rlnorm(100, log(40), 0.5)
LMAs <- rlnorm(100, log(40), 0.1)

Aarea <- 1.5 * LMAp^0.2

dat <- data_frame(LMAp, LMAs, Aarea) %>%
  mutate(LMA = LMAp + LMAs)

ggplot(dat, aes(x = LMA, y = Aarea)) +
  geom_point() +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


```

