---
title: Panama results using MVN (Kikuzawa model)
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

Note: Still using a name "LMAp". The model includes leaf density (LMAs/LT) and used N.

- alpha_0 LMAp^alpha_p (LMAs/LT)^alpha_s
- beta_0 {LMA(LMAs/LT)/(qA-R)}^0.5

Those update include:

- y = ax to y = ax^b^
    - Originally we were using y = ax, which is simple but not biologically correct and could produce some degrees of correlations even in randomized dataset.
    - The new model includes scaling parameters and now randomized dataset never produced correlations. We do not have to mention randomized dataset.
- LMAs / LT (= leaf structural density)
    - Leaf density is more relevant to LL compared to LMA, so using (LMAs/LT) is more straightforward. Leaves are now three-dimensional, which is also improvement of Osnas's PNAS.
- Effect of LMAs/LT to photosynthesis
    - The parameters $\alpha_s$ in Eq. 1 is the effect of leaf structural density to gross photosynthesis.
    - Based on effects of cell-wall thickness on mesophyll conductance, we expect $\alpha_s$ < 0; i.e., leaves with higher LMAs and/or higher LD have lower Aarea for a given LMAp.


```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE,
                      message=FALSE)
```


```{r, echo = F, message = F}
library(loo)
library(rstan)
library(dplyr)
library(scales)
library(memisc)

theme_set(theme_light())

```


```{r, echo = F, message = F}

#load("./data/PA_sitePL_LD_L_MVN_obs.rda")
load("./data/PA_m3q_obs.rda")
#summary_PA_LDL <- data.frame(summary(res)$summary)

summary_PA_LDL <- data.frame(summary(res)$summary)

PA <- dat %>%
  as_data_frame %>%
  mutate(site2 = ifelse(site == "PNM", "DRY", "WET")) %>%
  mutate(sp_site_strata = paste(sp, site2, strata, sep = "_")) %>%
  mutate(site_strata = paste(site2, strata, sep = "_"))


P_vec <- paste("p[", 1:nrow(PA), "]", sep = "")
mu2_vec <- paste("mu2[", 1:nrow(PA), "]", sep = "")
#Mu_vec <- paste("mu[", 1:nrow(PA), ",2]", sep = "")
temp_LMAp <- summary_PA_LDL[P_vec, "mean"] * PA$LMA
temp_LMAs <- PA$LMA - temp_LMAp
temp_LL <- exp(summary_PA_LDL[mu2_vec, "mean"])


PA <- PA %>%
  mutate(LMAp = temp_LMAp) %>%
  mutate(LMAs = temp_LMAs) %>%
  mutate(preLL = temp_LL) %>%
  mutate(LDs = LMAs/LT/1000)

log_LMAp <- rstan::extract(res, "log_LMAp")[[1]]
log_LMAs <- rstan::extract(res, "log_LMAs")[[1]]
as <- rstan::extract(res, "beta[3]")[[1]]
bp <- rstan::extract(res, "beta[5]")[[1]]

log_LDs <- 1 * sweep(log_LMAs, 2, log(PA$LT))

tmp <- log_LDs %>% apply(., 2, median) %>% exp

preLL <- rstan::extract(res, "mu2")[[1]]


tmp <- PA %>%
  dplyr::select(sp, site, strata, cell_vol, LD) 

tmp1 <- tmp %>%
  filter(strata == "CAN") %>%
  dplyr::select(sp, cell_vol, LD) %>%
  dplyr::rename(LD_sun = LD) %>%
  dplyr::rename(cell_vol_sun = cell_vol) 

tmp2 <- tmp %>%
  filter(strata == "UNDER") %>%
  dplyr::rename(LD_shade = LD) %>%
  dplyr::rename(cell_vol_shade = cell_vol) 

tmp3 <- full_join(tmp1, tmp2, by = "sp") %>%
  filter(!is.na(site))


#cor.test(log(PA$LMAs), log(PA$Aarea)) %>% print

#cor.test(log(PA$LDs), log(PA$Aarea)) %>% print

```


# Posterior distributions of $\alpha_s$ > 0

$\alpha_s$ indicates the effect of LMAs/LT on Aarea. Positive values suggest leaf with higher density tend to have higher Aarea, which is inconsistent with our prediction. However, liner regression also showed a positive correlation between Aarea and LD (see below).

```{r, echo = F, eval = T}

hist(as, main = "alpha_s")
abline(v =  0, lty = 2)

hist(bp, main = "beta_p")
abline(v =  0, lty = 2)

```

```{r, echo = F, eval = T}
waic(extract_log_lik(res,"log_lik"))$waic
loo(extract_log_lik(res,"log_lik"))

cor(log(PA$LMAp), log(PA$Aarea))
cor(log(PA$preLL), log(PA$LL))
cor(log(PA$LMAp), log(PA$Rarea))

cor(log(PA$LMAp), log(PA$Aarea)) * cor(log(PA$preLL), log(PA$LL)) * cor(log(PA$LMAp), log(PA$Rarea))


tail(summary_PA_LDL)
```

# Paramters 

```{r, echo = F, eval = T}

plot(res)

traceplot(res)

```


```{r, echo = F}

var_p <- function(data)cov(data$LMA, data$LMAp)
var_s <- function(data)cov(data$LMA, data$LMAs)
var_t <- function(data)var(data$LMA)

var_p <- function(data)var(data$LMAp)
var_s <- function(data)var(data$LMAs)
cov_ps <- function(data)cov(data$LMAp, data$LMAs)
var_t <- function(data)var(data$LMA)

var_dat <- PA %>%
  group_by(strata) %>%
  nest %>%
  mutate(var_LMAm = map_dbl(data, var_p)) %>%
  mutate(var_LMAs = map_dbl(data, var_s)) %>%
  mutate(cov_ms = 2 * map_dbl(data, cov_ps)) %>%
  mutate(var_total = map_dbl(data, var_t)) %>%
  dplyr::select(-data)

var_dat_s <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_LMAm + var_LMAs) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_LMAm + var_LMAs) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance))

var_dat_s2 <- var_dat %>%
  mutate(LMAm_variance = var_LMAm / (var_total) * 100) %>%
  mutate(LMAs_variance = var_LMAs / (var_total) * 100) %>%
  mutate(cov_LMAm_LMAs = cov_ms / (var_total) * 100) %>%
  gather(var, val, c(LMAm_variance, LMAs_variance, cov_LMAm_LMAs)) 


```



```{r, echo = F, eval = F}
# R values

#R values are based on posterior distributions of LMAs

par(mfrow = c(1,2))
apply(log_LMAs, 1, function(x)cor(x, log(PA$Aarea))) %>% hist(main = "LMAs vs Aarea, R")
apply(log_LMAs, 1, function(x)cor(x, log(PA$Aarea))^2) %>% hist(main = "LMAs vs Aarea, R2")

apply(log_LMAs, 1, function(x)cor(x, log(PA$Aarea + PA$Rarea))) %>% hist(main = "LMAs vs Aarea + Rarea, R")
apply(log_LMAs, 1, function(x)cor(x, log(PA$Aarea + PA$Rarea))^2) %>% hist(main = "LMAs vs Aarea + Rarea, R2")


apply(log_LDs, 1, function(x)cor(x, log(PA$Aarea))) %>% hist(main = "LMAs/LT vs Aarea, R")
apply(log_LDs, 1, function(x)cor(x, log(PA$Aarea))^2) %>% hist(main = "LMAs/LT vs Aarea, R2")


apply(log_LDs, 1, function(x)cor(x, log(PA$Aarea + PA$Rarea))) %>% hist(main = "LMAs/LT vs Aarea + Rarea, R")
apply(log_LDs, 1, function(x)cor(x, log(PA$Aarea + PA$Rarea))^2) %>% hist(main = "LMAs/LT vs Aarea + Rarea, R2")
```


# Trait correlations

## A~area~, R~area~, LL

Open symbols indicate sun leaves and closed symbols indicate shade leaves. The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}
PA2 <- PA %>%
  gather(LMA, val, c("LMA", "LMAp", "LMAs", "LDs")) %>%
  gather(trait, val2, c("Aarea", "LL", "Rarea")) %>%
  gather(trait2, val3, c("Narea","Parea","cell_area","cell_vol"))


ggplot(PA2, aes(x = val, y = val2, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  facet_grid(trait ~ LMA, scale = "free") +
  xlab("LMA and LD") +
  ylab("Traits") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))




```

## Observed LL vs predicted LL

Note: Light and site effects were not included in this model.

```{r, echo = F, message = F}


my_breaks <- function(...){
  c(0.002, 0.005, 0.02, 0.05, 0.1, 0.2,  0.5, 1, 2, 5, 10, 20, 50, 100, 200, 500)
}


ggplot(PA, aes(x = LL, y = preLL, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  xlab("obsLL") +
  ylab("preLL") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  geom_abline(aes(slope = 1, intercept = 0), 
              lty = 2, 
              lwd = 0.25, 
              col = "gray20") +
  scale_x_log10(breaks = my_breaks(), expand = c(0.1, 0),
                limits = c(min(PA$LL), max(PA$LL))) +
  scale_y_log10(breaks = my_breaks(), expand = c(0.1, 0), 
                limits = c(min(PA$LL), max(PA$LL))) +
  coord_fixed()
cor.test(log(PA$LL), log(PA$preLL))



```


## Cell~area~, Cell~vol~ (= cellulose density), N~area~, P~area~

```{r, echo = F, message = F}
ggplot(PA2, aes(x = val, y = val3, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  facet_grid(trait2 ~ LMA, scale = "free") +
  xlab("LMA and LD") +
  ylab("Traits") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))
```

## LMAp vs LMAs

```{r, echo = F, message = F}
ggplot(PA, aes(x = LMAp, y = LMAs, fill = site2, col = site2, shape = strata)) +
  geom_point() +
  xlab("LMAm") +
  ylab("LMAs") +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_colour_manual(values = c("DRY" = "#8B7355", "WET" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))
```

## Trait means

The results look nice and do not alter main conclusions.

```{r, echo = F, message = F}

ggplot(PA2 %>% filter(LMA != "LDs"), aes(x = site_strata, y = val,
                                         fill = site_strata,
                                         col = site_strata)) +
  geom_boxplot() +
  facet_grid(.~LMA, scale = "free") +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))


ggplot(PA, aes(x = site_strata, y = LDs,
               fill = site_strata,
               col = site_strata)) +
  geom_boxplot() +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))


```


# Decomposition of LMA variation 

1) var(LMAm) & var(LMAs) & 2*cov(LMAm, LMAs), 2)relative contribution: var(LMAm)/(var(LMAm) + var(LMAs)) & var(LMAs) /(var(LMAm) + var(LMAs))

```{r, echo = F}

ggplot(var_dat_s2, aes(x = strata, y = val, fill = var)) +
  geom_col() +
  ylab("val (%)") 


ggplot(var_dat_s, aes(x = strata, y = val, fill = var)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format())

```


```{r, echo = F, message = F, eval = F}

cor.test(log(PA$LMA), log(PA$cell_area))
cor.test(log(PA$LMAs), log(PA$cell_area))

cor.test(log(PA$LD), log(PA$cell_vol))
cor.test(log(PA$LDs), log(PA$cell_vol))


cor.test(log(PA$LMA), log(PA$Narea))
cor.test(log(PA$LMAp), log(PA$Narea))

cor.test(log(PA$LMA), log(PA$Parea))
cor.test(log(PA$LMAp), log(PA$Parea))

apply(log_LMAp, 1, function(x)cor(x, log(PA$Narea))) %>% hist(main = "LMAp vs Narea, R")
apply(log_LMAp, 1, function(x)cor(x, log(PA$Parea))) %>% summary

apply(log_LMAp, 1, function(x)cor(x, log(PA$Narea))) %>% hist(main = "LMAp vs Narea, R")

apply(log_LMAp, 1, function(x)cor(x, log(PA$Rarea))) %>% quantile(0.025)
cor.test(log(PA$LMA), log(PA$Rarea))

apply(log_LMAs, 1, function(x)cor(x, log(PA$cell_area))) %>% hist(main = "LMAp vs Narea, R")

```


```{r, echo = F, message = F, eval = F}

ggplot(tmp3, aes(x = LD_shade, y = LD_sun)) +
  geom_point() +
  facet_grid(~site) +
  geom_abline(slope=1, lty = 2) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  coord_fixed()


ggplot(tmp3, aes(x = cell_vol_shade, y = cell_vol_sun)) +
  geom_point() +
  facet_grid(~site) +
  geom_abline(slope=1, lty = 2) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  coord_fixed()


ggplot(PA, aes(x = site_strata, y = cell_vol,
               fill = site_strata,
               col = site_strata)) +
  geom_boxplot() +
  #geom_violin() +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))

ggplot(PA, aes(x = site_strata, y = LD,
               fill = site_strata,
               col = site_strata)) +
  geom_boxplot() +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))



ggplot(PA, aes(x = site_strata, y = cell_area,
               fill = site_strata,
               col = site_strata)) +
  #geom_violin() +
  geom_boxplot() +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_fill_manual(values = c("DRY_CAN" = "white",
                               "WET_CAN" = "white",
                               "DRY_UNDER" = "#8B7355",
                               "WET_UNDER" = "#1874CD"
                               )) +
  scale_colour_manual(values = c("DRY_CAN" = "#8B7355",
                               "WET_CAN" = "#1874CD",
                               "DRY_UNDER" = "black",
                               "WET_UNDER" = "black"
                               ))


ggplot(PA, aes(x = LD, y = Aarea, fill = site, col = site, shape = strata)) +
  geom_point()  +
  facet_grid(site ~ strata)  +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_colour_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))

ggplot(PA, aes(x = LD, y = Aarea, fill = site, col = site, shape = strata)) +
  geom_point()  +
  facet_grid( ~ strata)  +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_colour_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


ggplot(PA, aes(x = cell_vol, y = Aarea, fill = site, col = site, shape = strata)) +
  geom_point()  +
  facet_grid(site ~ strata)  +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_colour_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


ggplot(PA, aes(x = cell_vol, y = Aarea, fill = site, col = site, shape = strata)) +
  geom_point()  +
  facet_grid( ~ strata)  +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_colour_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


ggplot(PA, aes(x = cell_area, y = Aarea, fill = site, col = site, shape = strata)) +
  geom_point()  +
  facet_grid(site ~ strata)  +
  scale_shape_manual(values = c("CAN" = 1, "UNDER" = 21)) +
  scale_fill_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_colour_manual(values = c("PNM" = "#8B7355", "PNSL" = "#1874CD")) +
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))


 lm(log(Aarea) ~ log(LMAp) + log(LMAs/LT), PA) %>% summary

```
