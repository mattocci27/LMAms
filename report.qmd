---
title: report
author: "Masatoshi Katabuchi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 12pt
format:
  html:
    # fig_caption: yes
    theme: cosmo #readable #sandstone #spacelab #flatly
    # highlight: pygments #tango #kate
    toc: true
    toc-depth: 2
    number-sections: true
    smooth-scroll: true
    # fontsize: medium
    # toc_float:
    #  collapsed: TRUE
    #  smooth_scroll: TRUE
    #  toc: true
---

```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```

```{r}
library(tidyverse)
library(targets)
library(kableExtra)
library(here)
library(jsonlite)
source(here("R", "stan.R"))
```

# MCMC diagnostics

Note: Some models that we didn't used didn't converge very well.

```{r}
tar_read(summary_rhat_gl_summary_lma)
tar_read(summary_rhat_gl_summary_am_bs)
tar_read(summary_rhat_gl_summary_am_bms)
tar_read(summary_rhat_gl_summary_ams_bs)
tar_read(summary_rhat_gl_summary_ams_bms)
tar_read(summary_rhat_pa_summary_lma)
tar_read(summary_rhat_pa_summary_lma_opt)
tar_read(summary_rhat_pa_summary_am_bms)
tar_read(summary_rhat_pa_summary_am_bs)
tar_read(summary_rhat_pa_summary_ams_bms)
tar_read(summary_rhat_pa_summary_ams_bs)
tar_read(summary_rhat_pa_summary_am_bms_opt)
tar_read(summary_rhat_pa_summary_am_bs_opt)
tar_read(summary_rhat_pa_summary_ams_bms_opt)
tar_read(summary_rhat_pa_summary_ams_bs_opt)

tar_read(summary_rhat_pa_summary_am_bms_ld)
tar_read(summary_rhat_pa_summary_am_bs_ld)
tar_read(summary_rhat_pa_summary_ams_bms_ld)
tar_read(summary_rhat_pa_summary_ams_bs_ld)

tar_read(summary_rhat_pa_summary_am_bms_ld_opt)
tar_read(summary_rhat_pa_summary_am_bs_ld_opt)
tar_read(summary_rhat_pa_summary_ams_bms_ld_opt)
tar_read(summary_rhat_pa_summary_ams_bs_ld_opt)

```

```{r}
tar_read(div_check_list_gl_diagnostics_lma)
tar_read(div_check_list_gl_diagnostics_am_bs)
tar_read(div_check_list_gl_diagnostics_am_bms)
tar_read(div_check_list_gl_diagnostics_ams_bs)
tar_read(div_check_list_gl_diagnostics_ams_bms)
tar_read(div_check_list_pa_diagnostics_lma)
tar_read(div_check_list_pa_diagnostics_lma_opt)
tar_read(div_check_list_pa_diagnostics_am_bms)
tar_read(div_check_list_pa_diagnostics_am_bs)
tar_read(div_check_list_pa_diagnostics_ams_bms)
tar_read(div_check_list_pa_diagnostics_ams_bs)
tar_read(div_check_list_pa_diagnostics_am_bms_opt)
tar_read(div_check_list_pa_diagnostics_am_bs_opt)
tar_read(div_check_list_pa_diagnostics_ams_bms_opt)
tar_read(div_check_list_pa_diagnostics_ams_bs_opt)

tar_read(div_check_list_pa_diagnostics_am_bms_ld)
tar_read(div_check_list_pa_diagnostics_am_bs_ld)
tar_read(div_check_list_pa_diagnostics_ams_bms_ld)
tar_read(div_check_list_pa_diagnostics_ams_bs_ld)

tar_read(div_check_list_pa_diagnostics_am_bms_ld_opt)
tar_read(div_check_list_pa_diagnostics_am_bs_ld_opt)
tar_read(div_check_list_pa_diagnostics_ams_bms_ld_opt)
tar_read(div_check_list_pa_diagnostics_ams_bs_ld_opt)
```

```{r, eval=FALSE}
knitr::knit_exit()
```

ams_bs (`model4`) is best for GLOPNET.

```{r}
targets::tar_load(loo_gl)
loo::loo_compare(
   loo_gl[[1]],
   loo_gl[[2]],
   loo_gl[[3]],
   loo_gl[[4]],
   loo_gl[[5]]) |>
  print()

```

am_bs_opt (`model8`) is best for Panama.
am_bs_ld_opt (`model16`) is the second best for Panama.

```{r}
targets::tar_load(loo_pa)
loo::loo_compare(
  loo_pa[[1]],
  loo_pa[[2]],
  loo_pa[[3]],
  loo_pa[[4]],
  loo_pa[[5]],
  loo_pa[[6]],
  loo_pa[[7]],
  loo_pa[[8]],
  loo_pa[[9]],
  loo_pa[[10]],
  loo_pa[[11]],
  loo_pa[[12]],
  loo_pa[[13]],
  loo_pa[[14]],
  loo_pa[[15]],
  loo_pa[[16]],
  loo_pa[[17]],
  loo_pa[[18]]) |>
  print()
```


# Diagnostics for randomized data

There are too many divergent transitions.
None of the randomized datasets did converge.

```{r,eval=FALSE}
targets::tar_read(gl_sim_diagnostics)
targets::tar_read(pa_sim_diagnostics)
targets::tar_read(gl_para_summary)
targets::tar_read(pa_para_summary)
```


![](figs/coef_sim_gl.png)

![](figs/coef_sim_pa.png)


# Computing Environment

```{r}
devtools::session_info()
```


# Pipelines

```{r, fig.width=20, fig.height=20, eval=FALSE}
targets::tar_visnetwork()
```
